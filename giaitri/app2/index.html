<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OPhim Premium - Trải Nghiệm Xem Phim Đỉnh Cao</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#e50914',
                        dark: '#0f0f0f',
                        darker: '#000000',
                        panel: '#1a1a1a'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tối ưu kết nối trước tới server ảnh -->
    <link rel="preconnect" href="https://phimimg.com" crossorigin>
    
    <!-- HLS.js cho m3u8 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* Custom Styles & Scrollbar */
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; color: white; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e50914; }
        
        /* Hide scrollbar for horizontal lists but keep functionality */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .glass-panel { background: rgba(26, 26, 26, 0.9); backdrop-filter: blur(16px); }

        /* Banner Transitions */
        .banner-slide { transition: opacity 0.8s ease-in-out; }
        .banner-active { opacity: 1; z-index: 10; }
        .banner-inactive { opacity: 0; z-index: 0; }

        /* Truncate text */
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Player specific styles */
        .player-container { position: relative; width: 100%; background: #000; aspect-ratio: 16/9; }
        .player-controls { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            transition: opacity 0.3s ease; opacity: 0; padding: 20px 15px 10px;
            pointer-events: none;
        }
        .player-container.show-controls .player-controls { opacity: 1; pointer-events: auto; }
        .player-container.hide-cursor, .player-container.hide-cursor * { cursor: none !important; }
        
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #555; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #e50914; margin-top: -4px; transition: transform 0.1s; }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.3); }
        
        /* Search dropdown animation */
        #search-results { transform-origin: top; transition: all 0.2s ease; }
        .search-highlight { color: #e50914; font-weight: 700; background: rgba(229, 9, 20, 0.1); padding: 0 2px; border-radius: 2px;}
        
        /* Loading spinner */
        .loader { border: 3px solid #333; border-top: 3px solid #e50914; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Carousel scroll snap */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center-item { scroll-snap-align: center; }
        .snap-start-item { scroll-snap-align: start; }

        /* Smooth Image Loading */
        .img-smooth { opacity: 0; transition: opacity 0.5s ease-in-out; }
        .img-smooth.loaded { opacity: 1; }

        /* Player Seek Feedback Animation */
        .seek-feedback { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); border-radius: 50%; width: 70px; height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem; opacity: 0; pointer-events: none; z-index: 30; }
        .seek-feedback i { font-size: 1.5rem; margin-bottom: 2px; }
        .seek-feedback.animate-ping-short { animation: pingShort 0.5s cubic-bezier(0, 0, 0.2, 1); }
        @keyframes pingShort { 0% { transform: translateY(-50%) scale(0.8); opacity: 0.8; } 100% { transform: translateY(-50%) scale(1.5); opacity: 0; } }

        /* Đảm bảo video luôn canh giữa, không bao giờ bị cắt xén khi Fullscreen trên Mobile */
        #player-wrapper:fullscreen { width: 100vw; height: 100vh; background-color: #000; display: flex; align-items: center; justify-content: center; }
        #player-wrapper:fullscreen #player-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #player-wrapper:fullscreen video { object-fit: contain !important; max-height: 100vh; max-width: 100vw; }
        #player-wrapper:-webkit-full-screen { width: 100vw; height: 100vh; background-color: #000; display: flex; align-items: center; justify-content: center; }
        #player-wrapper:-webkit-full-screen video { object-fit: contain !important; }
    </style>
</head>
<body class="bg-dark text-white selection:bg-primary selection:text-white">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 glass border-b border-gray-800 transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo & Menu -->
                <div class="flex items-center gap-8">
                    <a href="#home" class="flex-shrink-0 font-bold text-2xl text-primary tracking-tighter" onclick="app.navigate('home')">
                        <i class="fa-solid fa-play text-xl mr-1"></i>OPhim
                    </a>
                    <div class="hidden md:block">
                        <div class="flex items-baseline space-x-6 text-sm font-medium">
                            <a href="#home" class="hover:text-primary transition-colors text-white">Trang Chủ</a>
                            <a href="#danh-sach/phim-le" class="hover:text-primary transition-colors text-gray-300">Phim Lẻ</a>
                            <a href="#danh-sach/phim-bo" class="hover:text-primary transition-colors text-gray-300">Phim Bộ</a>
                            <a href="#danh-sach/hoat-hinh" class="hover:text-primary transition-colors text-gray-300">Hoạt Hình</a>
                            <a href="#filter" class="hover:text-primary transition-colors text-gray-300"><i class="fa-solid fa-filter mr-1"></i>Lọc Phim</a>
                        </div>
                    </div>
                </div>
                
                <!-- Search & Actions -->
                <div class="flex items-center gap-4">
                    <div class="relative hidden sm:block">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Tìm kiếm phim (Nhấn Enter)..." autocomplete="off" class="bg-darker border border-gray-700 text-sm rounded-full pl-10 pr-4 py-1.5 focus:outline-none focus:border-primary w-64 transition-all focus:w-80 text-white placeholder-gray-500">
                            <i class="fa-solid fa-search absolute left-3.5 top-2 text-gray-500 text-sm"></i>
                        </div>
                        <!-- Search Dropdown -->
                        <div id="searchResults" class="absolute w-full mt-2 glass-panel border border-gray-800 rounded-lg shadow-2xl hidden max-h-[450px] overflow-y-auto z-50 flex flex-col">
                            <div class="p-4 text-center text-sm text-gray-400 hidden" id="searchLoading"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang tìm...</div>
                            <div id="searchList" class="flex flex-col"></div>
                            <div id="searchFooter" class="hidden p-2 border-t border-gray-800 bg-darker/50 sticky bottom-0">
                                <button id="btnSeeAllResults" class="w-full py-2 text-sm text-primary hover:text-white hover:bg-primary transition-colors rounded font-medium text-center">
                                    Xem tất cả kết quả
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile menu button -->
                    <button class="md:hidden text-gray-300 hover:text-white" onclick="document.getElementById('mobileMenu').classList.toggle('hidden')">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden glass-panel border-t border-gray-800">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <div class="p-2 relative">
                    <input type="text" id="searchInputMobile" placeholder="Nhập tên phim & Enter..." autocomplete="off" class="w-full bg-darker border border-gray-700 text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-primary text-white">
                    <!-- Mobile Search Dropdown -->
                    <div id="searchResultsMobile" class="absolute left-2 right-2 mt-1 bg-panel border border-gray-800 rounded-lg shadow-2xl hidden max-h-[300px] overflow-y-auto z-50 flex flex-col">
                        <div id="searchListMobile" class="flex flex-col"></div>
                    </div>
                </div>
                <a href="#home" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-800">Trang Chủ</a>
                <a href="#danh-sach/phim-le" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-800">Phim Lẻ</a>
                <a href="#danh-sach/phim-bo" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-800">Phim Bộ</a>
                <a href="#filter" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-800">Lọc Phim</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-content" class="min-h-screen pb-20">
        <!-- Content gets injected here via JS -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="loader"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-800 bg-darker py-8 mt-10">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">© 2026 OPhim Premium. Demo Web App.</p>
            <p class="text-gray-600 text-xs mt-2">Nguồn dữ liệu từ API OPhim. Thiết kế tối ưu cho mọi thiết bị.</p>
        </div>
    </footer>

    <!-- Templates (Hidden) -->
    
    <!-- TPL Search Results (New) -->
    <template id="tpl-search-page">
        <div class="pt-24 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[70vh]">
            <h1 class="text-2xl md:text-3xl font-bold mb-8 text-white border-l-4 border-primary pl-3">
                Kết quả tìm kiếm cho: <span id="search-keyword-display" class="text-primary font-bold italic"></span>
            </h1>
            
            <div id="search-page-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 gap-y-8">
                <!-- Results injected here -->
            </div>
            
            <div id="search-page-pagination" class="mt-10 flex justify-center gap-2">
                <!-- Pagination -->
            </div>
        </div>
    </template>

    <template id="tpl-home">
        <!-- Hero Banner -->
        <div id="hero-banner" class="relative w-full h-[50vh] md:h-[70vh] bg-darker overflow-hidden">
            <div id="banner-container" class="w-full h-full relative"></div>
            <div class="absolute bottom-6 right-6 flex gap-2 z-20" id="banner-indicators"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-dark via-dark/20 to-transparent z-10 pointer-events-none"></div>
        </div>
        <!-- Sections -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-16 md:-mt-32 relative z-20 space-y-10" id="home-sections"></div>
    </template>

    <template id="tpl-movie-details">
        <div class="pt-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="details-container"></div>
        </div>
    </template>

    <template id="tpl-watch">
        <div class="pt-16 max-w-7xl mx-auto">
            <!-- Player Area -->
            <div class="w-full bg-black shadow-2xl relative group" id="player-wrapper">
                <div class="player-container show-controls" id="player-container">
                    <video id="main-video" class="w-full h-full object-contain cursor-pointer transition-all duration-300"></video>
                    
                    <!-- Hiệu ứng Visual Feedback khi Double Click/Tap -->
                    <div id="seek-left-feedback" class="seek-feedback left-10 md:left-32"><i class="fa-solid fa-backward-step"></i>-10s</div>
                    <div id="seek-right-feedback" class="seek-feedback right-10 md:right-32"><i class="fa-solid fa-forward-step"></i>+10s</div>

                    <div id="player-loading" class="absolute inset-0 flex items-center justify-center bg-black/60 z-10 hidden"><div class="loader"></div></div>
                    <div class="player-controls z-20">
                        <!-- Progress -->
                        <div class="w-full flex items-center group/progress cursor-pointer mb-2 relative h-4" id="progress-container">
                            <div class="absolute h-1 w-full bg-gray-600 rounded-full top-1.5 transition-all group-hover/progress:h-2 group-hover/progress:top-1"></div>
                            <div id="progress-buffer" class="absolute h-1 bg-gray-400 rounded-full top-1.5 transition-all group-hover/progress:h-2 group-hover/progress:top-1 w-0"></div>
                            <div id="progress-bar" class="absolute h-1 bg-primary rounded-full top-1.5 transition-all group-hover/progress:h-2 group-hover/progress:top-1 w-0 relative">
                                <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-primary rounded-full opacity-0 group-hover/progress:opacity-100 transform translate-x-1/2"></div>
                            </div>
                        </div>
                        <!-- Buttons Row -->
                        <div class="flex items-center justify-between text-white">
                            <div class="flex items-center gap-2 sm:gap-4">
                                <button id="btn-seek-backward" class="hover:text-primary transition-colors text-lg w-8 h-8 flex items-center justify-center hidden sm:flex" title="Lùi 10s"><i class="fa-solid fa-rotate-left"></i></button>
                                <button id="btn-play" class="hover:text-primary transition-colors text-xl w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-play"></i></button>
                                <button id="btn-seek-forward" class="hover:text-primary transition-colors text-lg w-8 h-8 flex items-center justify-center hidden sm:flex" title="Tới 10s"><i class="fa-solid fa-rotate-right"></i></button>
                                <button id="btn-next" class="hover:text-primary transition-colors text-lg w-8 h-8 flex items-center justify-center" title="Tập tiếp theo"><i class="fa-solid fa-forward-step"></i></button>
                                <div class="flex items-center gap-2 group/vol relative">
                                    <button id="btn-mute" class="hover:text-primary transition-colors text-lg w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-volume-high"></i></button>
                                    <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1" class="w-0 opacity-0 group-hover/vol:w-20 group-hover/vol:opacity-100 transition-all duration-300 origin-left">
                                </div>
                                <span id="time-display" class="text-xs font-medium font-mono text-gray-300 hidden sm:block">00:00 / 00:00</span>
                            </div>
                            <div class="flex items-center gap-3 sm:gap-4">
                                <div class="relative group/quality">
                                    <button class="hover:text-primary transition-colors text-sm font-bold flex items-center gap-1"><i class="fa-solid fa-gear"></i> <span id="quality-label">Auto</span></button>
                                    <div id="quality-menu" class="absolute bottom-full right-0 mb-2 bg-panel rounded border border-gray-700 p-2 hidden flex-col gap-1 min-w-[80px]"></div>
                                </div>
                                <button id="btn-zoom" class="hover:text-primary transition-colors text-lg w-8 h-8 flex items-center justify-center" title="Đổi kích cỡ Thu/Phóng"><i class="fa-solid fa-expand-arrows-alt"></i></button>
                                <button id="btn-fullscreen" class="hover:text-primary transition-colors text-lg w-8 h-8 flex items-center justify-center" title="Toàn màn hình"><i class="fa-solid fa-expand"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Server Info -->
            <div class="p-4 sm:p-6 lg:p-8 space-y-6 max-w-5xl mx-auto" id="watch-info"></div>
        </div>
    </template>

    <template id="tpl-filter">
        <div class="pt-24 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[70vh]">
            <h1 class="text-3xl font-bold mb-6 text-white border-l-4 border-primary pl-3">Lọc Phim Nâng Cao</h1>
            <div class="glass-panel p-4 rounded-xl border border-gray-800 mb-8 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Loại phim</label>
                    <select id="filter-type" class="w-full bg-darker border border-gray-700 rounded p-2 text-sm focus:border-primary focus:outline-none">
                        <option value="phim-moi-cap-nhat">Mới Cập Nhật</option>
                        <option value="phim-le">Phim Lẻ</option>
                        <option value="phim-bo">Phim Bộ</option>
                        <option value="hoat-hinh">Hoạt Hình</option>
                        <option value="tv-shows">TV Shows</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Thể loại</label>
                    <select id="filter-category" class="w-full bg-darker border border-gray-700 rounded p-2 text-sm focus:border-primary focus:outline-none"><option value="">Tất cả</option></select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Quốc gia</label>
                    <select id="filter-country" class="w-full bg-darker border border-gray-700 rounded p-2 text-sm focus:border-primary focus:outline-none"><option value="">Tất cả</option></select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Năm</label>
                    <select id="filter-year" class="w-full bg-darker border border-gray-700 rounded p-2 text-sm focus:border-primary focus:outline-none"><option value="">Tất cả</option></select>
                </div>
                <div class="col-span-2 md:col-span-4 flex justify-end">
                    <button id="btn-apply-filter" class="bg-primary hover:bg-red-700 text-white px-6 py-2 rounded font-medium transition-colors shadow-lg shadow-primary/30"><i class="fa-solid fa-filter mr-2"></i>Lọc Ngay</button>
                </div>
            </div>
            <div id="filter-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 gap-y-8"></div>
            <div id="filter-pagination" class="mt-10 flex justify-center gap-2"></div>
        </div>
    </template>


    <!-- Application Logic -->
    <script>
        // --- API & Constants ---
        const API_BASE = 'https://ophim1.com';
        let IMG_BASE = 'https://phimimg.com/';
        
        const api = {
            async fetch(endpoint) {
                try {
                    const res = await window.fetch(`${API_BASE}${endpoint}`);
                    if (!res.ok) throw new Error('Network response was not ok');
                    const data = await res.json();
                    if (data.pathImage) IMG_BASE = data.pathImage;
                    return data;
                } catch (error) {
                    console.error("API Error:", error);
                    return null;
                }
            },
            getNewest: (page = 1) => api.fetch(`/danh-sach/phim-moi-cap-nhat?page=${page}`),
            getList: (slug, page = 1) => api.fetch(`/v1/api/danh-sach/${slug}?page=${page}`),
            getMovie: (slug) => api.fetch(`/phim/${slug}`),
            search: (keyword, page = 1) => api.fetch(`/v1/api/tim-kiem?keyword=${encodeURIComponent(keyword)}&page=${page}`),
            getCategoryList: (type, slug, page = 1) => api.fetch(`/v1/api/${type}/${slug}?page=${page}`) 
        };

        // --- Utils ---
        const utils = {
            getImage: (url) => url ? (url.startsWith('http') ? url : `${IMG_BASE}${url}`) : 'https://via.placeholder.com/300x450?text=No+Image',
            formatType: (type) => {
                const types = { 'single': 'Phim Lẻ', 'series': 'Phim Bộ', 'hoathinh': 'Hoạt Hình', 'tvshows': 'TV Show' };
                return types[type] || 'Đang cập nhật';
            },
            formatTime: (seconds) => {
                if (isNaN(seconds)) return "00:00";
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                if (h > 0) return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            },
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => { clearTimeout(timeout); func(...args); };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            // Remove accents for searching/highlighting
            removeAccents: (str) => {
                return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
            },
            // Highlight text ignoring case and accents
            highlightText: (text, keyword) => {
                if (!keyword) return text;
                const normalizedText = utils.removeAccents(text).toLowerCase();
                const normalizedKeyword = utils.removeAccents(keyword).toLowerCase();
                const startIndex = normalizedText.indexOf(normalizedKeyword);
                
                if (startIndex !== -1) {
                    const originalStr = text.substring(startIndex, startIndex + keyword.length);
                    // Dùng RegEx để replace chính xác đoạn text gốc (giữ nguyên in hoa/thường của từ gốc)
                    const regex = new RegExp(`(${originalStr})`, 'i');
                    return text.replace(regex, '<span class="search-highlight">$1</span>');
                }
                return text;
            },
            // Lịch sử tìm kiếm LocalStorage
            saveRecentSearch: (keyword) => {
                if(!keyword.trim()) return;
                let recents = JSON.parse(localStorage.getItem('ophim_recent_searches') || '[]');
                recents = recents.filter(k => k.toLowerCase() !== keyword.toLowerCase()); // Xóa trùng lặp
                recents.unshift(keyword); // Thêm lên đầu
                if(recents.length > 5) recents.pop(); // Giữ tối đa 5
                localStorage.setItem('ophim_recent_searches', JSON.stringify(recents));
            },
            getRecentSearches: () => {
                return JSON.parse(localStorage.getItem('ophim_recent_searches') || '[]');
            },
            removeRecentSearch: (keyword, e) => {
                e.stopPropagation(); // Ngăn click lan lên thẻ a
                let recents = JSON.parse(localStorage.getItem('ophim_recent_searches') || '[]');
                recents = recents.filter(k => k !== keyword);
                localStorage.setItem('ophim_recent_searches', JSON.stringify(recents));
                return recents;
            }
        };

        // --- Hover Preview Manager ---
        const previewManager = {
            hoverTimer: null,
            activeCard: null,
            hls: null,
            
            async startPreview(card, slug) {
                if (this.activeCard && this.activeCard !== card) this.stopPreview();
                this.activeCard = card;
                const container = card.querySelector('.preview-container');
                if(!container) return;

                try {
                    const res = await api.getMovie(slug);
                    if(this.activeCard !== card) return;

                    let videoSrc = null;
                    if(res?.episodes?.[0]?.server_data?.[0]?.link_m3u8) {
                        videoSrc = res.episodes[0].server_data[0].link_m3u8;
                    }

                    if(videoSrc) {
                        container.innerHTML = `<video class="w-full h-full object-cover" muted playsinline></video>`;
                        const video = container.querySelector('video');
                        
                        if(Hls.isSupported()) {
                            this.hls = new Hls({ startPosition: 120, capLevelToPlayerSize: true, autoStartLoad: true }); 
                            this.hls.loadSource(videoSrc);
                            this.hls.attachMedia(video);
                            this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                if(this.activeCard !== card) return;
                                const playPromise = video.play();
                                if(playPromise !== undefined) playPromise.then(() => container.classList.replace('opacity-0', 'opacity-100')).catch(e => {});
                            });
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = videoSrc;
                            video.currentTime = 120;
                            const playPromise = video.play();
                            if(playPromise !== undefined) playPromise.then(() => container.classList.replace('opacity-0', 'opacity-100')).catch(e => {});
                        }
                    } else if (res?.movie?.trailer_url) {
                        const ytId = this.extractYtId(res.movie.trailer_url);
                        if(ytId) {
                            container.innerHTML = `<div class="w-full h-full overflow-hidden"><iframe class="w-full h-full object-cover scale-[1.35] pointer-events-none" src="https://www.youtube.com/embed/${ytId}?autoplay=1&mute=1&controls=0&showinfo=0&rel=0&loop=1&playlist=${ytId}&start=10" frameborder="0" allow="autoplay; encrypted-media"></iframe></div>`;
                            setTimeout(() => { if(this.activeCard === card) container.classList.replace('opacity-0', 'opacity-100'); }, 1500);
                        }
                    }
                } catch (err) {}
            },
            
            stopPreview() {
                if(this.activeCard) {
                    const container = this.activeCard.querySelector('.preview-container');
                    if(container) {
                        container.classList.replace('opacity-100', 'opacity-0');
                        setTimeout(() => { if (this.activeCard !== container.closest('.movie-card')) container.innerHTML = ''; }, 500); 
                    }
                    this.activeCard = null;
                }
                if(this.hls) { this.hls.destroy(); this.hls = null; }
            },
            
            extractYtId(url) {
                const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})/);
                return match ? match[1] : null;
            },
            
            init() {
                document.addEventListener('mouseover', (e) => {
                    const card = e.target.closest('.movie-card');
                    if(card && this.activeCard !== card) {
                        clearTimeout(this.hoverTimer);
                        this.hoverTimer = setTimeout(() => this.startPreview(card, card.dataset.slug), 800);
                    }
                });

                document.addEventListener('mouseout', (e) => {
                    const card = e.target.closest('.movie-card');
                    if(card && !card.contains(e.relatedTarget)) {
                        clearTimeout(this.hoverTimer);
                        if(this.activeCard === card) this.stopPreview();
                    }
                });

                document.addEventListener('touchstart', (e) => {
                    const card = e.target.closest('.movie-card');
                    if(card) {
                        clearTimeout(this.hoverTimer);
                        this.hoverTimer = setTimeout(() => this.startPreview(card, card.dataset.slug), 600);
                    } else {
                        this.stopPreview();
                    }
                }, {passive: true});
                
                document.addEventListener('touchmove', () => { clearTimeout(this.hoverTimer); this.stopPreview(); }, {passive: true});
            }
        };

        // --- App State & Router ---
        const app = {
            state: {
                hls: null, bannerInterval: null, currentMovie: null, currentServerIdx: 0, currentEpisodeIdx: 0,
                filterData: { type: 'phim-moi-cap-nhat', category: '', country: '', year: '', page: 1 },
                searchKeyword: '' // Lưu keyword cho trang search full
            },
            
            init() {
                this.setupSearch();
                this.handleRoute();
                window.addEventListener('hashchange', () => this.handleRoute());
                window.addEventListener('scroll', () => {
                    const nav = document.getElementById('navbar');
                    if (window.scrollY > 20) nav.classList.add('bg-darker/95', 'shadow-md');
                    else nav.classList.remove('bg-darker/95', 'shadow-md');
                });
                previewManager.init();
            },

            async handleRoute() {
                const hash = window.location.hash.slice(1) || 'home';
                const parts = hash.split('/');
                const route = parts[0];
                const slug = parts[1];
                const extra = parts[2];

                this.cleanup();
                const content = document.getElementById('app-content');
                window.scrollTo(0, 0);

                if (route === 'home') {
                    await this.renderHome(content);
                } else if (route === 'phim' && slug) {
                    await this.renderMovieDetails(content, slug);
                } else if (route === 'xem' && slug) {
                    await this.renderWatch(content, slug, extra);
                } else if (route === 'danh-sach' && slug) {
                    this.state.filterData.type = slug; this.state.filterData.page = 1;
                    await this.renderFilter(content);
                } else if (route === 'filter') {
                    await this.renderFilter(content);
                } else if (route === 'tim-kiem' && slug) {
                    await this.renderSearchPage(content, decodeURIComponent(slug), extra || 1); // extra là page
                } else {
                    window.location.hash = 'home';
                }
            },

            cleanup() {
                if (this.state.bannerInterval) clearInterval(this.state.bannerInterval);
                if (this.state.hls) { this.state.hls.destroy(); this.state.hls = null; }
                previewManager.stopPreview();
            },

            navigate(path) { window.location.hash = path; },

            // --- Home View ---
            async renderHome(container) {
                container.innerHTML = document.getElementById('tpl-home').innerHTML;
                const [newestRes, singleRes, seriesRes, cartoonRes] = await Promise.all([
                    api.getNewest(1), api.getList('phim-le', 1), api.getList('phim-bo', 1), api.getList('hoat-hinh', 1)
                ]);

                if (!newestRes || !newestRes.items) {
                    container.innerHTML = '<div class="text-center mt-32 text-red-500">Lỗi kết nối máy chủ API.</div>'; return;
                }

                this.renderBanner(newestRes.items.slice(0, 5));
                const sectionsContainer = document.getElementById('home-sections');
                sectionsContainer.innerHTML = '';
                
                this.renderSliderSection(sectionsContainer, 'Mới Cập Nhật', newestRes.items.slice(5, 20), 'phim-moi-cap-nhat');
                if (singleRes && singleRes.data) this.renderSliderSection(sectionsContainer, 'Phim Lẻ Nổi Bật', singleRes.data.items, 'phim-le');
                if (seriesRes && seriesRes.data) this.renderSliderSection(sectionsContainer, 'Phim Bộ Nóng Hổi', seriesRes.data.items, 'phim-bo');
                if (cartoonRes && cartoonRes.data) this.renderSliderSection(sectionsContainer, 'Thế Giới Hoạt Hình', cartoonRes.data.items, 'hoat-hinh');
            },

            renderBanner(movies) {
                const container = document.getElementById('banner-container');
                const indicators = document.getElementById('banner-indicators');
                container.innerHTML = ''; indicators.innerHTML = '';

                movies.forEach((m, idx) => {
                    const bgImg = utils.getImage(m.thumb_url || m.poster_url);
                    const isFirst = idx === 0;
                    
                    container.innerHTML += `
                        <div class="absolute inset-0 banner-slide ${isFirst ? 'banner-active' : 'banner-inactive'}" id="banner-${idx}">
                            <img src="${bgImg}" alt="${m.name}" loading="${isFirst ? 'eager' : 'lazy'}" decoding="async" onload="this.classList.add('loaded')" class="img-smooth w-full h-full object-cover opacity-60 mix-blend-screen scale-105 transform transition-transform duration-[10000ms] ease-out ${isFirst ? 'scale-100' : ''}" onerror="this.src='https://via.placeholder.com/1200x600?text=No+Image'">
                            <div class="absolute inset-0 bg-gradient-to-r from-darker via-darker/80 to-transparent"></div>
                            <div class="absolute inset-0 flex items-center max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 md:mt-0">
                                <div class="w-full md:w-2/3 lg:w-1/2 space-y-4 md:space-y-6">
                                    <span class="px-3 py-1 bg-primary text-white text-xs font-bold rounded-full animate-pulse inline-block shadow-[0_0_10px_rgba(229,9,20,0.8)]">MỚI NHẤT</span>
                                    <h1 class="text-3xl md:text-5xl lg:text-6xl font-bold leading-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 drop-shadow-lg">${m.name}</h1>
                                    <p class="text-xl md:text-2xl text-gray-300 font-medium">${m.origin_name}</p>
                                    <div class="flex items-center gap-4 text-sm font-medium text-gray-400">
                                        <span class="flex items-center gap-1"><i class="fa-solid fa-calendar-alt text-primary"></i> ${m.year}</span>
                                    </div>
                                    <div class="pt-4 flex gap-4">
                                        <a href="#phim/${m.slug}" class="bg-primary hover:bg-red-700 text-white px-6 md:px-8 py-3 rounded-full font-bold transition-all shadow-lg shadow-primary/30 flex items-center gap-2 hover:scale-105 active:scale-95"><i class="fa-solid fa-circle-info"></i> Chi Tiết</a>
                                        <a href="#xem/${m.slug}" class="bg-white/10 hover:bg-white/20 backdrop-blur-md text-white px-6 md:px-8 py-3 rounded-full font-bold transition-all border border-white/20 flex items-center gap-2 hover:scale-105 active:scale-95"><i class="fa-solid fa-play"></i> Xem Ngay</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    indicators.innerHTML += `<button class="w-8 h-1.5 rounded-full transition-all duration-300 ${isFirst ? 'bg-primary' : 'bg-gray-600 hover:bg-gray-400'}" onclick="app.setBanner(${idx}, ${movies.length})"></button>`;
                });

                let currentIdx = 0;
                this.state.bannerInterval = setInterval(() => {
                    currentIdx = (currentIdx + 1) % movies.length;
                    this.setBanner(currentIdx, movies.length);
                }, 6000);
            },

            setBanner(idx, total) {
                for (let i = 0; i < total; i++) {
                    const slide = document.getElementById(`banner-${i}`);
                    const ind = document.getElementById('banner-indicators').children[i];
                    if (i === idx) {
                        slide.classList.replace('banner-inactive', 'banner-active');
                        const img = slide.querySelector('img');
                        img.classList.remove('scale-105'); void img.offsetWidth; img.classList.add('scale-100');
                        ind.classList.replace('bg-gray-600', 'bg-primary');
                    } else {
                        slide.classList.replace('banner-active', 'banner-inactive');
                        slide.querySelector('img').classList.replace('scale-100', 'scale-105');
                        ind.classList.replace('bg-primary', 'bg-gray-600');
                    }
                }
            },

            // --- Component Reusable cho Grid/Slider ---
            createMovieCard(m) {
                return `
                    <a href="#phim/${m.slug}" class="flex-none w-36 sm:w-44 md:w-48 lg:w-56 group relative snap-start-item cursor-pointer movie-card block" data-slug="${m.slug}">
                        <div class="relative w-full aspect-[2/3] rounded-xl overflow-hidden shadow-lg bg-gray-800">
                            <img src="${utils.getImage(m.thumb_url || m.poster_url)}" alt="${m.name}" loading="lazy" decoding="async" onload="this.classList.add('loaded')" class="img-smooth w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 relative z-10">
                            <div class="preview-container absolute inset-0 z-20 opacity-0 transition-opacity duration-500 bg-black pointer-events-none"></div>
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-30 pointer-events-none">
                                <i class="fa-solid fa-play text-4xl text-primary/80"></i>
                            </div>
                            <div class="absolute top-2 left-2 bg-primary/90 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-md z-30 pointer-events-none">
                                ${m.episode_current || 'HD'}
                            </div>
                        </div>
                        <h3 class="mt-2 text-sm md:text-base font-semibold text-gray-200 group-hover:text-primary transition-colors truncate w-full">${m.name}</h3>
                        <p class="text-xs text-gray-500 truncate">${m.origin_name || m.year}</p>
                    </a>
                `;
            },

            renderSliderSection(container, title, movies, listSlug) {
                if (!movies || movies.length === 0) return;
                const sectionId = `slider-${Math.random().toString(36).substr(2, 9)}`;
                let cardsHtml = movies.map(m => this.createMovieCard(m)).join('');

                container.innerHTML += `
                    <div class="relative group/section">
                        <div class="flex items-center justify-between mb-4 px-1">
                            <h2 class="text-xl md:text-2xl font-bold border-l-4 border-primary pl-3">${title}</h2>
                            <a href="#danh-sach/${listSlug}" class="text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-1 group/link">
                                Xem tất cả <i class="fa-solid fa-chevron-right text-xs group-hover/link:translate-x-1 transition-transform"></i>
                            </a>
                        </div>
                        <button onclick="document.getElementById('${sectionId}').scrollBy({left: -600, behavior: 'smooth'})" class="hidden md:flex absolute left-[-20px] top-[45%] z-10 w-10 h-10 bg-darker/80 text-white rounded-full items-center justify-center shadow-lg border border-gray-700 opacity-0 group-hover/section:opacity-100 transition-opacity hover:bg-primary hover:border-primary backdrop-blur-sm -translate-y-1/2"><i class="fa-solid fa-chevron-left"></i></button>
                        <div id="${sectionId}" class="flex gap-4 overflow-x-auto hide-scrollbar snap-x-mandatory pb-4 pt-1 px-1">${cardsHtml}</div>
                        <button onclick="document.getElementById('${sectionId}').scrollBy({left: 600, behavior: 'smooth'})" class="hidden md:flex absolute right-[-20px] top-[45%] z-10 w-10 h-10 bg-darker/80 text-white rounded-full items-center justify-center shadow-lg border border-gray-700 opacity-0 group-hover/section:opacity-100 transition-opacity hover:bg-primary hover:border-primary backdrop-blur-sm -translate-y-1/2"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                `;
            },

            // ... (Phần renderMovieDetails, renderWatch, renderFilter giữ nguyên) ...
            // [Giữ lại logic renderMovieDetails]
            async renderMovieDetails(container, slug) {
                container.innerHTML = '<div class="flex items-center justify-center min-h-[60vh]"><div class="loader"></div></div>';
                const res = await api.getMovie(slug);
                if (!res || !res.movie) { container.innerHTML = '<div class="text-center mt-32 text-xl">Không tìm thấy phim.</div>'; return; }

                const movie = res.movie;
                const episodes = res.episodes || [];
                const hasEpisodes = episodes.length > 0 && episodes[0].server_data && episodes[0].server_data.length > 0;
                const watchLink = hasEpisodes ? `#xem/${slug}/0-0` : '#';
                const cats = (movie.category || []).map(c => c.name).join(', ');
                const countries = (movie.country || []).map(c => c.name).join(', ');

                container.innerHTML = document.getElementById('tpl-movie-details').innerHTML;
                document.getElementById('details-container').innerHTML = `
                    <div class="relative rounded-2xl overflow-hidden bg-panel border border-gray-800 shadow-2xl mb-10">
                        <div class="absolute inset-0 h-[60vh] opacity-30"><img src="${utils.getImage(movie.poster_url || movie.thumb_url)}" loading="eager" decoding="async" onload="this.classList.add('loaded')" class="img-smooth w-full h-full object-cover filter blur-sm"><div class="absolute inset-0 bg-gradient-to-b from-transparent via-panel/80 to-panel"></div></div>
                        <div class="relative z-10 flex flex-col md:flex-row gap-8 p-6 md:p-10">
                            <div class="w-48 sm:w-64 flex-shrink-0 mx-auto md:mx-0"><img src="${utils.getImage(movie.thumb_url)}" alt="${movie.name}" loading="eager" decoding="async" onload="this.classList.add('loaded')" class="img-smooth w-full rounded-xl shadow-[0_0_30px_rgba(0,0,0,0.8)] border border-gray-700"></div>
                            <div class="flex-1 space-y-4 md:pt-4">
                                <div class="flex flex-wrap items-center gap-2 text-xs font-bold mb-2">
                                    <span class="bg-primary px-2 py-1 rounded text-white shadow-md">${movie.quality || 'HD'}</span>
                                    <span class="bg-blue-600 px-2 py-1 rounded text-white shadow-md">${movie.lang || 'Vietsub'}</span>
                                    ${movie.episode_current ? `<span class="bg-yellow-600 px-2 py-1 rounded text-white shadow-md">${movie.episode_current}</span>` : ''}
                                </div>
                                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white drop-shadow-md">${movie.name}</h1>
                                <h2 class="text-xl text-gray-400 font-medium italic">${movie.origin_name} (${movie.year})</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-300 bg-black/40 p-4 rounded-xl border border-gray-800 backdrop-blur-md">
                                    <p><strong class="text-gray-500 w-24 inline-block">Trạng thái:</strong> ${movie.episode_current || 'Đang cập nhật'}</p>
                                    <p><strong class="text-gray-500 w-24 inline-block">Thể loại:</strong> ${cats}</p>
                                    <p><strong class="text-gray-500 w-24 inline-block">Quốc gia:</strong> ${countries}</p>
                                    <p><strong class="text-gray-500 w-24 inline-block">Thời lượng:</strong> ${movie.time || 'N/A'}</p>
                                    <p class="sm:col-span-2"><strong class="text-gray-500 w-24 inline-block">Đạo diễn:</strong> ${(movie.director || []).join(', ') || 'Đang cập nhật'}</p>
                                    <p class="sm:col-span-2"><strong class="text-gray-500 w-24 inline-block">Diễn viên:</strong> ${(movie.actor || []).join(', ') || 'Đang cập nhật'}</p>
                                </div>
                                <div class="pt-6 flex gap-4">
                                    ${hasEpisodes ? `<a href="${watchLink}" class="bg-primary hover:bg-red-700 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-primary/40 transition-all flex items-center gap-2 hover:scale-105"><i class="fa-solid fa-play"></i> Xem Phim</a>` 
                                    : `<button disabled class="bg-gray-700 text-gray-400 px-8 py-3 rounded-full font-bold cursor-not-allowed flex items-center gap-2"><i class="fa-solid fa-clock"></i> Đang cập nhật</button>`}
                                </div>
                            </div>
                        </div>
                        <div class="relative z-10 px-6 md:px-10 pb-10">
                            <h3 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Nội Dung Phim</h3>
                            <div class="text-gray-300 leading-relaxed text-sm md:text-base opacity-90 content-formatted" id="movie-content">${movie.content || 'Đang cập nhật nội dung...'}</div>
                        </div>
                    </div>
                `;
            },

            // [Giữ lại logic renderWatch vắn tắt]
            async renderWatch(container, slug, idxParam) {
                container.innerHTML = document.getElementById('tpl-watch').innerHTML;
                const res = await api.getMovie(slug);
                if (!res || !res.movie) { container.innerHTML = '<div class="text-center mt-32 text-xl">Lỗi tải dữ liệu.</div>'; return; }
                this.state.currentMovie = res;
                const episodes = res.episodes || [];
                if (episodes.length === 0 || episodes[0].server_data.length === 0) {
                    container.querySelector('#player-wrapper').innerHTML = '<div class="flex items-center justify-center h-full text-xl text-gray-400">Chưa có link xem phim.</div>'; return;
                }
                let sIdx = 0, eIdx = 0;
                if (idxParam) { const parts = idxParam.split('-'); if (parts.length === 2) { sIdx = parseInt(parts[0]) || 0; eIdx = parseInt(parts[1]) || 0; } }
                if (sIdx >= episodes.length) sIdx = 0;
                if (eIdx >= episodes[sIdx].server_data.length) eIdx = 0;
                this.state.currentServerIdx = sIdx; this.state.currentEpisodeIdx = eIdx;
                
                this.renderWatchInfo(); this.initPlayer();
            },
            renderWatchInfo() { /* Code render watch info như cũ, bỏ qua chi tiết để focus vào search */
                const infoContainer = document.getElementById('watch-info');
                const movie = this.state.currentMovie.movie;
                const episodes = this.state.currentMovie.episodes;
                const currentEpData = episodes[this.state.currentServerIdx].server_data[this.state.currentEpisodeIdx];

                let serversHtml = episodes.map((srv, idx) => `<button class="px-4 py-2 rounded text-sm font-medium transition-colors ${idx === this.state.currentServerIdx ? 'bg-primary text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}" onclick="app.changeServer(${idx})">${srv.server_name}</button>`).join('');
                let epsHtml = episodes[this.state.currentServerIdx].server_data.map((ep, idx) => `<a href="#xem/${movie.slug}/${this.state.currentServerIdx}-${idx}" class="w-12 h-10 flex items-center justify-center rounded text-sm font-medium transition-all ${idx === this.state.currentEpisodeIdx ? 'bg-primary text-white shadow-md scale-110 z-10' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}">${ep.name}</a>`).join('');

                infoContainer.innerHTML = `
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">${movie.name}</h1>
                        <h2 class="text-lg text-gray-400 mb-4">${movie.origin_name} - Tập ${currentEpData.name}</h2>
                        <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-800 pb-4"><a href="#phim/${movie.slug}" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i class="fa-solid fa-info-circle"></i> Info</a></div>
                    </div>
                    <div class="bg-panel rounded-xl p-4 md:p-6 border border-gray-800"><div class="flex gap-3 mb-8">${serversHtml}</div><div class="flex flex-wrap gap-2 max-h-60 overflow-y-auto">${epsHtml}</div></div>
                `;
            },
            changeServer(idx) { window.location.hash = `xem/${this.state.currentMovie.movie.slug}/${idx}-${this.state.currentEpisodeIdx}`; },
            playNextEpisode() {
                const sIdx = this.state.currentServerIdx; const eIdx = this.state.currentEpisodeIdx;
                const eps = this.state.currentMovie.episodes[sIdx].server_data;
                if (eIdx + 1 < eps.length) window.location.hash = `xem/${this.state.currentMovie.movie.slug}/${sIdx}-${eIdx + 1}`;
            },
            initPlayer() {
                const video = document.getElementById('main-video'); const loading = document.getElementById('player-loading');
                const videoSrc = this.state.currentMovie.episodes[this.state.currentServerIdx].server_data[this.state.currentEpisodeIdx].link_m3u8;
                if (this.state.hls) this.state.hls.destroy();
                loading.classList.remove('hidden');
                if (Hls.isSupported()) {
                    this.state.hls = new Hls({capLevelToPlayerSize: true}); this.state.hls.loadSource(videoSrc); this.state.hls.attachMedia(video);
                    this.state.hls.on(Hls.Events.MANIFEST_PARSED, () => { loading.classList.add('hidden'); video.play().catch(()=>{}); });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = videoSrc; video.addEventListener('loadedmetadata', () => { loading.classList.add('hidden'); video.play().catch(()=>{}); }); }
                this.attachPlayerEvents(video, document.getElementById('player-wrapper'));
            },
            attachPlayerEvents(video, wrapper) { 
                const bp = document.getElementById('btn-play'); 
                const btnFullscreen = document.getElementById('btn-fullscreen');
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                // --- Logic Tự động Fullscreen & Xoay ngang (Mobile Android) ---
                const enterFullscreenAndLandscape = () => {
                    if (!document.fullscreenElement) {
                        const req = wrapper.requestFullscreen || wrapper.webkitRequestFullscreen || wrapper.msRequestFullscreen;
                        if (req) {
                            req.call(wrapper).then(() => {
                                // Mở thành công -> Khóa màn hình ngang
                                if (isMobile && screen.orientation && screen.orientation.lock) {
                                    screen.orientation.lock('landscape').catch(e => console.warn("Lỗi xoay ngang:", e));
                                }
                            }).catch(e => console.warn(e));
                        }
                    }
                };

                const toggleFullscreen = () => {
                    if (!document.fullscreenElement) {
                        enterFullscreenAndLandscape();
                    } else {
                        const exit = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
                        if (exit) exit.call(document);
                    }
                };

                // Lắng nghe sự kiện đổi Fullscreen để đổi Icon và mở khóa xoay (nếu bấm nút Back trên điện thoại)
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) {
                        btnFullscreen.innerHTML = '<i class="fa-solid fa-expand"></i>';
                        if (isMobile && screen.orientation && screen.orientation.unlock) {
                            screen.orientation.unlock(); // Trả lại xoay tự do
                        }
                    } else {
                        btnFullscreen.innerHTML = '<i class="fa-solid fa-compress"></i>';
                    }
                });

                const togglePlay = () => {
                    if (video.paused) {
                        video.play();
                        // Kích hoạt auto-fullscreen & ngang khi có tương tác Play trên điện thoại
                        if (isMobile) enterFullscreenAndLandscape();
                    } else {
                        video.pause();
                    }
                };
                
                bp.onclick = togglePlay;
                
                video.onplay = () => bp.innerHTML = '<i class="fa-solid fa-pause"></i>'; 
                video.onpause = () => bp.innerHTML = '<i class="fa-solid fa-play"></i>';
                
                document.getElementById('btn-next').onclick = () => this.playNextEpisode();
                
                // Logic Xả tới/lui (Seek)
                const btnSeekBack = document.getElementById('btn-seek-backward');
                const btnSeekFwd = document.getElementById('btn-seek-forward');
                const fbLeft = document.getElementById('seek-left-feedback');
                const fbRight = document.getElementById('seek-right-feedback');

                const showFeedback = (dir) => {
                    const el = dir === 'left' ? fbLeft : fbRight;
                    el.classList.remove('animate-ping-short');
                    void el.offsetWidth; // Trigger reflow để chạy lại animation
                    el.classList.add('animate-ping-short');
                };

                const handleSeek = (amount) => {
                    if(!video.duration) return;
                    video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + amount));
                    showFeedback(amount > 0 ? 'right' : 'left');
                };

                if(btnSeekBack) btnSeekBack.onclick = () => handleSeek(-10);
                if(btnSeekFwd) btnSeekFwd.onclick = () => handleSeek(10);

                // Logic Double Click / Double Tap
                let lastTap = 0;
                const handleDoubleClickTap = (e) => {
                    e.preventDefault();
                    const rect = video.getBoundingClientRect();
                    const clientX = e.type.includes('touch') ? e.changedTouches[0].clientX : e.clientX;
                    const xPos = clientX - rect.left;
                    if (xPos < rect.width / 2) handleSeek(-10); // Nửa trái
                    else handleSeek(10); // Nửa phải
                };

                // Tránh xung đột 1 click (play/pause) và 2 click (seek) trên PC
                let clickTimer = null;
                video.onclick = (e) => {
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                            togglePlay(); // Click đơn
                        }, 250); // Đợi 250ms xem có click tiếp không
                    } else {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        handleDoubleClickTap(e); // Click đúp
                    }
                };

                video.addEventListener('touchstart', (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    if (tapLength < 300 && tapLength > 0) {
                        handleDoubleClickTap(e);
                    }
                    lastTap = currentTime;
                }, {passive: false});

                // Logic Phóng to/Thu nhỏ (Zoom)
                const btnZoom = document.getElementById('btn-zoom');
                let isZoomed = false;
                if(btnZoom) {
                    btnZoom.onclick = () => {
                        isZoomed = !isZoomed;
                        if(isZoomed) {
                            video.classList.replace('object-contain', 'object-cover');
                            btnZoom.innerHTML = '<i class="fa-solid fa-compress-arrows-alt"></i>';
                        } else {
                            video.classList.replace('object-cover', 'object-contain');
                            btnZoom.innerHTML = '<i class="fa-solid fa-expand-arrows-alt"></i>';
                        }
                    };
                }

                // Volume & fullscreen thủ công
                const volumeSlider = document.getElementById('volume-slider');
                const btnMute = document.getElementById('btn-mute');
                const updateVolIcon = () => {
                    if (video.muted || video.volume === 0) btnMute.innerHTML = '<i class="fa-solid fa-volume-xmark text-red-500"></i>';
                    else if (video.volume < 0.5) btnMute.innerHTML = '<i class="fa-solid fa-volume-low"></i>';
                    else btnMute.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                };
                btnMute.onclick = () => { video.muted = !video.muted; volumeSlider.value = video.muted ? 0 : video.volume; updateVolIcon(); };
                volumeSlider.addEventListener('input', (e) => { video.volume = e.target.value; video.muted = video.volume == 0; updateVolIcon(); });

                btnFullscreen.onclick = toggleFullscreen;

                // Progress update
                const progressBar = document.getElementById('progress-bar');
                const timeDisplay = document.getElementById('time-display');
                const progressContainer = document.getElementById('progress-container');
                const progressBuffer = document.getElementById('progress-buffer');
                
                video.addEventListener('timeupdate', () => {
                    if (!video.duration) return;
                    progressBar.style.width = `${(video.currentTime / video.duration) * 100}%`;
                    timeDisplay.innerText = `${utils.formatTime(video.currentTime)} / ${utils.formatTime(video.duration)}`;
                });
                video.addEventListener('progress', () => {
                    if (video.buffered.length > 0 && video.duration > 0) {
                        progressBuffer.style.width = `${(video.buffered.end(video.buffered.length - 1) / video.duration) * 100}%`;
                    }
                });
                progressContainer.addEventListener('click', (e) => {
                    const rect = progressContainer.getBoundingClientRect();
                    video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration;
                });
                
                // Auto hide controls
                const container = document.getElementById('player-container');
                const controlsEl = container.querySelector('.player-controls');
                let timeout;
                let isHoveringControls = false;

                controlsEl.addEventListener('mouseenter', () => { isHoveringControls = true; resetControls(); });
                controlsEl.addEventListener('mouseleave', () => { isHoveringControls = false; resetControls(); });

                const resetControls = () => {
                    container.classList.add('show-controls');
                    container.classList.remove('hide-cursor');
                    clearTimeout(timeout);
                    // Chỉ tự động ẩn khi video đang chạy VÀ chuột không nằm trên thanh điều khiển
                    if (!video.paused && !isHoveringControls) {
                        timeout = setTimeout(() => {
                            container.classList.remove('show-controls');
                            container.classList.add('hide-cursor');
                        }, 2500); // Ẩn sau 2.5s không thao tác
                    }
                };
                
                container.addEventListener('mousemove', resetControls);
                container.addEventListener('touchstart', resetControls, {passive: true});
                video.addEventListener('play', resetControls);
                video.addEventListener('pause', resetControls);
            },

            // [Giữ lại logic renderFilter]
            async renderFilter(container) { /* Giữ nguyên filter cũ */
                container.innerHTML = document.getElementById('tpl-filter').innerHTML;
                this.loadFilterResults();
            },
            async loadFilterResults() {
                const resultsContainer = document.getElementById('filter-results');
                resultsContainer.innerHTML = '<div class="col-span-full flex justify-center py-10"><div class="loader"></div></div>';
                const { type, page } = this.state.filterData;
                let data = await api.getList(type, page);
                if (!data || !data.data || !data.data.items) return resultsContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Không tìm thấy phim phù hợp.</div>';
                resultsContainer.innerHTML = data.data.items.map(m => this.createMovieCard(m)).join('');
            },

            // ==========================================
            // TÍNH NĂNG TÌM KIẾM ĐƯỢC NÂNG CẤP DƯỚI ĐÂY
            // ==========================================

            // Trang Kết Quả Tìm Kiếm Full (Mới)
            async renderSearchPage(container, keyword, page = 1) {
                container.innerHTML = document.getElementById('tpl-search-page').innerHTML;
                document.getElementById('search-keyword-display').innerText = keyword;
                this.state.searchKeyword = keyword; // Lưu lại để dùng cho pagination
                
                const resultsContainer = document.getElementById('search-page-results');
                const pagination = document.getElementById('search-page-pagination');
                resultsContainer.innerHTML = '<div class="col-span-full flex justify-center py-20"><div class="loader"></div></div>';
                
                try {
                    const res = await api.search(keyword, page);
                    if (!res || !res.data || !res.data.items || res.data.items.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-500">
                                <i class="fa-solid fa-magnifying-glass text-6xl mb-4 text-gray-700"></i>
                                <p class="text-xl">Rất tiếc, không tìm thấy phim nào khớp với "${keyword}".</p>
                                <button onclick="app.navigate('home')" class="mt-4 px-6 py-2 bg-primary text-white rounded hover:bg-red-700">Về Trang Chủ</button>
                            </div>
                        `;
                        return;
                    }

                    // Sử dụng hàm createMovieCard có sẵn (hỗ trợ preview trailer)
                    // Đối với API search Ophim, items trả về có thể khác cấu trúc 1 chút (thường ko có origin_name, dùng name)
                    resultsContainer.innerHTML = res.data.items.map(m => this.createMovieCard(m)).join('');

                    // Render Pagination
                    const pageData = res.data.params?.pagination;
                    if (pageData) {
                        const currentPage = parseInt(pageData.current_page || page);
                        const totalPages = Math.ceil((pageData.totalItems) / (pageData.totalItemsPerPage || 24)) || 1;
                        
                        if (currentPage > 1) {
                            pagination.innerHTML += `<button class="px-4 py-2 bg-gray-800 hover:bg-primary rounded text-sm transition-colors font-medium" onclick="app.changeSearchPage(${currentPage - 1})"><i class="fa-solid fa-chevron-left mr-1"></i> Trang trước</button>`;
                        }
                        pagination.innerHTML += `<span class="px-4 py-2 bg-primary text-white rounded text-sm font-bold shadow-lg">${currentPage} / ${totalPages}</span>`;
                        if (currentPage < totalPages) {
                            pagination.innerHTML += `<button class="px-4 py-2 bg-gray-800 hover:bg-primary rounded text-sm transition-colors font-medium" onclick="app.changeSearchPage(${currentPage + 1})">Trang sau <i class="fa-solid fa-chevron-right ml-1"></i></button>`;
                        }
                    }
                } catch (e) {
                    resultsContainer.innerHTML = '<div class="col-span-full text-center text-red-500 py-10">Lỗi kết nối máy chủ. Vui lòng thử lại.</div>';
                }
            },

            changeSearchPage(page) {
                window.location.hash = `tim-kiem/${encodeURIComponent(this.state.searchKeyword)}/${page}`;
            },

            // Setup Thanh Tìm Kiếm Động
            setupSearch() {
                const inputs = [
                    { el: document.getElementById('searchInput'), list: document.getElementById('searchList'), box: document.getElementById('searchResults') },
                    { el: document.getElementById('searchInputMobile'), list: document.getElementById('searchListMobile'), box: document.getElementById('searchResultsMobile') }
                ];
                const loader = document.getElementById('searchLoading');
                const btnSeeAll = document.getElementById('btnSeeAllResults');
                const footerSeeAll = document.getElementById('searchFooter');

                // Hàm hiển thị Lịch sử tìm kiếm
                const renderRecentSearches = (listEl, boxEl) => {
                    const recents = utils.getRecentSearches();
                    if(recents.length === 0) return;
                    
                    listEl.innerHTML = `
                        <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider flex justify-between items-center bg-darker/80">
                            Tìm kiếm gần đây
                        </div>
                        ${recents.map(k => `
                            <div class="flex items-center justify-between p-3 hover:bg-gray-800 transition-colors border-b border-gray-800 cursor-pointer group" onclick="document.getElementById('searchInput').value='${k}'; document.getElementById('searchInputMobile').value='${k}'; app.triggerSearch('${k}')">
                                <div class="flex items-center gap-3 text-gray-300 group-hover:text-white">
                                    <i class="fa-solid fa-clock-rotate-left text-gray-500 group-hover:text-primary"></i>
                                    <span class="text-sm font-medium">${k}</span>
                                </div>
                                <button class="text-gray-600 hover:text-red-500 p-1" onclick="app.removeRecent(event, '${k}')"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        `).join('')}
                    `;
                    boxEl.classList.remove('hidden');
                    footerSeeAll.classList.add('hidden');
                };

                // Hàm thực thi tìm kiếm (Gọi API)
                const performSearch = async (kw, targetInput) => {
                    if (!kw.trim()) {
                        renderRecentSearches(targetInput.list, targetInput.box);
                        return;
                    }
                    
                    targetInput.box.classList.remove('hidden');
                    targetInput.list.innerHTML = '';
                    if(targetInput.el.id === 'searchInput') loader.classList.remove('hidden'); // Chỉ hiện loader ở bản PC
                    footerSeeAll.classList.add('hidden');

                    const res = await api.search(kw);
                    if(targetInput.el.id === 'searchInput') loader.classList.add('hidden');

                    if (!res || !res.data || !res.data.items || res.data.items.length === 0) {
                        targetInput.list.innerHTML = `
                            <div class="p-6 flex flex-col items-center justify-center text-gray-500">
                                <i class="fa-regular fa-face-frown text-3xl mb-2"></i>
                                <span class="text-sm">Không tìm thấy kết quả</span>
                            </div>`;
                        return;
                    }

                    // Render danh sách kết quả (tối đa 6 cái cho dropdown đỡ dài)
                    targetInput.list.innerHTML = res.data.items.slice(0, 6).map(m => `
                        <a href="#phim/${m.slug}" class="flex items-start gap-3 p-3 hover:bg-gray-800 transition-colors border-b border-gray-800 last:border-0 group" 
                           onclick="utils.saveRecentSearch('${kw}'); document.getElementById('searchResults').classList.add('hidden'); document.getElementById('searchResultsMobile').classList.add('hidden'); document.getElementById('mobileMenu').classList.add('hidden')">
                            <div class="w-12 h-16 rounded overflow-hidden flex-shrink-0 relative">
                                <img src="${utils.getImage(m.thumb_url)}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><i class="fa-solid fa-play text-white text-xs"></i></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-bold text-gray-200 truncate group-hover:text-primary transition-colors">${utils.highlightText(m.name, kw)}</h4>
                                <p class="text-xs text-gray-500 truncate mt-0.5">${m.origin_name || ''}</p>
                                <div class="flex items-center gap-1.5 mt-1">
                                    <span class="text-[10px] bg-primary/20 text-primary px-1.5 py-0.5 rounded font-bold">${m.episode_current || 'HD'}</span>
                                    <span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 py-0.5 rounded">${m.year || 'N/A'}</span>
                                    ${m.quality ? `<span class="text-[10px] border border-gray-700 text-gray-400 px-1 py-0.5 rounded">${m.quality}</span>` : ''}
                                </div>
                            </div>
                        </a>
                    `).join('');

                    // Nếu có nhiều hơn 6 kết quả, hiện nút "Xem tất cả"
                    if(res.data.items.length > 6 && targetInput.el.id === 'searchInput') {
                        footerSeeAll.classList.remove('hidden');
                        btnSeeAll.onclick = () => {
                            utils.saveRecentSearch(kw);
                            app.navigate(`tim-kiem/${encodeURIComponent(kw)}`);
                            targetInput.box.classList.add('hidden');
                        };
                    }
                };

                // Bắt sự kiện Gõ phím (Debounce 500ms)
                inputs.forEach(target => {
                    const debouncedSearch = utils.debounce((e) => performSearch(e.target.value, target), 500);
                    
                    target.el.addEventListener('input', debouncedSearch);
                    
                    // Sự kiện Focus (Click vào input)
                    target.el.addEventListener('focus', () => { 
                        if(target.el.value.trim()) {
                            target.box.classList.remove('hidden');
                        } else {
                            renderRecentSearches(target.list, target.box);
                        }
                    });

                    // Sự kiện nhấn Enter
                    target.el.addEventListener('keypress', (e) => {
                        if(e.key === 'Enter') {
                            const kw = target.el.value.trim();
                            if(kw) {
                                utils.saveRecentSearch(kw);
                                app.navigate(`tim-kiem/${encodeURIComponent(kw)}`);
                                target.box.classList.add('hidden');
                                document.getElementById('mobileMenu').classList.add('hidden'); // Ẩn menu mobile nếu đang mở
                                target.el.blur(); // Tắt bàn phím mobile
                            }
                        }
                    });
                });

                // Đóng dropdown khi click ra ngoài
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#searchResults') && !e.target.closest('#searchInput') && 
                        !e.target.closest('#searchResultsMobile') && !e.target.closest('#searchInputMobile')) {
                        inputs.forEach(t => t.box.classList.add('hidden'));
                    }
                });

                // Gắn hàm public cho các onclick
                this.triggerSearch = (kw) => {
                    inputs[0].el.value = kw;
                    inputs[1].el.value = kw;
                    app.navigate(`tim-kiem/${encodeURIComponent(kw)}`);
                    inputs.forEach(t => t.box.classList.add('hidden'));
                    document.getElementById('mobileMenu').classList.add('hidden');
                };

                this.removeRecent = (e, kw) => {
                    utils.removeRecentSearch(kw, e);
                    const activeInput = window.innerWidth < 768 ? inputs[1] : inputs[0];
                    renderRecentSearches(activeInput.list, activeInput.box);
                };
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
