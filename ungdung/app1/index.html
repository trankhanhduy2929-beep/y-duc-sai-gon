<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siêu VLOOKUP Online</title>
    
    <!-- 1. Tailwind CSS (Giao diện) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. SheetJS (Xử lý Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- 3. FontAwesome (Icon thay cho Lucide) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Animation nhẹ */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-custom { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <!-- PHẦN 1: MÀN HÌNH ĐĂNG NHẬP -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center space-y-6">
            <div class="inline-flex items-center justify-center p-4 bg-indigo-100 text-indigo-600 rounded-full mb-2">
                <i class="fa-solid fa-lock text-2xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-slate-800">Đăng nhập</h2>
                <p class="text-slate-500 text-sm mt-2">Nhập mật khẩu để truy cập.</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="password" id="password-input" 
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                        placeholder="Nhập mật khẩu..." autofocus>
                    <p id="auth-error" class="text-red-500 text-xs mt-2 text-left hidden-custom">
                        <i class="fa-solid fa-circle-exclamation mr-1"></i> Mật khẩu không đúng!
                    </p>
                </div>
                <button type="submit" 
                    class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-95">
                    Mở Khóa
                </button>
            </form>
            <div class="text-xs text-slate-400">Gợi ý: xxx</div>
        </div>
    </div>

    <!-- PHẦN 2: ỨNG DỤNG CHÍNH (Mặc định ẩn) -->
    <div id="app-screen" class="min-h-screen p-4 md:p-8 hidden-custom fade-in">
        <div class="max-w-6xl mx-auto space-y-8">
            
            <!-- Header -->
            <div class="text-center space-y-2 relative">
                <button onclick="logout()" class="absolute top-0 right-0 text-sm text-slate-400 hover:text-red-500 flex items-center space-x-1">
                    <i class="fa-solid fa-lock"></i> <span>Khóa lại</span>
                </button>

                <div class="inline-flex items-center justify-center p-3 bg-green-600 text-white rounded-2xl shadow-lg mb-2">
                    <i class="fa-solid fa-table text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900">Siêu VLOOKUP Online</h1>
                <p class="text-slate-500 max-w-2xl mx-auto">
                    Công cụ dò tìm dữ liệu Excel thông minh, an toàn và nhanh chóng.
                </p>
            </div>

            <!-- Upload Zone -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Source Card -->
                <div id="card-source" class="bg-white p-6 rounded-xl shadow-sm border-2 border-dashed border-slate-300 transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-2 text-green-700 font-semibold">
                            <i class="fa-solid fa-database"></i>
                            <span>1. File Nguồn (Bảng Dò)</span>
                        </div>
                        <i id="check-source" class="fa-solid fa-circle-check text-green-500 text-xl hidden-custom"></i>
                    </div>
                    
                    <div id="upload-source-ui">
                        <label class="flex flex-col items-center justify-center h-40 cursor-pointer hover:bg-slate-50 rounded-lg transition-colors">
                            <i class="fa-solid fa-upload text-3xl text-slate-400 mb-2"></i>
                            <span class="text-sm text-slate-500">Chọn file Excel (.xlsx, .csv)</span>
                            <input type="file" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(this, 'source')">
                        </label>
                    </div>
                    <div id="info-source-ui" class="hidden-custom space-y-4">
                        <div id="name-source" class="p-3 bg-green-50 rounded-lg text-sm text-green-800 font-medium truncate"></div>
                        <div class="text-xs text-slate-500 flex justify-between">
                            <span id="rows-source"></span>
                            <span id="cols-source"></span>
                        </div>
                        <button onclick="resetFile('source')" class="text-xs text-red-500 hover:underline">Xóa & Chọn lại</button>
                    </div>
                </div>

                <!-- Target Card -->
                <div id="card-target" class="bg-white p-6 rounded-xl shadow-sm border-2 border-dashed border-slate-300 transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-2 text-blue-700 font-semibold">
                            <i class="fa-solid fa-file-excel"></i>
                            <span>2. File Đích (Cần điền)</span>
                        </div>
                        <i id="check-target" class="fa-solid fa-circle-check text-blue-500 text-xl hidden-custom"></i>
                    </div>

                    <div id="upload-target-ui">
                        <label class="flex flex-col items-center justify-center h-40 cursor-pointer hover:bg-slate-50 rounded-lg transition-colors">
                            <i class="fa-solid fa-upload text-3xl text-slate-400 mb-2"></i>
                            <span class="text-sm text-slate-500">Chọn file Excel (.xlsx, .csv)</span>
                            <input type="file" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(this, 'target')">
                        </label>
                    </div>
                    <div id="info-target-ui" class="hidden-custom space-y-4">
                        <div id="name-target" class="p-3 bg-blue-50 rounded-lg text-sm text-blue-800 font-medium truncate"></div>
                        <div class="text-xs text-slate-500 flex justify-between">
                            <span id="rows-target"></span>
                            <span id="cols-target"></span>
                        </div>
                        <button onclick="resetFile('target')" class="text-xs text-red-500 hover:underline">Xóa & Chọn lại</button>
                    </div>
                </div>
            </div>

            <!-- Configuration Zone -->
            <div id="config-zone" class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden hidden-custom">
                <div class="bg-slate-100 px-6 py-4 border-b border-slate-200 flex items-center space-x-2">
                    <i class="fa-solid fa-gear text-slate-600"></i>
                    <h2 class="font-semibold text-slate-700">3. Cấu hình Dò tìm</h2>
                </div>
                
                <div class="p-6 grid gap-8 md:grid-cols-3">
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-slate-700">Cột Khóa ở File Nguồn</label>
                        <select id="sel-source-key" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"></select>
                    </div>

                    <div class="flex items-center justify-center md:pt-6">
                        <div class="p-2 bg-slate-100 rounded-full">
                            <i class="fa-solid fa-arrow-right text-slate-400"></i>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-slate-700">Cột Khóa ở File Đích</label>
                        <select id="sel-target-key" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    </div>

                    <div class="md:col-span-3 border-t border-slate-100 my-2"></div>

                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-slate-700">Dữ liệu cần lấy</label>
                        <select id="sel-return-col" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                    </div>

                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-slate-700">Tên cột mới</label>
                        <input type="text" id="new-col-name" placeholder="Mặc định: VLOOKUP_..." class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">Tùy chọn</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="chk-ignore-case" checked class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm text-slate-600">Không phân biệt hoa/thường</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="chk-trim" checked class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm text-slate-600">Xóa khoảng trắng thừa</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end">
                    <button id="btn-process" onclick="processData()" class="flex items-center space-x-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition-all">
                        <i class="fa-solid fa-bolt"></i>
                        <span>Thực hiện VLOOKUP</span>
                    </button>
                </div>
            </div>

            <!-- Result Zone -->
            <div id="result-zone" class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden hidden-custom fade-in">
                <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-circle-check text-indigo-600"></i>
                        <h2 class="font-bold text-indigo-900">Kết quả (<span id="result-count">0</span> dòng)</h2>
                    </div>
                    <button onclick="downloadExcel()" class="flex items-center space-x-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-sm transition-colors">
                        <i class="fa-solid fa-download"></i>
                        <span>Tải xuống Excel</span>
                    </button>
                </div>
                
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left border-collapse" id="result-table">
                        <!-- Table content injected via JS -->
                    </table>
                </div>
                <div class="p-3 text-center text-xs text-slate-500 bg-slate-50 border-t border-slate-200">
                    Hiển thị 50 dòng đầu tiên. Tải xuống để xem đầy đủ.
                </div>
            </div>
            
            <div class="flex justify-center">
                 <button onclick="window.location.reload()" class="text-sm text-slate-400 hover:text-slate-600 underline">
                   Làm mới toàn bộ (Reset)
                 </button>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STATE ---
        let sourceData = [];
        let targetData = [];
        let processedData = [];
        const PASSWORD = "1402";

        // --- AUTH LOGIC ---
        const loginForm = document.getElementById('login-form');
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const authError = document.getElementById('auth-error');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('password-input').value;
            if (input === PASSWORD) {
                loginScreen.classList.add('hidden-custom');
                appScreen.classList.remove('hidden-custom');
            } else {
                authError.classList.remove('hidden-custom');
                document.getElementById('password-input').value = '';
            }
        });

        function logout() {
            location.reload();
        }

        // --- EXCEL PROCESSING LOGIC ---
        
        function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });

                if (type === 'source') {
                    sourceData = jsonData;
                    updateUICard('source', file.name, jsonData);
                } else {
                    targetData = jsonData;
                    updateUICard('target', file.name, jsonData);
                }
                checkConfigReady();
            };
            reader.readAsArrayBuffer(file);
        }

        function updateUICard(type, name, data) {
            // UI Elements
            const uploadUI = document.getElementById(`upload-${type}-ui`);
            const infoUI = document.getElementById(`info-${type}-ui`);
            const card = document.getElementById(`card-${type}`);
            const check = document.getElementById(`check-${type}`);
            
            // Text info
            document.getElementById(`name-${type}`).innerText = name;
            document.getElementById(`rows-${type}`).innerText = `${data.length} dòng`;
            
            const cols = data.length > 0 ? Object.keys(data[0]) : [];
            document.getElementById(`cols-${type}`).innerText = `${cols.length} cột`;

            // Toggle views
            uploadUI.classList.add('hidden-custom');
            infoUI.classList.remove('hidden-custom');
            check.classList.remove('hidden-custom');
            
            // Style card
            if(type === 'source') {
                card.classList.remove('border-dashed', 'border-slate-300');
                card.classList.add('border-green-500', 'ring-2', 'ring-green-100');
            } else {
                card.classList.remove('border-dashed', 'border-slate-300');
                card.classList.add('border-blue-500', 'ring-2', 'ring-blue-100');
            }

            // Populate Selects
            updateSelectOptions(type, cols);
        }

        function updateSelectOptions(type, cols) {
            let options = `<option value="">-- Chọn cột --</option>`;
            cols.forEach(col => {
                options += `<option value="${col}">${col}</option>`;
            });

            if (type === 'source') {
                document.getElementById('sel-source-key').innerHTML = options;
                document.getElementById('sel-return-col').innerHTML = options;
            } else {
                document.getElementById('sel-target-key').innerHTML = options;
            }
        }

        function resetFile(type) {
            if(type === 'source') {
                sourceData = [];
                document.getElementById('sel-source-key').innerHTML = '';
                document.getElementById('sel-return-col').innerHTML = '';
            } else {
                targetData = [];
                document.getElementById('sel-target-key').innerHTML = '';
            }
            
            // Reset UI
            document.getElementById(`upload-${type}-ui`).classList.remove('hidden-custom');
            document.getElementById(`info-${type}-ui`).classList.add('hidden-custom');
            document.getElementById(`check-${type}`).classList.add('hidden-custom');
            
            const card = document.getElementById(`card-${type}`);
            card.classList.add('border-dashed', 'border-slate-300');
            card.classList.remove('border-green-500', 'ring-2', 'ring-green-100', 'border-blue-500', 'ring-blue-100');

            document.getElementById('config-zone').classList.add('hidden-custom');
            document.getElementById('result-zone').classList.add('hidden-custom');
        }

        function checkConfigReady() {
            if (sourceData.length > 0 && targetData.length > 0) {
                document.getElementById('config-zone').classList.remove('hidden-custom');
            }
        }

        function cleanKey(val) {
            if (val === null || val === undefined) return "";
            let str = String(val);
            if (document.getElementById('chk-trim').checked) str = str.trim();
            if (document.getElementById('chk-ignore-case').checked) str = str.toLowerCase();
            return str;
        }

        function processData() {
            const sKey = document.getElementById('sel-source-key').value;
            const tKey = document.getElementById('sel-target-key').value;
            const retCol = document.getElementById('sel-return-col').value;
            let newName = document.getElementById('new-col-name').value;

            if (!sKey || !tKey || !retCol) {
                alert("Vui lòng chọn đầy đủ các cột!");
                return;
            }
            
            if (!newName) newName = `VLOOKUP_${retCol}`;

            // Logic VLOOKUP
            const lookupMap = new Map();
            sourceData.forEach(row => {
                lookupMap.set(cleanKey(row[sKey]), row[retCol]);
            });

            processedData = targetData.map(row => {
                const key = cleanKey(row[tKey]);
                const found = lookupMap.has(key) ? lookupMap.get(key) : "#N/A";
                return { ...row, [newName]: found };
            });

            renderResultTable(processedData, newName);
        }

        function renderResultTable(data, highlightCol) {
            const table = document.getElementById('result-table');
            const cols = Object.keys(data[0]);
            
            // Header
            let html = '<thead class="bg-slate-50 sticky top-0 shadow-sm z-10"><tr>';
            cols.forEach(col => {
                const isHighlight = col === highlightCol;
                html += `<th class="p-3 text-sm font-semibold text-slate-600 border-b border-slate-200 whitespace-nowrap ${isHighlight ? 'bg-yellow-50 text-yellow-800' : ''}">${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Body (Limit 50)
            data.slice(0, 50).forEach(row => {
                html += '<tr class="hover:bg-slate-50 border-b border-slate-100">';
                cols.forEach(col => {
                    const isHighlight = col === highlightCol;
                    html += `<td class="p-3 text-sm text-slate-700 whitespace-nowrap ${isHighlight ? 'bg-yellow-50/50 font-medium text-slate-900' : ''}">${row[col] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';

            table.innerHTML = html;
            document.getElementById('result-count').innerText = data.length;
            document.getElementById('result-zone').classList.remove('hidden-custom');
        }

        function downloadExcel() {
            if (processedData.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQua");
            XLSX.writeFile(wb, "Vlookup_Result.xlsx");
        }
    </script>
</body>
</html>
