import React, { useState, useEffect, useMemo } from 'react';
import { Upload, FileSpreadsheet, ArrowRight, Download, Settings, Database, Table as TableIcon, CheckCircle, AlertCircle, RefreshCw } from 'lucide-react';

// Link CDN cho thư viện SheetJS (XLSX)
const XLSX_CDN = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";

export default function App() {
  const [libLoaded, setLibLoaded] = useState(false);
  
  // State cho dữ liệu
  const [sourceData, setSourceData] = useState([]); // File chứa dữ liệu gốc (Lookup Table)
  const [targetData, setTargetData] = useState([]); // File cần điền dữ liệu (Target Table)
  const [sourceFileName, setSourceFileName] = useState("");
  const [targetFileName, setTargetFileName] = useState("");
  
  // State cho cấu hình cột
  const [sourceKey, setSourceKey] = useState(""); // Cột khóa ở file gốc
  const [targetKey, setTargetKey] = useState(""); // Cột khóa ở file đích
  const [returnColumn, setReturnColumn] = useState(""); // Cột muốn lấy dữ liệu
  const [newColumnName, setNewColumnName] = useState(""); // Tên cột mới
  
  // Tùy chọn nâng cao
  const [ignoreCase, setIgnoreCase] = useState(true);
  const [trimSpaces, setTrimSpaces] = useState(true);
  
  // Kết quả
  const [processedData, setProcessedData] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);

  // Load thư viện XLSX
  useEffect(() => {
    if (window.XLSX) {
      setLibLoaded(true);
      return;
    }
    const script = document.createElement('script');
    script.src = XLSX_CDN;
    script.onload = () => setLibLoaded(true);
    document.body.appendChild(script);
  }, []);

  // Hàm đọc file Excel
  const handleFileUpload = (e, type) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const bstr = evt.target.result;
      const wb = window.XLSX.read(bstr, { type: 'binary' });
      const wsname = wb.SheetNames[0];
      const ws = wb.Sheets[wsname];
      // Chuyển sang JSON nhưng giữ nguyên header
      const data = window.XLSX.utils.sheet_to_json(ws, { defval: "" });
      
      if (type === 'source') {
        setSourceData(data);
        setSourceFileName(file.name);
        // Reset selections
        setSourceKey("");
        setReturnColumn("");
      } else {
        setTargetData(data);
        setTargetFileName(file.name);
        setTargetKey("");
      }
    };
    reader.readAsBinaryString(file);
  };

  // Lấy danh sách cột từ dữ liệu
  const getColumns = (data) => {
    if (!data || data.length === 0) return [];
    return Object.keys(data[0]);
  };

  // Hàm xử lý chuỗi để so sánh thông minh
  const cleanKey = (val) => {
    if (val === null || val === undefined) return "";
    let str = String(val);
    if (trimSpaces) str = str.trim();
    if (ignoreCase) str = str.toLowerCase();
    return str;
  };

  // Xử lý VLOOKUP
  const handleProcess = () => {
    if (!sourceKey || !targetKey || !returnColumn) return;
    setIsProcessing(true);

    setTimeout(() => {
      // 1. Tạo Map từ Source Data để tra cứu nhanh (O(1))
      const lookupMap = new Map();
      sourceData.forEach(row => {
        const key = cleanKey(row[sourceKey]);
        // Nếu key trùng, dòng sau đè dòng trước (giống VLOOKUP mặc định)
        // Chỉ lưu giá trị cần lấy
        lookupMap.set(key, row[returnColumn]);
      });

      // 2. Duyệt qua Target Data và điền dữ liệu
      const result = targetData.map(row => {
        const key = cleanKey(row[targetKey]);
        const foundValue = lookupMap.has(key) ? lookupMap.get(key) : "#N/A";
        
        return {
          ...row,
          [newColumnName || `VLOOKUP_${returnColumn}`]: foundValue
        };
      });

      setProcessedData(result);
      setIsProcessing(false);
    }, 500); // Fake delay cho UX
  };

  // Xuất file Excel
  const handleDownload = () => {
    if (!processedData) return;
    const ws = window.XLSX.utils.json_to_sheet(processedData);
    const wb = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(wb, ws, "KetQua");
    window.XLSX.writeFile(wb, "Vlookup_Result.xlsx");
  };

  const resetAll = () => {
    setSourceData([]);
    setTargetData([]);
    setProcessedData(null);
    setSourceFileName("");
    setTargetFileName("");
    setSourceKey("");
    setTargetKey("");
    setReturnColumn("");
    setNewColumnName("");
  };

  if (!libLoaded) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-600">
        <RefreshCw className="animate-spin w-8 h-8 mr-2" />
        Đang tải thư viện xử lý Excel...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* Header */}
        <div className="text-center space-y-2">
          <div className="inline-flex items-center justify-center p-3 bg-green-600 text-white rounded-2xl shadow-lg mb-2">
            <TableIcon className="w-8 h-8" />
          </div>
          <h1 className="text-3xl font-bold text-slate-900">Siêu VLOOKUP Online</h1>
          <p className="text-slate-500 max-w-2xl mx-auto">
            Công cụ dò tìm dữ liệu giữa 2 file Excel nhanh chóng. 
            Không cần công thức, tự động xử lý lỗi khoảng trắng và chữ hoa thường.
          </p>
        </div>

        {/* Step 1: Upload Files */}
        <div className="grid md:grid-cols-2 gap-6">
          {/* Source Card */}
          <div className={`bg-white p-6 rounded-xl shadow-sm border-2 transition-all ${sourceData.length > 0 ? 'border-green-500 ring-2 ring-green-100' : 'border-dashed border-slate-300'}`}>
            <div className="flex justify-between items-start mb-4">
              <div className="flex items-center space-x-2 text-green-700 font-semibold">
                <Database className="w-5 h-5" />
                <span>1. File Nguồn (Bảng Dò)</span>
              </div>
              {sourceData.length > 0 && <CheckCircle className="w-5 h-5 text-green-500" />}
            </div>
            
            {sourceData.length === 0 ? (
              <label className="flex flex-col items-center justify-center h-40 cursor-pointer hover:bg-slate-50 rounded-lg transition-colors">
                <Upload className="w-10 h-10 text-slate-400 mb-2" />
                <span className="text-sm text-slate-500">Click để chọn file Excel (.xlsx, .csv)</span>
                <input type="file" className="hidden" accept=".xlsx, .xls, .csv" onChange={(e) => handleFileUpload(e, 'source')} />
              </label>
            ) : (
              <div className="space-y-4">
                <div className="p-3 bg-green-50 rounded-lg text-sm text-green-800 font-medium truncate">
                  {sourceFileName}
                </div>
                <div className="text-xs text-slate-500 flex justify-between">
                  <span>{sourceData.length} dòng</span>
                  <span>{getColumns(sourceData).length} cột</span>
                </div>
                <button 
                  onClick={() => {setSourceData([]); setProcessedData(null);}} 
                  className="text-xs text-red-500 hover:underline"
                >
                  Xóa & Chọn lại
                </button>
              </div>
            )}
          </div>

          {/* Target Card */}
          <div className={`bg-white p-6 rounded-xl shadow-sm border-2 transition-all ${targetData.length > 0 ? 'border-blue-500 ring-2 ring-blue-100' : 'border-dashed border-slate-300'}`}>
            <div className="flex justify-between items-start mb-4">
              <div className="flex items-center space-x-2 text-blue-700 font-semibold">
                <FileSpreadsheet className="w-5 h-5" />
                <span>2. File Đích (Cần điền)</span>
              </div>
              {targetData.length > 0 && <CheckCircle className="w-5 h-5 text-blue-500" />}
            </div>

            {targetData.length === 0 ? (
              <label className="flex flex-col items-center justify-center h-40 cursor-pointer hover:bg-slate-50 rounded-lg transition-colors">
                <Upload className="w-10 h-10 text-slate-400 mb-2" />
                <span className="text-sm text-slate-500">Click để chọn file Excel (.xlsx, .csv)</span>
                <input type="file" className="hidden" accept=".xlsx, .xls, .csv" onChange={(e) => handleFileUpload(e, 'target')} />
              </label>
            ) : (
              <div className="space-y-4">
                <div className="p-3 bg-blue-50 rounded-lg text-sm text-blue-800 font-medium truncate">
                  {targetFileName}
                </div>
                <div className="text-xs text-slate-500 flex justify-between">
                  <span>{targetData.length} dòng</span>
                  <span>{getColumns(targetData).length} cột</span>
                </div>
                <button 
                  onClick={() => {setTargetData([]); setProcessedData(null);}} 
                  className="text-xs text-red-500 hover:underline"
                >
                  Xóa & Chọn lại
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Step 2: Configuration */}
        {sourceData.length > 0 && targetData.length > 0 && (
          <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div className="bg-slate-100 px-6 py-4 border-b border-slate-200 flex items-center space-x-2">
              <Settings className="w-5 h-5 text-slate-600" />
              <h2 className="font-semibold text-slate-700">3. Cấu hình Dò tìm (Mapping)</h2>
            </div>
            
            <div className="p-6 grid gap-8 md:grid-cols-3">
              {/* Mapping Logic */}
              <div className="space-y-4">
                <label className="block text-sm font-medium text-slate-700">Cột Khóa ở File Gốc (Tìm cái gì?)</label>
                <select 
                  className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                  value={sourceKey}
                  onChange={(e) => setSourceKey(e.target.value)}
                >
                  <option value="">-- Chọn cột mã (ID) --</option>
                  {getColumns(sourceData).map(col => <option key={col} value={col}>{col}</option>)}
                </select>
                <p className="text-xs text-slate-500">Ví dụ: Mã nhân viên, Mã SP...</p>
              </div>

              <div className="flex items-center justify-center md:pt-6">
                <div className="p-2 bg-slate-100 rounded-full">
                  <ArrowRight className="w-6 h-6 text-slate-400" />
                </div>
              </div>

              <div className="space-y-4">
                <label className="block text-sm font-medium text-slate-700">Cột Khóa ở File Đích (So với cái gì?)</label>
                <select 
                  className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                  value={targetKey}
                  onChange={(e) => setTargetKey(e.target.value)}
                >
                  <option value="">-- Chọn cột mã (ID) --</option>
                  {getColumns(targetData).map(col => <option key={col} value={col}>{col}</option>)}
                </select>
                <p className="text-xs text-slate-500">Cột này phải chứa giá trị tương ứng với file gốc.</p>
              </div>

              <div className="md:col-span-3 border-t border-slate-100 my-2"></div>

              <div className="space-y-4">
                <label className="block text-sm font-medium text-slate-700">Cột Dữ liệu cần lấy (Kết quả trả về)</label>
                <select 
                  className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                  value={returnColumn}
                  onChange={(e) => setReturnColumn(e.target.value)}
                >
                  <option value="">-- Chọn dữ liệu cần lấy --</option>
                  {getColumns(sourceData).map(col => <option key={col} value={col}>{col}</option>)}
                </select>
              </div>

              <div className="space-y-4">
                <label className="block text-sm font-medium text-slate-700">Tên cột mới (Tùy chọn)</label>
                <input 
                  type="text" 
                  placeholder={`Mặc định: VLOOKUP_${returnColumn || '...'}`}
                  className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                  value={newColumnName}
                  onChange={(e) => setNewColumnName(e.target.value)}
                />
              </div>

              <div className="space-y-3">
                <label className="block text-sm font-medium text-slate-700">Tùy chọn thông minh</label>
                <div className="space-y-2">
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      checked={ignoreCase} 
                      onChange={(e) => setIgnoreCase(e.target.checked)}
                      className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" 
                    />
                    <span className="text-sm text-slate-600">Không phân biệt hoa/thường (A = a)</span>
                  </label>
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      checked={trimSpaces} 
                      onChange={(e) => setTrimSpaces(e.target.checked)}
                      className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" 
                    />
                    <span className="text-sm text-slate-600">Xóa khoảng trắng thừa (" A " = "A")</span>
                  </label>
                </div>
              </div>
            </div>

            <div className="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end">
              <button 
                onClick={handleProcess}
                disabled={!sourceKey || !targetKey || !returnColumn || isProcessing}
                className={`flex items-center space-x-2 px-6 py-3 rounded-lg font-bold text-white shadow-md transition-all
                  ${!sourceKey || !targetKey || !returnColumn 
                    ? 'bg-slate-300 cursor-not-allowed' 
                    : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg active:transform active:scale-95'}`}
              >
                {isProcessing ? (
                  <>
                    <RefreshCw className="w-5 h-5 animate-spin" />
                    <span>Đang xử lý...</span>
                  </>
                ) : (
                  <>
                    <ArrowRight className="w-5 h-5" />
                    <span>Thực hiện VLOOKUP</span>
                  </>
                )}
              </button>
            </div>
          </div>
        )}

        {/* Step 3: Results Preview */}
        {processedData && (
          <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden animate-fade-in-up">
             <div className="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center">
              <div className="flex items-center space-x-2">
                <CheckCircle className="w-6 h-6 text-indigo-600" />
                <h2 className="font-bold text-indigo-900">Kết quả ({processedData.length} dòng)</h2>
              </div>
              <button 
                onClick={handleDownload}
                className="flex items-center space-x-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-sm transition-colors"
              >
                <Download className="w-4 h-4" />
                <span>Tải xuống Excel</span>
              </button>
            </div>
            
            <div className="overflow-x-auto max-h-96">
              <table className="w-full text-left border-collapse">
                <thead className="bg-slate-50 sticky top-0 shadow-sm z-10">
                  <tr>
                    {getColumns(processedData).map((col, idx) => (
                      <th key={idx} className={`p-3 text-sm font-semibold text-slate-600 border-b border-slate-200 whitespace-nowrap ${col === (newColumnName || `VLOOKUP_${returnColumn}`) ? 'bg-yellow-50 text-yellow-800' : ''}`}>
                        {col}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {processedData.slice(0, 50).map((row, rIdx) => (
                    <tr key={rIdx} className="hover:bg-slate-50 border-b border-slate-100">
                      {getColumns(processedData).map((col, cIdx) => (
                        <td key={cIdx} className={`p-3 text-sm text-slate-700 whitespace-nowrap ${col === (newColumnName || `VLOOKUP_${returnColumn}`) ? 'bg-yellow-50/50 font-medium text-slate-900' : ''}`}>
                          {row[col]}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {processedData.length > 50 && (
              <div className="p-3 text-center text-xs text-slate-500 bg-slate-50 border-t border-slate-200">
                Hiển thị 50/{processedData.length} dòng. Tải xuống để xem đầy đủ.
              </div>
            )}
          </div>
        )}
        
        <div className="flex justify-center">
             <button onClick={resetAll} className="text-sm text-slate-400 hover:text-slate-600 underline">
               Làm mới toàn bộ (Reset)
             </button>
        </div>

      </div>
    </div>
  );
}
