<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Calculator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Poppins:wght@300;400;600&display=swap');

        :root {
            --bg-color: #e0e5ec;
            --text-main: #4a5568;
            --text-secondary: #a0aec0;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --key-bg: #e0e5ec;
            --accent-color: #ff9f43; /* Cam Hermes */
            --operator-color: #54a0ff;
            --modal-bg: rgba(224, 229, 236, 0.95);
        }

        .dark-mode {
            --bg-color: #2d3436;
            --text-main: #dfe6e9;
            --text-secondary: #636e72;
            --shadow-light: #3d4649;
            --shadow-dark: #1e2324;
            --key-bg: #2d3436;
            --accent-color: #fab1a0;
            --operator-color: #74b9ff;
            --modal-bg: rgba(45, 52, 54, 0.95);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Neomorphism Effect */
        .neumorph {
            background: var(--bg-color);
            box-shadow: 9px 9px 16px var(--shadow-dark), 
                       -9px -9px 16px var(--shadow-light);
            border-radius: 20px;
        }

        .neumorph-inset {
            box-shadow: inset 6px 6px 10px var(--shadow-dark), 
                        inset -6px -6px 10px var(--shadow-light);
        }

        .btn-calc {
            height: 60px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            background: var(--key-bg);
            box-shadow: 5px 5px 10px var(--shadow-dark), 
                       -5px -5px 10px var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .btn-calc:active, .btn-calc.pressed {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), 
                        inset -4px -4px 8px var(--shadow-light);
            transform: scale(0.98);
        }

        .btn-calc.accent {
            color: var(--accent-color);
        }

        .btn-calc.operator {
            color: var(--operator-color);
            font-size: 1.3rem;
        }

        .btn-calc.equal {
            background: var(--operator-color);
            color: white;
            box-shadow: 5px 5px 10px var(--shadow-dark), 
                       -5px -5px 10px var(--shadow-light);
        }
        
        .btn-calc.equal:active, .btn-calc.equal.pressed {
            background: var(--operator-color);
            box-shadow: inset 4px 4px 8px rgba(0,0,0,0.3);
        }

        .screen-text {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 4px;
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Modal History */
        .modal {
            background: var(--modal-bg);
            backdrop-filter: blur(10px);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="neumorph p-6 w-full max-w-md flex flex-col gap-6 relative" style="max-height: 95vh;">
        
        <!-- Header: Icons & Title -->
        <div class="flex justify-between items-center px-2">
            <button id="historyBtn" class="btn-calc !h-8 !w-8 !rounded-full !text-xs" title="Lịch sử">
                <i class="fas fa-history"></i>
            </button>
            <div class="text-xs font-bold tracking-widest uppercase" style="color: var(--text-secondary);">CASIO PRO</div>
            <button id="themeToggle" class="btn-calc !h-8 !w-8 !rounded-full !text-xs" title="Giao diện">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Screen Area -->
        <div class="neumorph-inset p-4 rounded-xl flex flex-col justify-end h-40 relative overflow-hidden">
            <!-- Mini History (Previous calc) -->
            <div id="miniHistoryDisplay" class="text-right text-sm mb-1 h-6 truncate" style="color: var(--text-secondary); opacity: 0.6;">
                
            </div>
            <!-- Current Expression (Small) -->
            <div id="subDisplay" class="text-right text-sm h-6 overflow-hidden truncate" style="color: var(--text-secondary); opacity: 0.8;">
                
            </div>
            <!-- Main Result -->
            <input type="text" id="mainDisplay" readonly 
                class="screen-text w-full bg-transparent text-right text-3xl font-bold outline-none border-none cursor-text" 
                style="color: var(--text-main);"
                value="0">
        </div>

        <!-- Advanced Functions Toggle -->
        <div class="grid grid-cols-5 gap-3 mb-2">
            <button class="btn-calc text-xs" onclick="handleSci('sin')">sin</button>
            <button class="btn-calc text-xs" onclick="handleSci('cos')">cos</button>
            <button class="btn-calc text-xs" onclick="handleSci('tan')">tan</button>
            <button class="btn-calc text-xs" onclick="handleSci('log')">log</button>
            <button class="btn-calc text-xs" onclick="handleSci('sqrt')">√</button>
        </div>

        <!-- Keypad Grid -->
        <div class="grid grid-cols-4 gap-4">
            <!-- Row 1 -->
            <button class="btn-calc accent text-sm" data-key="Escape" onclick="clearAll()">AC</button>
            <button class="btn-calc accent text-sm" data-key="Backspace" onclick="deleteChar()">DEL</button>
            <button class="btn-calc operator" data-key="%" onclick="appendOper('%')">%</button>
            <button class="btn-calc operator" data-key="/" onclick="appendOper('/')">÷</button>

            <!-- Row 2 -->
            <button class="btn-calc" data-key="7" onclick="appendNum('7')">7</button>
            <button class="btn-calc" data-key="8" onclick="appendNum('8')">8</button>
            <button class="btn-calc" data-key="9" onclick="appendNum('9')">9</button>
            <button class="btn-calc operator" data-key="*" onclick="appendOper('*')">×</button>

            <!-- Row 3 -->
            <button class="btn-calc" data-key="4" onclick="appendNum('4')">4</button>
            <button class="btn-calc" data-key="5" onclick="appendNum('5')">5</button>
            <button class="btn-calc" data-key="6" onclick="appendNum('6')">6</button>
            <button class="btn-calc operator" data-key="-" onclick="appendOper('-')">-</button>

            <!-- Row 4 -->
            <button class="btn-calc" data-key="1" onclick="appendNum('1')">1</button>
            <button class="btn-calc" data-key="2" onclick="appendNum('2')">2</button>
            <button class="btn-calc" data-key="3" onclick="appendNum('3')">3</button>
            <button class="btn-calc operator" data-key="+" onclick="appendOper('+')">+</button>

            <!-- Row 5 -->
            <button class="btn-calc" data-key="0" onclick="appendNum('0')">0</button>
            <button class="btn-calc" data-key="00" onclick="appendNum('00')">00</button>
            <button class="btn-calc" data-key="." onclick="appendNum('.')">.</button>
            <button class="btn-calc equal" data-key="Enter" onclick="calculate()">=</button>
        </div>

        <!-- History Modal Overlay -->
        <div id="historyModal" class="modal absolute inset-0 rounded-2xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-400/20">
                <h3 class="font-bold text-lg" style="color: var(--text-main)">Lịch Sử Tính Toán</h3>
                <button id="closeHistory" class="text-xl hover:opacity-70 transition" style="color: var(--text-main)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- History List -->
            <div id="fullHistoryList" class="flex-1 overflow-y-auto custom-scroll space-y-3" style="color: var(--text-main)">
                <div class="text-center text-sm opacity-50 mt-10">Chưa có phép tính nào</div>
            </div>

            <button onclick="clearHistory()" class="btn-calc accent w-full mt-4 !h-12 text-sm">
                <i class="fas fa-trash-alt mr-2"></i> Xóa Tất Cả
            </button>
        </div>

    </div>

    <script>
        // State
        let currentInput = '0';
        let historyData = [];
        let justCalculated = false;

        // Elements
        const mainDisplay = document.getElementById('mainDisplay');
        const subDisplay = document.getElementById('subDisplay');
        const miniHistoryDisplay = document.getElementById('miniHistoryDisplay');
        const fullHistoryList = document.getElementById('fullHistoryList');
        const historyModal = document.getElementById('historyModal');
        const themeBtn = document.getElementById('themeToggle');

        // Initial update
        updateScreen();

        // --- Core Logic ---

        function appendNum(num) {
            if (justCalculated) {
                currentInput = num;
                justCalculated = false;
            } else {
                if (currentInput === '0' && num !== '.') {
                    currentInput = num;
                } else {
                    if (num === '.' && currentInput.includes('.')) return;
                    currentInput += num;
                }
            }
            updateScreen();
        }

        function appendOper(op) {
            if (justCalculated) {
                justCalculated = false;
            }
            
            // Logic to prevent double operators or replace last operator
            const lastChar = currentInput.slice(-1);
            if (['+', '-', '*', '/', '%'].includes(lastChar)) {
                // If input is just an operator (rare), or we are chaining
                currentInput = currentInput.slice(0, -1) + op;
            } else {
                currentInput += op;
            }
            updateScreen();
        }

        function clearAll() {
            currentInput = '0';
            subDisplay.innerText = '';
            justCalculated = false;
            updateScreen();
        }

        function deleteChar() {
            if (justCalculated) {
                clearAll();
                return;
            }
            if (currentInput.length === 1) {
                currentInput = '0';
            } else {
                currentInput = currentInput.slice(0, -1);
            }
            updateScreen();
        }

        function handleSci(func) {
            let val = parseFloat(evalSafe(currentInput));
            if (isNaN(val)) return;

            let result = 0;
            switch(func) {
                case 'sin': result = Math.sin(val * Math.PI / 180); break; // Degree
                case 'cos': result = Math.cos(val * Math.PI / 180); break;
                case 'tan': result = Math.tan(val * Math.PI / 180); break;
                case 'sqrt': result = Math.sqrt(val); break;
                case 'log': result = Math.log10(val); break;
            }
            
            let formattedRes = parseFloat(result.toFixed(8)).toString();
            saveHistory(`${func}(${val})`, formattedRes);
            
            currentInput = formattedRes;
            justCalculated = true;
            updateScreen();
        }

        function calculate() {
            try {
                // Prevent empty calculation
                if (!currentInput || currentInput === 'Error') return;

                let expression = currentInput
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/');

                // Handle percentage
                expression = expression.replace(/(\d+(\.\d+)?)%/g, '($1/100)');

                const result = evalSafe(expression);
                
                if (result === Infinity || isNaN(result)) {
                    currentInput = "Error";
                } else {
                    let formattedResult = parseFloat(result.toFixed(10)).toString();
                    saveHistory(currentInput, formattedResult);
                    currentInput = formattedResult;
                }
                justCalculated = true;
            } catch (e) {
                currentInput = "Error";
            }
            updateScreen();
        }

        function evalSafe(fn) {
            return new Function('return ' + fn)();
        }

        function updateScreen() {
            // Display formatted number
            mainDisplay.value = currentInput;
            // Simple visual indicator for operator
            const lastChar = currentInput.slice(-1);
            if (['+', '-', '*', '/'].includes(lastChar)) {
                 subDisplay.innerText = currentInput;
            } else {
                 subDisplay.innerText = '';
            }
        }

        // --- History Logic ---
        function saveHistory(expr, res) {
            // Clean up visual expression
            let displayExpr = expr.replace(/\*/g, '×').replace(/\//g, '÷');
            
            // Add to data array
            historyData.unshift({ expr: displayExpr, res: res });
            
            // Limit to 20 items
            if (historyData.length > 20) historyData.pop();

            // Update Mini Display (Latest only)
            miniHistoryDisplay.innerText = `${displayExpr} = ${res}`;

            renderHistoryModal();
        }

        function renderHistoryModal() {
            if (historyData.length === 0) {
                fullHistoryList.innerHTML = '<div class="text-center text-sm opacity-50 mt-10">Chưa có phép tính nào</div>';
                return;
            }

            fullHistoryList.innerHTML = historyData.map((item, index) => `
                <div class="neumorph-inset p-3 rounded-lg mb-2 flex justify-between items-center">
                    <div class="text-xs opacity-70 w-1/2 break-words">${item.expr}</div>
                    <div class="font-bold text-lg" onclick="recallHistory('${item.res}')" style="cursor:pointer; color: var(--accent-color)">${item.res}</div>
                </div>
            `).join('');
        }

        function recallHistory(val) {
            if (['+', '-', '*', '/'].includes(currentInput.slice(-1))) {
                 currentInput += val;
            } else {
                 currentInput = val;
                justCalculated = true; // treat as a result
            }
            historyModal.classList.remove('active'); // Close modal on selection
            updateScreen();
        }

        function clearHistory() {
            historyData = [];
            miniHistoryDisplay.innerText = '';
            renderHistoryModal();
        }

        // --- Modal Control ---
        const historyBtn = document.getElementById('historyBtn');
        const closeHistoryBtn = document.getElementById('closeHistory');

        historyBtn.addEventListener('click', () => {
            renderHistoryModal();
            historyModal.classList.add('active');
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.remove('active');
        });

        // --- Dark Mode ---
        let isDarkMode = false;
        themeBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        });

        // --- Enhanced Keyboard Support ---
        document.addEventListener('keydown', (e) => {
            const key = e.key;

            // Map keyboard keys to calculator functions
            if (key >= '0' && key <= '9') {
                appendNum(key);
                animateButton(key);
            } 
            else if (key === '.') {
                appendNum('.');
                animateButton('.');
            }
            else if (key === '+' || key === '-') {
                e.preventDefault(); // Prevent scrolling if applicable
                appendOper(key);
                animateButton(key);
            }
            else if (key === '*' || key.toLowerCase() === 'x') {
                e.preventDefault();
                appendOper('*');
                animateButton('*');
            }
            else if (key === '/') {
                e.preventDefault(); // Prevent Firefox quick search
                appendOper('/');
                animateButton('/');
            }
            else if (key === 'Enter' || key === '=') {
                e.preventDefault(); // Prevent form submit
                calculate();
                animateButton('Enter');
            }
            else if (key === 'Backspace') {
                deleteChar();
                animateButton('Backspace');
            }
            else if (key === 'Escape' || key.toLowerCase() === 'c') {
                clearAll();
                animateButton('Escape');
            }
            else if (key === '%') {
                appendOper('%');
                animateButton('%');
            }
        });

        // Visual feedback
        function animateButton(keyVal) {
            let selector = `button[data-key="${keyVal}"]`;
            
            // Handle mappings for visual matching
            if (keyVal === 'Enter') selector = `button[data-key="Enter"]`;
            if (keyVal === '*') selector = `button[data-key="*"]`;
            if (keyVal === '/') selector = `button[data-key="/"]`;

            const btn = document.querySelector(selector);
            if (btn) {
                btn.classList.add('pressed');
                setTimeout(() => btn.classList.remove('pressed'), 150);
            }
        }

        // Ripple Effect
        document.querySelectorAll('.btn-calc').forEach(btn => {
            btn.addEventListener('click', function(e) {
                let rect = this.getBoundingClientRect();
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                
                let ripples = document.createElement('span');
                ripples.classList.add('ripple');
                ripples.style.left = x + 'px';
                ripples.style.top = y + 'px';
                this.appendChild(ripples);
                setTimeout(() => {
                    ripples.remove();
                }, 600);
            });
        });

    </script>
</body>
</html>
