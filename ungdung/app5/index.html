import React, { useState, useEffect } from 'react';

// Cấu trúc cột chuẩn xác từ file mẫu
const CSV_HEADERS = [
  "MA_NHOM", "MA_LOAI", "MA_HOAT_CHAT", "HOAT_CHAT", "STT", "MA_ACT", "MA_BYT",
  "SO_DANG_KY", "MA_THUOC", "TEN_THUOC", "HAM_LUONG", "DON_VI_TINH", "DONG_GOI",
  "MA_DUONG_DUNG", "DUONG_DUNG", "LIEU_LUONG", "HANG_SX", "NUOC_SX", "NHA_CUNG_CAP",
  "MA_NHOM_THAU", "GOI_THAU", "SO_GOI_THAU", "DANGBAOCHE", "TYLEHUHAO", "QUYET_DINH",
  "CONG_BO", "STT_THAU", "TEN_GIAM_DINH_BH", "BHYT_CHI_TRA", "GIA_BHYT_QUYET_TOAN",
  "GIA_THAU", "GIA_BAN", "MA_THUOC_BV", "GIA_BHYT", "GIA_DICH_VU", "NGUONCT",
  "THUOCPHONGXA", "DUOCPHEPKELE", "VITHUOCYHCT", "KETRUNGHOATCHAT", "THUOCTANDUOC",
  "CHEPHAMYHCT", "THUOCKHANGSINH", "KHONGTINHXNT", "DANHSTTDUNGTHUOC", "THUOCNHIEUHOATCHAT",
  "THUOCKEDON", "TIENCHATGNHT", "QLTHEOTUIMAU", "DUOCDUYETLE", "THUOCDIEUTRILAO",
  "THUOCCORTICOID", "SOGIAYPHEP", "NHOM_BHXH", "THAUGHEP", "MA_PP_CHEBIEN", "MAHIEUSP",
  "MA_NHOM_VTYT", "TEN_VTYT"
];

// Từ điển ánh xạ Đường dùng -> Mã đường dùng (Dựa trên chuẩn BYT)
const DUONG_DUNG_MAPPING = [
  { name: '', code: '' },
  { name: 'Uống', code: '1.01' },
  { name: 'Tiêm', code: '1.02' },
  { name: 'Tiêm bắp', code: '1.03' },
  { name: 'Tiêm tĩnh mạch', code: '1.04' },
  { name: 'Tiêm dưới da', code: '1.05' },
  { name: 'Tiêm truyền tĩnh mạch', code: '1.06' },
  { name: 'Ngậm', code: '1.07' },
  { name: 'Dùng ngoài', code: '2.01' },
  { name: 'Bôi', code: '2.02' },
  { name: 'Nhỏ mắt', code: '3.01' },
  { name: 'Nhỏ tai', code: '3.02' },
  { name: 'Nhỏ mũi', code: '3.03' },
  { name: 'Đặt âm đạo', code: '4.01' },
  { name: 'Đặt hậu môn', code: '4.02' },
  { name: 'Hô hấp', code: '5.01' },
  { name: 'Xông hít', code: '5.02' }
];

export default function App() {
  const [dataList, setDataList] = useState([]);
  
  // Khởi tạo form rỗng
  const initialForm = {
    STT: "",
    HOAT_CHAT: "",
    TEN_THUOC: "",
    SO_DANG_KY: "",
    HAM_LUONG: "",
    DON_VI_TINH: "viên",
    DONG_GOI: "Hộp 10 vỉ x 10 viên",
    DUONG_DUNG: "",
    MA_DUONG_DUNG: "",
    HANG_SX: "",
    NUOC_SX: "VIỆT NAM",
    NHA_CUNG_CAP: "",
    GIA_BAN: "",
    GIA_THAU: ""
  };
  
  const [formData, setFormData] = useState(initialForm);
  const [notification, setNotification] = useState("");

  // Load dữ liệu từ LocalStorage khi khởi chạy
  useEffect(() => {
    const savedData = localStorage.getItem('pharmaImportData');
    if (savedData) {
      try {
        setDataList(JSON.parse(savedData));
      } catch (e) {
        console.error("Lỗi khi đọc dữ liệu", e);
      }
    }
  }, []);

  // Hàm hiển thị thông báo
  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(""), 3000);
  };

  // Xử lý thay đổi input
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    
    // Logic tự động generate Mã đường dùng
    if (name === "DUONG_DUNG") {
      const selectedMapping = DUONG_DUNG_MAPPING.find(d => d.name === value);
      setFormData({
        ...formData,
        [name]: value,
        MA_DUONG_DUNG: selectedMapping ? selectedMapping.code : formData.MA_DUONG_DUNG
      });
    } else {
      setFormData({ ...formData, [name]: value });
    }
  };

  // Xử lý Thêm mới
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.TEN_THUOC) {
      alert("Vui lòng nhập Tên thuốc!");
      return;
    }
    
    const updatedList = [...dataList, formData];
    setDataList(updatedList);
    localStorage.setItem('pharmaImportData', JSON.stringify(updatedList));
    showNotification("Đã thêm thuốc thành công!");
    
    // Reset form, nhưng giữ lại một số trường thường lặp lại để nhập nhanh hơn
    setFormData({
      ...initialForm,
      NHA_CUNG_CAP: formData.NHA_CUNG_CAP,
      NUOC_SX: formData.NUOC_SX,
      STT: formData.STT ? (parseInt(formData.STT) + 1).toString() : ""
    });
  };

  // Xử lý Xóa 1 dòng
  const handleDelete = (index) => {
    if (window.confirm("Bạn có chắc muốn xóa thuốc này?")) {
      const updatedList = dataList.filter((_, i) => i !== index);
      setDataList(updatedList);
      localStorage.setItem('pharmaImportData', JSON.stringify(updatedList));
    }
  };

  // Xóa toàn bộ dữ liệu
  const handleClearAll = () => {
    if (window.confirm("CẢNH BÁO: Xóa toàn bộ dữ liệu hiện có? Dữ liệu chưa xuất file sẽ bị mất!")) {
      setDataList([]);
      localStorage.removeItem('pharmaImportData');
      showNotification("Đã xóa toàn bộ dữ liệu");
    }
  };

  // Xuất file Excel (.xls)
  const handleExportExcel = () => {
    if (dataList.length === 0) {
      alert("Chưa có dữ liệu để xuất file!");
      return;
    }

    // Tạo cấu trúc bảng HTML - Excel có thể đọc trực tiếp chuẩn này
    let tableHTML = '<table border="1"><thead><tr>';
    CSV_HEADERS.forEach(header => {
      tableHTML += `<th>${header}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    dataList.forEach(item => {
      tableHTML += '<tr>';
      CSV_HEADERS.forEach(header => {
        // Lọc ký tự đặc biệt tránh vỡ form html và ép kiểu text để không mất số 0 ở đầu
        const cellValue = item[header] ? String(item[header]).replace(/</g, '&lt;').replace(/>/g, '&gt;') : "";
        tableHTML += `<td style='mso-number-format:"\\@"'>${cellValue}</td>`;
      });
      tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';

    // Đóng gói vào template chuẩn của Microsoft Excel
    const template = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office" 
            xmlns:x="urn:schemas-microsoft-com:office:excel" 
            xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <meta charset="UTF-8">
        <!--[if gte mso 9]>
        <xml>
          <x:ExcelWorkbook>
            <x:ExcelWorksheets>
              <x:ExcelWorksheet>
                <x:Name>Sheet1</x:Name>
                <x:WorksheetOptions>
                  <x:DisplayGridlines/>
                </x:WorksheetOptions>
              </x:ExcelWorksheet>
            </x:ExcelWorksheets>
          </x:ExcelWorkbook>
        </xml>
        <![endif]-->
      </head>
      <body>
        ${tableHTML}
      </body>
      </html>
    `;

    // Tạo file và tự động tải xuống
    const blob = new Blob([template], { type: "application/vnd.ms-excel;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", "FILE_IMPORT_THUOC_NEW.xls");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification("Đã tải file Excel (.xls) xuống máy!");
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 p-4 font-sans">
      <div className="max-w-7xl mx-auto space-y-6">
        
        {/* Header */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
          <div>
            <h1 className="text-2xl font-bold text-blue-700">Công Cụ Nhập Liệu Import Thuốc</h1>
            <p className="text-sm text-gray-500 mt-1">Dữ liệu tự động lưu trên trình duyệt - Tự sinh Mã đường dùng</p>
          </div>
          <div className="flex gap-2">
             <button 
              onClick={handleExportExcel}
              className="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg flex items-center gap-2 transition"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18v-6"></path><path d="M9 15l3 3 3-3"></path></svg>
              Xuất File Excel (.xls)
            </button>
          </div>
        </div>

        {/* Thông báo Toast */}
        {notification && (
          <div className="fixed top-4 right-4 z-50 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4ade80" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            {notification}
          </div>
        )}

        {/* Form nhập liệu */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Thêm Thuốc Mới</h2>
          <form onSubmit={handleSubmit}>
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
              
              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Số TT</label>
                <input type="number" name="STT" value={formData.STT} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: 74" />
              </div>

              <div className="col-span-1 lg:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Tên thuốc (*)</label>
                <input type="text" name="TEN_THUOC" required value={formData.TEN_THUOC} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Ambroxol SP 30mg" />
              </div>

              <div className="col-span-1 lg:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Hoạt chất</label>
                <input type="text" name="HOAT_CHAT" value={formData.HOAT_CHAT} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Ambroxol 30mg" />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Số đăng ký</label>
                <input type="text" name="SO_DANG_KY" value={formData.SO_DANG_KY} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: 893100328923" />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Hàm lượng</label>
                <input type="text" name="HAM_LUONG" value={formData.HAM_LUONG} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: 30mg" />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Đơn vị tính</label>
                <input type="text" name="DON_VI_TINH" value={formData.DON_VI_TINH} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: viên, ống..." />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Đóng gói</label>
                <input type="text" name="DONG_GOI" value={formData.DONG_GOI} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Hộp 10 vỉ x 10 viên" />
              </div>

              <div className="col-span-1 bg-blue-50 p-3 rounded-lg border border-blue-100">
                <label className="block text-sm font-medium text-blue-800 mb-1">Đường dùng</label>
                <select name="DUONG_DUNG" value={formData.DUONG_DUNG} onChange={handleInputChange} className="w-full border border-blue-200 rounded-md px-3 py-2 bg-white focus:ring-blue-500 focus:border-blue-500">
                  {DUONG_DUNG_MAPPING.map(d => (
                    <option key={d.code} value={d.name}>{d.name === "" ? "-- Chọn đường dùng --" : d.name}</option>
                  ))}
                </select>
              </div>

              <div className="col-span-1 bg-blue-50 p-3 rounded-lg border border-blue-100">
                <label className="block text-sm font-medium text-blue-800 mb-1">Mã đường dùng</label>
                <input type="text" name="MA_DUONG_DUNG" value={formData.MA_DUONG_DUNG} onChange={handleInputChange} className="w-full border border-blue-200 bg-gray-100 text-gray-600 rounded-md px-3 py-2 cursor-not-allowed" placeholder="Tự động sinh" readOnly />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Hãng sản xuất</label>
                <input type="text" name="HANG_SX" value={formData.HANG_SX} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Shinpoong Daewoo" />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Nước sản xuất</label>
                <input type="text" name="NUOC_SX" value={formData.NUOC_SX} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>

              <div className="col-span-1 lg:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Nhà cung cấp</label>
                <input type="text" name="NHA_CUNG_CAP" value={formData.NHA_CUNG_CAP} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: CÔNG TY TNHH DƯỢC PHẨM..." />
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">Giá bán</label>
                <input type="number" name="GIA_BAN" value={formData.GIA_BAN} onChange={handleInputChange} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VD: 1000" />
              </div>
            </div>

            <div className="mt-6 flex justify-end">
              <button type="submit" className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg flex items-center gap-2 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Thêm Vào Danh Sách
              </button>
            </div>
          </form>
        </div>

        {/* Bảng dữ liệu hiện tại */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div className="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
            <h2 className="text-lg font-semibold text-gray-700">
              Danh Sách Đã Nhập ({dataList.length})
            </h2>
            {dataList.length > 0 && (
              <button onClick={handleClearAll} className="text-sm text-red-600 hover:text-red-800 hover:bg-red-50 px-3 py-1 rounded transition">
                Xóa tất cả
              </button>
            )}
          </div>
          
          <div className="overflow-x-auto max-h-[500px]">
            <table className="w-full text-sm text-left whitespace-nowrap">
              <thead className="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                <tr>
                  <th className="px-4 py-3">STT</th>
                  <th className="px-4 py-3">Tên Thuốc</th>
                  <th className="px-4 py-3">Hoạt Chất</th>
                  <th className="px-4 py-3">Số ĐK</th>
                  <th className="px-4 py-3">Đóng Gói</th>
                  <th className="px-4 py-3">Đường Dùng</th>
                  <th className="px-4 py-3">Mã ĐD</th>
                  <th className="px-4 py-3">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                {dataList.length === 0 ? (
                  <tr>
                    <td colSpan="8" className="px-4 py-8 text-center text-gray-400">
                      Chưa có dữ liệu nào được nhập.
                    </td>
                  </tr>
                ) : (
                  dataList.map((item, index) => (
                    <tr key={index} className="border-b hover:bg-gray-50">
                      <td className="px-4 py-2 font-medium">{item.STT}</td>
                      <td className="px-4 py-2 font-semibold text-blue-700">{item.TEN_THUOC}</td>
                      <td className="px-4 py-2">{item.HOAT_CHAT}</td>
                      <td className="px-4 py-2">{item.SO_DANG_KY}</td>
                      <td className="px-4 py-2">{item.DONG_GOI}</td>
                      <td className="px-4 py-2">
                        <span className="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">
                          {item.DUONG_DUNG}
                        </span>
                      </td>
                      <td className="px-4 py-2 font-mono text-xs">{item.MA_DUONG_DUNG}</td>
                      <td className="px-4 py-2">
                        <button 
                          onClick={() => handleDelete(index)}
                          className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition"
                          title="Xóa"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
        
      </div>
      
      {/* Thêm chút style cho animation */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.3s ease-out forwards;
        }
      `}</style>
    </div>
  );
}
