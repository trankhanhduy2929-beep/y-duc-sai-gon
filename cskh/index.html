<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSKH Bệnh Nhân - Ghép Hồ Sơ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS để đọc file Excel/CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .table-cell-content { max-height: 80px; overflow-y: auto; font-size: 0.9em; }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 z-10 flex-none">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-heart-pulse text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Hệ Thống Chăm Sóc Bệnh Nhân</h1>
            </div>
            <div class="flex gap-2">
                 <button onclick="window.location.reload()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    <i class="fa-solid fa-rotate-right mr-2"></i>Làm mới
                </button>
                <button onclick="exportToExcel()" id="btnExport" disabled class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-file-excel mr-2"></i>Xuất Báo Cáo
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar - Input & Filters -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col flex-none overflow-y-auto z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-5 space-y-6">
                
                <!-- Step 1: Upload File 1 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        1. File Báo Cáo (Hành chính)
                        <span class="block text-xs text-gray-400 font-normal mt-0.5">BaocaoKCBBHYTngoaitru...</span>
                    </label>
                    <div id="drop-zone-1" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 transition relative group">
                        <input type="file" id="file-1" accept=".xls,.xlsx,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="text-gray-500 group-hover:text-blue-600 transition">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2"></i>
                            <p class="text-xs font-medium" id="file-name-1">Kéo thả hoặc chọn file</p>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Upload File 2 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        2. Sổ Khám Bệnh (Chuyên môn)
                        <span class="block text-xs text-gray-400 font-normal mt-0.5">rp_sokhambenhlon...</span>
                    </label>
                    <div id="drop-zone-2" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 transition relative group">
                        <input type="file" id="file-2" accept=".xls,.xlsx,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="text-gray-500 group-hover:text-blue-600 transition">
                            <i class="fa-solid fa-book-medical text-2xl mb-2"></i>
                            <p class="text-xs font-medium" id="file-name-2">Kéo thả hoặc chọn file</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Process -->
                <button onclick="processFiles()" id="btnProcess" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium shadow-md hover:shadow-lg transition flex justify-center items-center gap-2">
                    <span id="process-text">Xử Lý & Ghép Dữ Liệu</span>
                    <div id="process-loader" class="loader hidden w-5 h-5 border-2"></div>
                </button>

                <!-- Filters -->
                <div class="border-t pt-4 mt-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Bộ lọc & Tìm kiếm</h3>
                    <div class="space-y-3">
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Tên, SĐT, Mã y tế..." class="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        </div>
                        
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Đối tượng</label>
                            <select id="filterType" onchange="filterTable()" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none">
                                <option value="all">Tất cả</option>
                                <option value="BHYT">Bảo Hiểm Y Tế</option>
                                <option value="Dịch vụ">Khám Dịch Vụ</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Trạng thái gọi</label>
                            <select id="filterStatus" onchange="filterTable()" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none">
                                <option value="all">Tất cả</option>
                                <option value="pending">Chưa gọi</option>
                                <option value="called">Đã gọi thành công</option>
                                <option value="busy">Máy bận / Không nghe</option>
                                <option value="wrong">Sai số</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="bg-blue-50 rounded-lg p-3 mt-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-blue-600 font-medium">Tổng bệnh nhân</span>
                        <span class="text-sm font-bold text-blue-800" id="stat-total">0</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-xs text-green-600 font-medium">BHYT</span>
                        <span class="text-xs font-bold text-green-800" id="stat-bhyt">0</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-xs text-purple-600 font-medium">Dịch vụ</span>
                        <span class="text-xs font-bold text-purple-800" id="stat-dv">0</span>
                    </div>
                </div>

            </div>
        </aside>

        <!-- Main Data Table -->
        <main class="flex-1 bg-white overflow-hidden flex flex-col relative">
            
            <!-- Empty State -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-0">
                <div class="bg-blue-50 p-6 rounded-full mb-4">
                    <i class="fa-solid fa-table-columns text-4xl text-blue-300"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-700">Chưa có dữ liệu</h3>
                <p class="text-gray-500 max-w-md mt-2">Vui lòng tải lên 2 file Excel từ hệ thống phần mềm bệnh viện (Báo cáo KCBB và Sổ khám bệnh) để bắt đầu.</p>
            </div>

            <!-- Table Container -->
            <div id="table-container" class="hidden flex-1 overflow-auto w-full z-10">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 sticky top-0 z-20 shadow-sm text-xs uppercase text-gray-500 font-semibold tracking-wider">
                        <tr>
                            <th class="px-4 py-3 w-16 text-center">STT</th>
                            <th class="px-4 py-3 w-24">Trạng thái</th>
                            <th class="px-4 py-3 min-w-[200px]">Thông tin Hành Chính</th>
                            <th class="px-4 py-3 min-w-[150px]">Liên hệ & Địa chỉ</th>
                            <th class="px-4 py-3 min-w-[250px]">Chuyên Môn (Sổ Khám)</th>
                            <th class="px-4 py-3 min-w-[200px]">Thuốc & CLS</th>
                            <th class="px-4 py-3 min-w-[200px]">Ghi chú CSKH</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-sm divide-y divide-gray-100">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fa-solid fa-circle-info text-blue-400"></i>
        <span id="toast-msg">Thông báo</span>
    </div>

    <script>
        // --- Global Variables ---
        let rawDataFile1 = null; // Admin info
        let rawDataFile2 = null; // Clinical info
        let mergedData = [];
        
        // --- Helper: Debounce ---
        function debounce(func, timeout = 300){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // --- Helper: Find Header Row Dynamically ---
        // Hospital reports often have merged cells and titles on top.
        // We scan for a specific column name to identify the real header.
        function findHeaderRow(sheet, keyColumnName) {
            const range = XLSX.utils.decode_range(sheet['!ref']);
            for (let R = range.s.r; R <= Math.min(range.e.r, 20); ++R) { // Scan first 20 rows
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = {c: C, r: R};
                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                    const cell = sheet[cellRef];
                    if (cell && cell.v && String(cell.v).toLowerCase().includes(keyColumnName.toLowerCase())) {
                        return R; // Found the header row index
                    }
                }
            }
            return 0; // Default to first row if not found
        }

        // --- Helper: Clean Text ---
        function cleanText(text) {
            if (!text) return '';
            return String(text).trim();
        }

        // --- File Upload Handling ---
        function setupDropZone(dropZoneId, fileInputId, fileNameId, storeVarName) {
            const dropZone = document.getElementById(dropZoneId);
            const input = document.getElementById(fileInputId);
            const nameDisplay = document.getElementById(fileNameId);

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-active');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    handleFile(input.files[0], fileNameId, storeVarName);
                }
            });

            input.addEventListener('change', () => {
                if (input.files.length) {
                    handleFile(input.files[0], fileNameId, storeVarName);
                }
            });
        }

        function handleFile(file, fileNameId, storeVarName) {
            document.getElementById(fileNameId).innerText = file.name;
            document.getElementById(fileNameId).classList.add('text-blue-600', 'font-bold');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Use first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Store raw worksheet to process later
                if (storeVarName === 'file1') rawDataFile1 = worksheet;
                if (storeVarName === 'file2') rawDataFile2 = worksheet;
            };
            reader.readAsArrayBuffer(file);
        }

        setupDropZone('drop-zone-1', 'file-1', 'file-name-1', 'file1');
        setupDropZone('drop-zone-2', 'file-2', 'file-name-2', 'file2');

        // --- MAIN PROCESSING LOGIC ---
        function processFiles() {
            if (!rawDataFile1 || !rawDataFile2) {
                showToast("Vui lòng tải lên cả 2 file trước khi xử lý!");
                return;
            }

            const btn = document.getElementById('btnProcess');
            const loader = document.getElementById('process-loader');
            const text = document.getElementById('process-text');
            
            btn.disabled = true;
            loader.classList.remove('hidden');
            text.innerText = "Đang xử lý...";

            setTimeout(() => {
                try {
                    // 1. Process File 1 (BaocaoKCBBHYTngoaitru)
                    // Look for header containing "Mã y tế" or "Họ tên"
                    const headerRow1 = findHeaderRow(rawDataFile1, "Mã y tế");
                    const data1 = XLSX.utils.sheet_to_json(rawDataFile1, { range: headerRow1, defval: "" });

                    // 2. Process File 2 (rp_sokhambenhlon)
                    // This file often has complex headers. 
                    const headerRow2 = findHeaderRow(rawDataFile2, "Mã y tế");
                    const data2 = XLSX.utils.sheet_to_json(rawDataFile2, { range: headerRow2, defval: "" });

                    // 3. Create Map for fast lookup from File 2
                    // Key: Mã y tế
                    const clinicalMap = {};
                    data2.forEach(row => {
                        // Normalize keys (remove spaces, lowercase) to find standard columns if names vary slightly
                        let rowData = {};
                        for (let k in row) {
                            rowData[k.trim().toLowerCase()] = row[k];
                        }

                        // Try to find the Key
                        // Keys usually: 'mã y tế'
                        const id = rowData['mã y tế'];
                        if (id) {
                            // Extract relevant clinical info
                            // Note: We search for keys loosely because excel headers might have newlines or slight variations
                            
                            // Find specific keys dynamically
                            const symptomKey = Object.keys(rowData).find(k => k.includes('triệu chứng'));
                            const diagKey = Object.keys(rowData).find(k => k.includes('chẩn đoán'));
                            const doctorKey = Object.keys(rowData).find(k => k.includes('bác sĩ') || k.includes('bs'));
                            const treatmentKey = Object.keys(rowData).find(k => k.includes('chỉ định') || k.includes('thuốc') || k.includes('điều trị'));
                            
                            // Combine Paraclinical (Xét nghiệm + CĐHA)
                            const testKey = Object.keys(rowData).find(k => k.includes('xét nghiệm'));
                            const imageKey = Object.keys(rowData).find(k => k.includes('hình ảnh') || k.includes('siêu âm') || k.includes('x-quang'));
                            
                            let cls = [];
                            if (rowData[testKey]) cls.push(rowData[testKey]);
                            if (rowData[imageKey]) cls.push(rowData[imageKey]);

                            clinicalMap[id] = {
                                doctor: rowData[doctorKey] || "---",
                                symptoms: rowData[symptomKey] || "",
                                diagnosis: rowData[diagKey] || "",
                                treatment: rowData[treatmentKey] || "",
                                paraclinical: cls.join(", ")
                            };
                        }
                    });

                    // 4. Merge Data (Base is File 1)
                    mergedData = [];
                    data1.forEach((row, index) => {
                        let rowData = {};
                        for (let k in row) {
                            rowData[k.trim().toLowerCase()] = row[k];
                        }

                        const id = rowData['mã y tế'];
                        if (!id) return; // Skip empty rows

                        // Determine Insurance vs Service
                        const insuranceCard = rowData['số thẻ'] || rowData['số thẻ bhyt'];
                        const isService = !insuranceCard || String(insuranceCard).trim() === '' || String(insuranceCard).trim() === '0';
                        const type = isService ? 'Dịch vụ' : 'BHYT';

                        // Get Clinical Data
                        const clinical = clinicalMap[id] || { doctor: '', symptoms: '', diagnosis: '', treatment: '', paraclinical: '' };

                        mergedData.push({
                            id: id,
                            name: rowData['họ tên'],
                            yob: rowData['năm sinh'] || (new Date().getFullYear() - (parseInt(rowData['tuổi']) || 0)),
                            age: rowData['tuổi'],
                            weight: rowData['cân nặng'],
                            phone: cleanText(rowData['số điện thoại'] || rowData['sđt'] || rowData['điện thoại']),
                            address: rowData['địa chỉ'],
                            cccd: rowData['cccd'],
                            cardNo: insuranceCard,
                            room: rowData['phòng khám'] || rowData['phòng'],
                            time: rowData['thời gian tiếp nhận'] || rowData['thời gian đến khám'],
                            type: type,
                            // Clinical
                            doctor: clinical.doctor,
                            symptoms: clinical.symptoms,
                            diagnosis: clinical.diagnosis,
                            treatment: clinical.treatment,
                            paraclinical: clinical.paraclinical,
                            // CSKH State
                            callStatus: 'pending', // pending, called, busy, wrong
                            note: ''
                        });
                    });

                    renderTable(mergedData);
                    updateStats();
                    
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('table-container').classList.remove('hidden');
                    document.getElementById('btnExport').disabled = false;
                    showToast(`Đã xử lý thành công ${mergedData.length} hồ sơ!`);

                } catch (err) {
                    console.error(err);
                    showToast("Lỗi xử lý file: " + err.message);
                } finally {
                    btn.disabled = false;
                    loader.classList.add('hidden');
                    text.innerText = "Xử Lý & Ghép Dữ Liệu";
                }
            }, 500); // UI delay for better UX
        }

        // --- Rendering ---
        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition group border-b border-gray-100";
                
                // Styles for Badge
                const typeClass = item.type === 'BHYT' 
                    ? 'bg-green-100 text-green-700 border border-green-200' 
                    : 'bg-purple-100 text-purple-700 border border-purple-200';

                // Status Dropdown Color Logic
                const getStatusColor = (status) => {
                    switch(status) {
                        case 'called': return 'text-green-600 bg-green-50 border-green-200';
                        case 'busy': return 'text-orange-600 bg-orange-50 border-orange-200';
                        case 'wrong': return 'text-red-600 bg-red-50 border-red-200';
                        default: return 'text-gray-600 bg-gray-50 border-gray-200';
                    }
                };

                tr.innerHTML = `
                    <td class="px-4 py-3 text-center text-gray-500 font-mono text-xs">${index + 1}</td>
                    
                    <td class="px-4 py-3">
                        <select onchange="updateStatus('${item.id}', this.value)" class="w-full text-xs font-medium py-1 px-2 rounded border focus:outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer ${getStatusColor(item.callStatus)}">
                            <option value="pending" ${item.callStatus === 'pending' ? 'selected' : ''}>Chưa gọi</option>
                            <option value="called" ${item.callStatus === 'called' ? 'selected' : ''}>Đã gọi</option>
                            <option value="busy" ${item.callStatus === 'busy' ? 'selected' : ''}>Máy bận</option>
                            <option value="wrong" ${item.callStatus === 'wrong' ? 'selected' : ''}>Sai số</option>
                        </select>
                    </td>

                    <td class="px-4 py-3 align-top">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-gray-800 text-sm">${item.name}</span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded-full ${typeClass}">${item.type}</span>
                        </div>
                        <div class="text-xs text-gray-500 space-y-0.5">
                            <div><span class="font-medium">Mã:</span> ${item.id}</div>
                            <div><span class="font-medium">Tuổi:</span> ${item.age} | <span class="font-medium">Cân nặng:</span> ${item.weight}kg</div>
                            <div><span class="font-medium">Giờ khám:</span> ${item.time}</div>
                        </div>
                    </td>

                    <td class="px-4 py-3 align-top">
                        <div class="mb-1">
                            ${item.phone ? 
                                `<a href="tel:${item.phone}" class="flex items-center gap-1.5 text-blue-600 font-bold hover:underline bg-blue-50 px-2 py-1 rounded w-max">
                                    <i class="fa-solid fa-phone text-xs"></i> ${item.phone}
                                </a>` : 
                                `<span class="text-gray-400 italic text-xs">Không có SĐT</span>`
                            }
                        </div>
                        <div class="text-xs text-gray-500 line-clamp-2" title="${item.address}">
                            <i class="fa-solid fa-location-dot mr-1 text-gray-400"></i>${item.address}
                        </div>
                    </td>

                    <td class="px-4 py-3 align-top">
                        <div class="table-cell-content">
                            <div class="mb-1 text-xs"><span class="font-bold text-gray-700">BS:</span> ${item.doctor} - <span class="text-gray-600">${item.room}</span></div>
                            <div class="mb-1 text-xs"><span class="font-bold text-red-600">Chẩn đoán:</span> ${item.diagnosis}</div>
                            <div class="text-xs italic text-gray-500"><span class="font-medium">Triệu chứng:</span> ${item.symptoms}</div>
                        </div>
                    </td>

                    <td class="px-4 py-3 align-top">
                        <div class="table-cell-content space-y-1">
                            <div class="text-xs bg-yellow-50 p-1.5 rounded border border-yellow-100 text-gray-700">
                                <i class="fa-solid fa-pills mr-1 text-yellow-600"></i>${item.treatment || 'Không có thuốc'}
                            </div>
                            ${item.paraclinical ? 
                                `<div class="text-xs bg-blue-50 p-1.5 rounded border border-blue-100 text-gray-700">
                                    <i class="fa-solid fa-microscope mr-1 text-blue-600"></i>${item.paraclinical}
                                </div>` : ''
                            }
                        </div>
                    </td>

                    <td class="px-4 py-3 align-top">
                        <textarea 
                            onchange="updateNote('${item.id}', this.value)"
                            class="w-full text-xs border border-gray-200 rounded p-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none bg-gray-50 h-20 resize-none" 
                            placeholder="Ghi chú sau cuộc gọi...">${item.note}</textarea>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Actions: Filter, Update, Export ---

        function updateStatus(id, newStatus) {
            const idx = mergedData.findIndex(x => x.id == id);
            if (idx >= 0) {
                mergedData[idx].callStatus = newStatus;
                // Re-render only class update ideally, but full render for simplicity here or DOM manipulation
                const select = document.querySelector(`select[onchange="updateStatus('${id}', this.value)"]`);
                
                // Update select styling immediately
                select.className = select.className.replace(/text-[\w-]+ bg-[\w-]+ border-[\w-]+/, '');
                
                if (newStatus == 'called') select.classList.add('text-green-600', 'bg-green-50', 'border-green-200');
                else if (newStatus == 'busy') select.classList.add('text-orange-600', 'bg-orange-50', 'border-orange-200');
                else if (newStatus == 'wrong') select.classList.add('text-red-600', 'bg-red-50', 'border-red-200');
                else select.classList.add('text-gray-600', 'bg-gray-50', 'border-gray-200');
            }
        }

        function updateNote(id, newNote) {
            const idx = mergedData.findIndex(x => x.id == id);
            if (idx >= 0) mergedData[idx].note = newNote;
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filtered = mergedData.filter(item => {
                const matchTerm = (item.name && item.name.toLowerCase().includes(term)) || 
                                  (item.phone && item.phone.includes(term)) || 
                                  (item.id && String(item.id).includes(term));
                
                const matchType = typeFilter === 'all' || item.type === typeFilter;
                const matchStatus = statusFilter === 'all' || item.callStatus === statusFilter;

                return matchTerm && matchType && matchStatus;
            });

            renderTable(filtered);
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = mergedData.length;
            document.getElementById('stat-bhyt').innerText = mergedData.filter(x => x.type === 'BHYT').length;
            document.getElementById('stat-dv').innerText = mergedData.filter(x => x.type === 'Dịch vụ').length;
        }

        function exportToExcel() {
            if (mergedData.length === 0) return;

            // Prepare data for export
            const exportData = mergedData.map(item => ({
                "STT": "",
                "Mã Y Tế": item.id,
                "Họ Tên": item.name,
                "Tuổi": item.age,
                "Giới tính": "", // Not parsed explicitly but could be added
                "SĐT": item.phone,
                "Địa chỉ": item.address,
                "Loại": item.type,
                "Phòng khám": item.room,
                "Bác sĩ": item.doctor,
                "Chẩn đoán": item.diagnosis,
                "Thuốc": item.treatment,
                "Trạng thái gọi": item.callStatus === 'pending' ? 'Chưa gọi' : 
                                  item.callStatus === 'called' ? 'Đã gọi' : 
                                  item.callStatus === 'busy' ? 'Máy bận' : 'Sai số',
                "Ghi chú CSKH": item.note
            }));

            // Add STT
            exportData.forEach((row, i) => row["STT"] = i + 1);

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoCSKH");
            XLSX.writeFile(wb, "KetQua_CSKH_" + new Date().toISOString().slice(0,10) + ".xlsx");
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
