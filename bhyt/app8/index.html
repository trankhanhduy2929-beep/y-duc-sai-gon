import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Lock, UploadCloud, FileSpreadsheet, AlertTriangle, CheckCircle, 
  Search, User, Clock, Activity, FileText, ChevronRight, ActivitySquare,
  Filter, ShieldAlert, LogOut, FileSearch, Stethoscope, FilePlus2, XCircle
} from 'lucide-react';

// --- THUẬT TOÁN ĐỌC CSV ---
const parseCSV = (strData) => {
  const objPattern = new RegExp(("(\\,|\\r?\\n|\\r|^)(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\\,\\r\\n]*))"), "gi");
  let arrData = [[]];
  let arrMatches = null;
  while ((arrMatches = objPattern.exec(strData))) {
    let strMatchedDelimiter = arrMatches[1];
    if (strMatchedDelimiter.length && strMatchedDelimiter !== ",") arrData.push([]);
    let strMatchedValue;
    if (arrMatches[2]) {
      strMatchedValue = arrMatches[2].replace(new RegExp("\"\"", "g"), "\"");
    } else {
      strMatchedValue = arrMatches[3];
    }
    arrData[arrData.length - 1].push(strMatchedValue);
  }
  const headers = arrData[0].map(h => h ? h.trim() : '');
  const result = [];
  for (let i = 1; i < arrData.length; i++) {
    if (arrData[i].length <= 1 && !arrData[i][0]) continue;
    let obj = {};
    for (let j = 0; j < headers.length; j++) {
      obj[headers[j]] = arrData[i][j] ? arrData[i][j].trim() : '';
    }
    result.push(obj);
  }
  return result;
};

// --- XỬ LÝ THỜI GIAN ---
const formatTime = (val) => {
  if (!val) return val;
  const timeStr = String(val); // Ép kiểu về dạng chuỗi để chống lỗi khi Excel parse ra số
  if (timeStr.length < 12) return timeStr;
  const y = timeStr.slice(0, 4), m = timeStr.slice(4, 6), d = timeStr.slice(6, 8);
  const h = timeStr.slice(8, 10), min = timeStr.slice(10, 12);
  return `${h}:${min} - ${d}/${m}/${y}`;
};

// Chuyển chuỗi YYYYMMDDHHmm thành timestamp để tính toán
const getTs = (val) => {
  if (!val) return 0;
  const str = String(val); // Ép kiểu về dạng chuỗi để chống lỗi TypeError
  if (str.length < 12) return 0;
  return new Date(
    parseInt(str.slice(0, 4)), parseInt(str.slice(4, 6)) - 1, parseInt(str.slice(6, 8)),
    parseInt(str.slice(8, 10)), parseInt(str.slice(10, 12))
  ).getTime();
};

// Tính khoảng cách phút (A - B)
const diffMinutes = (strA, strB) => (getTs(strA) - getTs(strB)) / 60000;


export default function App() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState('');

  // Tải SheetJS động để đọc file Excel
  useEffect(() => {
    if (!window.XLSX) {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      document.head.appendChild(script);
    }
  }, []);

  const handleLogin = (e) => {
    e.preventDefault();
    if (password === '1402') setIsAuthenticated(true);
    else setLoginError('Mật khẩu không chính xác. Vui lòng thử lại.');
  };

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4 font-sans text-slate-100">
        <div className="bg-slate-800/50 p-8 rounded-3xl shadow-2xl backdrop-blur-xl border border-slate-700/50 w-full max-w-md transform transition-all hover:scale-105 duration-500">
          <div className="flex justify-center mb-6">
            <div className="bg-blue-500/20 p-4 rounded-full border border-blue-500/30">
              <ShieldAlert className="w-12 h-12 text-blue-400" />
            </div>
          </div>
          <h1 className="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">BHYT Inspector Pro</h1>
          <p className="text-slate-400 text-center mb-8">Hệ thống dò lỗi Y lệnh & Xung đột thời gian</p>
          
          <form onSubmit={handleLogin} className="space-y-6">
            <div>
              <div className="relative">
                <Lock className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
                <input
                  type="password" value={password} onChange={(e) => {setPassword(e.target.value); setLoginError('');}}
                  placeholder="Nhập mật khẩu truy cập..."
                  className="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-3 pl-12 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                />
              </div>
              {loginError && <p className="text-red-400 text-sm mt-2 ml-1 animate-pulse">{loginError}</p>}
            </div>
            <button type="submit" className="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold py-3 rounded-xl shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
              Đăng Nhập <ChevronRight className="w-5 h-5" />
            </button>
          </form>
        </div>
      </div>
    );
  }

  return <Dashboard onLogout={() => setIsAuthenticated(false)} />;
}

function Dashboard({ onLogout }) {
  const [data, setData] = useState({ bang1: [], bang2: [], bang3: [], bang4: [], dsbs: [] });
  const [analyzing, setAnalyzing] = useState(false);
  const [results, setResults] = useState(null);
  
  // UI State
  const [activeTab, setActiveTab] = useState('DOCTOR'); // 'DOCTOR' | 'PATIENT'
  const [selectedFilterId, setSelectedFilterId] = useState('ALL');

  const fileInputs = {
    bang1: useRef(null), bang2: useRef(null), bang3: useRef(null), bang4: useRef(null), dsbs: useRef(null)
  };

  const handleFileUpload = async (type, e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    // Hỗ trợ CSV và Excel (.xlsx)
    if (file.name.endsWith('.csv')) {
      reader.onload = (evt) => {
        const parsed = parseCSV(evt.target.result);
        setData(prev => ({ ...prev, [type]: parsed }));
      };
      reader.readAsText(file);
    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
      reader.onload = (evt) => {
        if (!window.XLSX) return alert("Thư viện đọc Excel chưa tải xong, vui lòng thử lại sau vài giây.");
        const workbook = window.XLSX.read(evt.target.result, { type: 'binary' });
        const sheetName = workbook.SheetNames[0];
        const parsed = window.XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
        setData(prev => ({ ...prev, [type]: parsed }));
      };
      reader.readAsBinaryString(file);
    } else {
      alert("Định dạng file không hỗ trợ. Vui lòng chọn file .csv hoặc .xlsx");
    }
  };

  const isDataReady = data.bang1.length > 0 && data.dsbs.length > 0 && 
                     (data.bang2.length > 0 || data.bang3.length > 0 || data.bang4.length > 0);

  const analyzeData = () => {
    setAnalyzing(true);
    
    setTimeout(() => {
      // 1. Map Bệnh nhân (MA_LK -> Tên BN)
      const patients = {};
      data.bang1.forEach(row => {
        if (row.MA_LK) {
          patients[row.MA_LK] = {
            maLK: row.MA_LK,
            name: row.HO_TEN || 'Không rõ tên',
            ngayRa: row.NGAY_RA,
            khamList: [],
            clsList: [],
            thuocList: [],
            kqList: []
          };
        }
      });

      // 2. Map Bác sĩ (MA CCHN -> Tên BS)
      const doctorMap = {};
      data.dsbs.forEach(row => {
        const ma = row['MA CCHN'] || row['MÃ CCHN'];
        const ten = row['TEN BS'] || row['TÊN BS'];
        if (ma) doctorMap[ma] = ten;
      });

      // 3. Gom sự kiện Bác sĩ & Bệnh nhân
      const doctorEvents = [];

      // Bảng 3: Dịch vụ (Khám & CLS)
      data.bang3.forEach(row => {
        const maLK = row.MA_LK;
        const patientName = patients[maLK]?.name || maLK;
        const isKham = row.TEN_DICH_VU && row.TEN_DICH_VU.toLowerCase().includes('khám');

        // Bác sĩ chỉ định
        if (row.MA_BAC_SI && row.NGAY_YL) {
          doctorEvents.push({
            maBS: row.MA_BAC_SI, time: row.NGAY_YL, action: 'Chỉ định', detail: row.TEN_DICH_VU, maLK, patientName, source: 'Bảng 3 (CĐ)', isKham
          });
          if (patients[maLK]) {
            if (isKham) patients[maLK].khamList.push({ time: row.NGAY_YL, name: row.TEN_DICH_VU, maBS: row.MA_BAC_SI });
            else patients[maLK].clsList.push({ time: row.NGAY_YL, kqTime: row.NGAY_KQ, name: row.TEN_DICH_VU, maBS: row.MA_BAC_SI });
          }
        }
        // Bác sĩ thực hiện
        if (row.NGUOI_THUC_HIEN && row.NGAY_TH_YL) {
          doctorEvents.push({
            maBS: row.NGUOI_THUC_HIEN, time: row.NGAY_TH_YL, action: 'Thực hiện', detail: row.TEN_DICH_VU, maLK, patientName, source: 'Bảng 3 (TH)', isKham
          });
        }
      });

      // Bảng 4: Đọc kết quả
      data.bang4.forEach(row => {
        const maLK = row.MA_LK;
        if (row.MA_BS_DOC_KQ && row.NGAY_KQ) {
          doctorEvents.push({
            maBS: row.MA_BS_DOC_KQ, time: row.NGAY_KQ, action: 'Đọc KQ', detail: row.TEN_CHI_SO || 'Kết quả CLS', maLK, patientName: patients[maLK]?.name || maLK, source: 'Bảng 4'
          });
          if (patients[maLK]) patients[maLK].kqList.push({ time: row.NGAY_KQ, name: row.TEN_CHI_SO || 'Kết quả CLS', maBS: row.MA_BS_DOC_KQ });
        }
      });

      // Bảng 2: Thuốc
      data.bang2.forEach(row => {
        const maLK = row.MA_LK;
        if (row.MA_BAC_SI && row.NGAY_YL) {
          doctorEvents.push({
            maBS: row.MA_BAC_SI, time: row.NGAY_YL, action: 'Kê đơn', detail: row.TEN_THUOC, maLK, patientName: patients[maLK]?.name || maLK, source: 'Bảng 2'
          });
          if (patients[maLK]) patients[maLK].thuocList.push({ time: row.NGAY_YL, name: row.TEN_THUOC, maBS: row.MA_BAC_SI });
        }
      });

      // --- PHÂN TÍCH LỖI 1: BÁC SĨ TRÙNG THỜI GIAN ---
      const docConflicts = [];
      const eventsByDoctor = {};
      doctorEvents.forEach(ev => {
        if (!eventsByDoctor[ev.maBS]) eventsByDoctor[ev.maBS] = {};
        if (!eventsByDoctor[ev.maBS][ev.time]) eventsByDoctor[ev.maBS][ev.time] = [];
        eventsByDoctor[ev.maBS][ev.time].push(ev);
      });

      Object.keys(eventsByDoctor).forEach(bsID => {
        Object.keys(eventsByDoctor[bsID]).forEach(time => {
          const evts = eventsByDoctor[bsID][time];
          // Quy tắc: Bác sĩ chỉ làm 1 việc 1 thời điểm. Ngoại lệ: Cùng 1 BN thì được phép Chỉ định nhiều CLS hoặc Kê nhiều Thuốc cùng phút.
          if (evts.length > 1) {
            const uniquePatients = new Set(evts.map(e => e.maLK));
            let isConflict = false;
            let reason = '';

            if (uniquePatients.size > 1) {
              isConflict = true;
              reason = `Thực hiện ${evts.length} hành động trên ${uniquePatients.size} bệnh nhân khác nhau.`;
            } else {
              // Cùng 1 bệnh nhân
              // Lọc ra các hành động là "Thực hiện" dịch vụ (không tính công Khám)
              const thucHienKhongPhaiKham = evts.filter(e => e.action === 'Thực hiện' && !e.isKham);

              // NGUYÊN TẮC: Cùng 1 BN, được phép Chỉ định nhiều CLS, Kê nhiều thuốc, Đọc nhiều KQ cùng lúc.
              // CHỈ LỖI KHI: "Thực hiện" từ 2 dịch vụ Cận lâm sàng / Thủ thuật trở lên tại cùng 1 phút.
              if (thucHienKhongPhaiKham.length > 1) {
                isConflict = true;
                reason = `Thực hiện ${thucHienKhongPhaiKham.length} dịch vụ Cận lâm sàng / Thủ thuật cùng một phút.`;
              }
            }

            if (isConflict) {
              docConflicts.push({
                id: bsID, // Dùng ID để lọc
                maBS: bsID,
                tenBS: doctorMap[bsID] || 'Bác sĩ ngoài danh sách',
                time: time,
                events: evts,
                conflictReason: reason
              });
            }
          }
        });
      });
      docConflicts.sort((a, b) => b.time.localeCompare(a.time));

      // --- PHÂN TÍCH LỖI 2: QUY TRÌNH BỆNH NHÂN ---
      const patConflicts = [];
      
      Object.values(patients).forEach(pat => {
        let errors = [];

        // Lọc Khám theo Bác sĩ (lấy lần khám sớm nhất của mỗi BS đối với BN này)
        const khamByDoc = {};
        pat.khamList.forEach(k => {
           if (!khamByDoc[k.maBS] || getTs(k.time) < getTs(khamByDoc[k.maBS].time)) {
              khamByDoc[k.maBS] = k; 
           }
        });
        // Khám sớm nhất của toàn bộ hồ sơ (dự phòng)
        const globalEarliestKham = pat.khamList.length > 0 
          ? pat.khamList.reduce((min, k) => getTs(k.time) < getTs(min.time) ? k : min) 
          : null;

        // 1. CLS phải >= Khám (áp dụng theo Bác sĩ chỉ định)
        pat.clsList.forEach(cls => {
          const khamOfDoc = khamByDoc[cls.maBS];
          if (khamOfDoc && diffMinutes(cls.time, khamOfDoc.time) < 0) {
            errors.push({
              type: 'CĐ Cận lâm sàng sớm',
              desc: `Chuyên khoa BS ${doctorMap[cls.maBS] || cls.maBS}: Chỉ định "${cls.name}" (${formatTime(cls.time)}) trước thời gian Khám (${formatTime(khamOfDoc.time)}).`
            });
          } else if (!khamOfDoc && globalEarliestKham && diffMinutes(cls.time, globalEarliestKham.time) < 0) {
            errors.push({
              type: 'CĐ Cận lâm sàng sớm',
              desc: `Chỉ định "${cls.name}" (${formatTime(cls.time)}) trước thời gian Khám đầu tiên (${formatTime(globalEarliestKham.time)}).`
            });
          }
        });

        // 2. Kiểm tra giờ Thuốc ĐỘC LẬP TỪNG CHUYÊN KHOA (TỪNG BÁC SĨ)
        pat.thuocList.forEach(thuoc => {
          const docId = thuoc.maBS;
          const khamOfDoc = khamByDoc[docId];
          const clsOfDoc = pat.clsList.filter(c => c.maBS === docId);

          let hasKhamError = false;

          // 2.1. Luôn phải kê thuốc sau Khám >= 1 phút (áp dụng cho mọi trường hợp)
          if (khamOfDoc && diffMinutes(thuoc.time, khamOfDoc.time) < 1) {
            errors.push({
              type: 'Kê đơn quá nhanh',
              desc: `Chuyên khoa BS ${doctorMap[docId] || docId}: Kê đơn "${thuoc.name}" (${formatTime(thuoc.time)}) thực hiện trước hoặc chưa đủ 1 phút sau thời gian Khám (${formatTime(khamOfDoc.time)}).`
            });
            hasKhamError = true;
          } else if (!khamOfDoc && globalEarliestKham && diffMinutes(thuoc.time, globalEarliestKham.time) < 1) {
            errors.push({
              type: 'Kê đơn quá nhanh',
              desc: `Kê đơn "${thuoc.name}" (${formatTime(thuoc.time)}) thực hiện trước hoặc chưa đủ 1 phút sau thời gian Khám (${formatTime(globalEarliestKham.time)}).`
            });
            hasKhamError = true;
          }

          // 2.2. NẾU CÓ CLS: Giờ kê thuốc bắt buộc phải sau Kết quả CLS tối thiểu 1 phút
          if (!hasKhamError && clsOfDoc.length > 0) {
            let kqTimesForThisDoc = clsOfDoc.filter(c => c.kqTime).map(c => ({ time: c.kqTime, name: c.name }));
            
            // Fallback: nếu Bảng 3 thiếu NGAY_KQ, lấy KQ từ Bảng 4 thuộc khung giờ của bác sĩ này
            if (kqTimesForThisDoc.length === 0 && pat.kqList.length > 0 && khamOfDoc) {
               kqTimesForThisDoc = pat.kqList.filter(kq => getTs(kq.time) >= getTs(khamOfDoc.time));
            }

            if (kqTimesForThisDoc.length > 0) {
              const conflictingKq = kqTimesForThisDoc.filter(kq => diffMinutes(thuoc.time, kq.time) < 1);
              if (conflictingKq.length > 0) {
                const kqNames = conflictingKq.map(kq => `[${kq.name} lúc ${formatTime(kq.time)}]`).join(', ');
                errors.push({
                  type: 'Kê đơn trước Kết quả CLS',
                  desc: `Chuyên khoa BS ${doctorMap[docId] || docId}: Kê đơn "${thuoc.name}" (${formatTime(thuoc.time)}) không hợp lệ do kê TRƯỚC khi có kết quả CLS: ${kqNames}. Vui lòng sửa giờ thuốc sau các KQ này tối thiểu 1 phút.`
                });
              }
            }
          }

          // 2.3. Thuốc vs Ra viện -> Thuốc <= Ra viện
          if (pat.ngayRa && diffMinutes(thuoc.time, pat.ngayRa) > 0) {
            errors.push({
              type: 'Kê đơn sau Ra viện',
              desc: `Kê đơn "${thuoc.name}" (${formatTime(thuoc.time)}) thực hiện sau thời gian Ra viện (${formatTime(pat.ngayRa)}).`
            });
          }
        });

        // 4. KIỂM TRA TỔNG THỜI GIAN KHÁM BỆNH (TỪ LÚC KHÁM ĐẾN LÚC RA VIỆN >= 6 PHÚT)
        if (pat.ngayRa && globalEarliestKham && diffMinutes(pat.ngayRa, globalEarliestKham.time) < 6) {
            errors.push({
                type: 'Thời gian khám quá ngắn',
                desc: `Tổng thời gian từ lúc y lệnh Khám (${formatTime(globalEarliestKham.time)}) đến lúc Ra viện (${formatTime(pat.ngayRa)}) chưa đủ 6 phút.`
            });
        }

        if (errors.length > 0) {
          patConflicts.push({
            id: pat.maLK,
            maLK: pat.maLK,
            patientName: pat.name,
            errors: errors
          });
        }
      });

      setResults({
        doctorConflicts: docConflicts,
        patientConflicts: patConflicts,
        doctorMap
      });
      setAnalyzing(false);
      setSelectedFilterId('ALL');
    }, 800);
  };

  // Tính toán List cho Sidebar (Bác sĩ hoặc Bệnh nhân)
  const activeSidebarList = useMemo(() => {
    if (!results) return [];
    if (activeTab === 'DOCTOR') {
      const bsSet = new Set(results.doctorConflicts.map(c => c.maBS));
      return Array.from(bsSet).map(id => ({
        id, name: results.doctorMap[id] || id,
        count: results.doctorConflicts.filter(c => c.maBS === id).length
      })).sort((a, b) => b.count - a.count);
    } else {
      return results.patientConflicts.map(p => ({
        id: p.maLK, name: p.patientName,
        count: p.errors.length, subtitle: p.maLK
      })).sort((a, b) => b.count - a.count);
    }
  }, [results, activeTab]);

  // Lọc data hiển thị ở Main Area
  const displayedConflicts = useMemo(() => {
    if (!results) return [];
    if (activeTab === 'DOCTOR') {
      return selectedFilterId === 'ALL' ? results.doctorConflicts : results.doctorConflicts.filter(c => c.maBS === selectedFilterId);
    } else {
      return selectedFilterId === 'ALL' ? results.patientConflicts : results.patientConflicts.filter(c => c.maLK === selectedFilterId);
    }
  }, [results, activeTab, selectedFilterId]);


  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">
      <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-gradient-to-br from-blue-600 to-emerald-500 p-2 rounded-lg text-white">
              <ActivitySquare className="w-6 h-6" />
            </div>
            <h1 className="text-xl font-bold bg-gradient-to-r from-blue-700 to-emerald-600 bg-clip-text text-transparent">
              BHYT Inspector Pro
            </h1>
          </div>
          <button onClick={onLogout} className="flex items-center gap-2 text-slate-500 hover:text-red-500 transition-colors text-sm font-medium">
            <LogOut className="w-4 h-4" /> Đăng xuất
          </button>
        </div>
      </header>

      <main className="flex-1 max-w-7xl mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        {/* KHU VỰC TẢI FILE */}
        <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
          <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <UploadCloud className="w-5 h-5 text-blue-500" /> Tải lên dữ liệu CSV / Excel (.xlsx)
          </h2>
          
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
            {[
              { id: 'bang1', label: 'Bảng 1 (BN)', color: 'blue' },
              { id: 'bang2', label: 'Bảng 2 (Thuốc)', color: 'emerald' },
              { id: 'bang3', label: 'Bảng 3 (Khám/CLS)', color: 'purple' },
              { id: 'bang4', label: 'Bảng 4 (Kết quả)', color: 'orange' },
              { id: 'dsbs', label: 'DS Bác sĩ', color: 'slate' }
            ].map(file => {
              const hasData = data[file.id].length > 0;
              return (
                <div key={file.id} 
                  className={`relative overflow-hidden rounded-xl border-2 border-dashed transition-all duration-300 ${hasData ? `border-${file.color}-400 bg-${file.color}-50` : 'border-slate-200 bg-slate-50 hover:border-blue-400 hover:bg-blue-50'} flex flex-col items-center justify-center p-4 cursor-pointer`}
                  onClick={() => fileInputs[file.id].current.click()}
                >
                  <input type="file" ref={fileInputs[file.id]} onChange={(e) => handleFileUpload(file.id, e)} accept=".csv,.xlsx,.xls" className="hidden" />
                  {hasData ? (
                    <div className="flex flex-col items-center text-center animate-in zoom-in duration-300">
                      <CheckCircle className={`w-8 h-8 text-${file.color}-500 mb-2`} />
                      <span className={`text-sm font-bold text-${file.color}-700`}>{file.label}</span>
                      <span className="text-xs text-slate-500 mt-1">{data[file.id].length} dòng</span>
                    </div>
                  ) : (
                    <div className="flex flex-col items-center text-center text-slate-400">
                      <FileSpreadsheet className="w-8 h-8 mb-2 opacity-50" />
                      <span className="text-sm font-medium">{file.label}</span>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <div className="mt-6 flex justify-end">
            <button 
              onClick={analyzeData} disabled={!isDataReady || analyzing}
              className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold shadow-lg transition-all ${isDataReady && !analyzing ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:shadow-blue-500/30 hover:-translate-y-0.5' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
            >
              {analyzing ? <><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Phân tích...</> : <><FileSearch className="w-5 h-5" /> Bắt đầu kiểm tra lỗi</>}
            </button>
          </div>
        </section>

        {/* KHU VỰC KẾT QUẢ */}
        {results && (
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 animate-in slide-in-from-bottom-4 duration-500">
            
            {/* SIDEBAR LỌC */}
            <div className="lg:col-span-1 flex flex-col gap-4">
              {/* TABS LỌC */}
              <div className="bg-white rounded-2xl p-2 shadow-sm border border-slate-100 flex gap-2">
                <button onClick={() => {setActiveTab('DOCTOR'); setSelectedFilterId('ALL')}} 
                  className={`flex-1 py-2 px-3 rounded-xl text-sm font-bold flex flex-col items-center gap-1 transition-all ${activeTab === 'DOCTOR' ? 'bg-blue-50 text-blue-700 shadow-sm border border-blue-100' : 'text-slate-500 hover:bg-slate-50'}`}>
                  <Stethoscope className="w-5 h-5" /> Lỗi Bác sĩ
                </button>
                <button onClick={() => {setActiveTab('PATIENT'); setSelectedFilterId('ALL')}} 
                  className={`flex-1 py-2 px-3 rounded-xl text-sm font-bold flex flex-col items-center gap-1 transition-all ${activeTab === 'PATIENT' ? 'bg-emerald-50 text-emerald-700 shadow-sm border border-emerald-100' : 'text-slate-500 hover:bg-slate-50'}`}>
                  <Activity className="w-5 h-5" /> Lỗi Bệnh nhân
                </button>
              </div>

              <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 sticky top-24">
                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                  <Filter className="w-4 h-4 text-slate-400" /> Chọn đối tượng
                </h3>
                
                <div className="space-y-2">
                  <button onClick={() => setSelectedFilterId('ALL')}
                    className={`w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-colors flex justify-between items-center ${selectedFilterId === 'ALL' ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
                  >
                    Tất cả danh sách
                    <span className={`px-2 py-0.5 rounded-full text-xs ${selectedFilterId === 'ALL' ? 'bg-white/20' : 'bg-red-100 text-red-600 font-bold'}`}>
                      {activeTab === 'DOCTOR' ? results.doctorConflicts.length : results.patientConflicts.length} lỗi
                    </span>
                  </button>

                  <div className="h-px bg-slate-100 my-2"></div>

                  <div className="max-h-[450px] overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    {activeSidebarList.map(item => (
                      <button key={item.id} onClick={() => setSelectedFilterId(item.id)}
                        className={`w-full text-left px-3 py-2.5 rounded-xl text-sm transition-all flex flex-col gap-1 border ${selectedFilterId === item.id ? (activeTab === 'DOCTOR' ? 'bg-blue-50 border-blue-200' : 'bg-emerald-50 border-emerald-200') : 'bg-white border-transparent hover:bg-slate-50 hover:border-slate-200'}`}
                      >
                        <span className={`font-semibold line-clamp-1 ${selectedFilterId === item.id ? (activeTab==='DOCTOR'?'text-blue-700':'text-emerald-700') : 'text-slate-700'}`}>{item.name}</span>
                        <div className="flex justify-between items-center w-full text-xs">
                          <span className="text-slate-400 font-mono truncate mr-2">{item.subtitle || item.id.split('/')[0]}</span>
                          <span className="bg-red-50 text-red-600 font-bold px-2 py-0.5 rounded border border-red-100 whitespace-nowrap">
                            {item.count} lỗi
                          </span>
                        </div>
                      </button>
                    ))}
                    {activeSidebarList.length === 0 && (
                      <div className="text-center py-8 text-emerald-500 font-medium">
                        <CheckCircle className="w-8 h-8 mx-auto mb-2 opacity-50" /> Không có lỗi nào
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* DANH SÁCH LỖI (MAIN CONTENT) */}
            <div className="lg:col-span-3 space-y-4">
              <div className="flex items-center justify-between mb-2">
                <h2 className="text-xl font-bold text-slate-800">
                  {activeTab === 'DOCTOR' ? 'Chi tiết Bác sĩ trùng giờ' : 'Chi tiết sai lệch quy trình Y lệnh'}
                </h2>
                <span className="text-sm font-medium text-slate-500">Hiển thị {displayedConflicts.length} trường hợp</span>
              </div>

              {/* RENDER DOCTOR CONFLICTS */}
              {activeTab === 'DOCTOR' && displayedConflicts.map((conflict, idx) => {
                // Gom nhóm các sự kiện theo từng Bệnh nhân
                const groupedEvents = conflict.events.reduce((acc, ev) => {
                  if (!acc[ev.maLK]) {
                    acc[ev.maLK] = {
                      patientName: ev.patientName,
                      maLK: ev.maLK,
                      kham: [],
                      cls: [],
                      thuoc: [],
                      kq: []
                    };
                  }
                  if (ev.source === 'Bảng 2') acc[ev.maLK].thuoc.push(ev.detail);
                  else if (ev.isKham) acc[ev.maLK].kham.push(`[${ev.action}] ${ev.detail}`);
                  else if (ev.source.includes('Bảng 3')) acc[ev.maLK].cls.push(`[${ev.action}] ${ev.detail}`);
                  else if (ev.source === 'Bảng 4') acc[ev.maLK].kq.push(`[Đọc KQ] ${ev.detail}`);
                  return acc;
                }, {});

                return (
                  <div key={idx} className="bg-white rounded-2xl shadow-sm border border-red-100 overflow-hidden hover:shadow-md transition-shadow">
                    <div className="bg-red-50/50 border-b border-red-100 p-4 flex flex-wrap items-center justify-between gap-4">
                      <div className="flex items-center gap-3">
                        <div className="bg-red-100 p-2 rounded-lg text-red-600"><Clock className="w-5 h-5" /></div>
                        <div>
                          <p className="text-xs font-bold text-red-500 uppercase tracking-wider">Thời điểm vi phạm</p>
                          <p className="text-lg font-bold text-slate-800">{formatTime(conflict.time)}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-lg">
                        <User className="w-4 h-4 text-blue-500" />
                        <span className="text-sm font-semibold text-blue-700">{conflict.tenBS}</span>
                      </div>
                    </div>
                    <div className="p-4 bg-slate-50/30">
                      <p className="text-sm text-red-600 font-medium mb-3">Lỗi: {conflict.conflictReason}</p>
                      <div className="space-y-4">
                        {Object.values(groupedEvents).map((patGroup, pIdx) => (
                          <div key={pIdx} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden">
                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                            
                            {/* Patient Info */}
                            <div className="flex items-center gap-2 mb-3 pl-2 border-b border-slate-100 pb-2">
                              <Activity className="w-5 h-5 text-blue-500" />
                              <div>
                                <span className="font-bold text-slate-700">{patGroup.patientName}</span>
                                <span className="text-xs text-slate-400 font-mono ml-2">({patGroup.maLK})</span>
                              </div>
                            </div>

                            {/* Grouped Actions */}
                            <div className="pl-2 space-y-2 text-sm">
                              {patGroup.kham.length > 0 && (
                                <div className="flex items-start gap-2">
                                  <span className="font-semibold text-purple-700 whitespace-nowrap min-w-[105px]">• Công khám:</span>
                                  <span className="text-slate-600 font-medium">{patGroup.kham.join('; ')}</span>
                                </div>
                              )}
                              {patGroup.cls.length > 0 && (
                                <div className="flex items-start gap-2">
                                  <span className="font-semibold text-orange-600 whitespace-nowrap min-w-[105px]">• Cận lâm sàng:</span>
                                  <span className="text-slate-600 font-medium">{patGroup.cls.join('; ')}</span>
                                </div>
                              )}
                              {patGroup.thuoc.length > 0 && (
                                <div className="flex items-start gap-2">
                                  <span className="font-semibold text-emerald-600 whitespace-nowrap min-w-[105px]">• Thuốc:</span>
                                  <span className="text-slate-600 font-medium">{patGroup.thuoc.join('; ')}</span>
                                </div>
                              )}
                              {patGroup.kq.length > 0 && (
                                <div className="flex items-start gap-2">
                                  <span className="font-semibold text-blue-600 whitespace-nowrap min-w-[105px]">• Đọc KQ:</span>
                                  <span className="text-slate-600 font-medium">{patGroup.kq.join('; ')}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })}

              {/* RENDER PATIENT CONFLICTS */}
              {activeTab === 'PATIENT' && displayedConflicts.map((pat, idx) => (
                <div key={idx} className="bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden hover:shadow-md transition-shadow">
                  <div className="bg-orange-50/50 border-b border-orange-100 p-4 flex flex-wrap items-center justify-between gap-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Activity className="w-5 h-5" /></div>
                      <div>
                        <p className="text-xs font-bold text-orange-500 uppercase tracking-wider">Hồ sơ bệnh nhân</p>
                        <p className="text-lg font-bold text-slate-800">{pat.patientName}</p>
                        <p className="text-xs font-mono text-slate-500">Mã: {pat.maLK}</p>
                      </div>
                    </div>
                  </div>
                  <div className="p-4 bg-slate-50/30">
                    <div className="space-y-3">
                      {pat.errors.map((err, eIdx) => (
                        <div key={eIdx} className="flex gap-3 bg-white p-3 rounded-xl border border-red-100 shadow-sm items-start">
                          <XCircle className="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" />
                          <div>
                            <span className="inline-block bg-red-100 text-red-700 text-xs font-bold px-2 py-0.5 rounded mb-1">{err.type}</span>
                            <p className="text-sm text-slate-700 leading-relaxed">{err.desc}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              ))}

              {displayedConflicts.length === 0 && (
                <div className="bg-white rounded-2xl border border-dashed border-slate-300 p-12 text-center">
                  <CheckCircle className="w-16 h-16 text-emerald-400 mx-auto mb-4" />
                  <h3 className="text-lg font-bold text-slate-700">Tuyệt vời!</h3>
                  <p className="text-slate-500">Không tìm thấy lỗi cho lựa chọn này.</p>
                </div>
              )}
            </div>
          </div>
        )}
      </main>

      <style dangerouslySetInnerHTML={{__html: `
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
      `}} />
    </div>
  );
}
