import React, { useState, useEffect, useMemo } from 'react';
import { Activity, Search, CheckCircle, AlertCircle, Upload, Download, Filter, UserCheck, Users, Lock, KeyRound } from 'lucide-react';

// --- Helper Functions ---

const parseDate = (val) => {
  if (!val) return null;
  // Format YYYYMMDDHHmm (e.g., 202602071447)
  if (typeof val === 'string' || typeof val === 'number') {
    const s = val.toString().trim();
    if (s.length === 12) {
      const year = parseInt(s.substring(0, 4));
      const month = parseInt(s.substring(4, 6)) - 1;
      const day = parseInt(s.substring(6, 8));
      const hour = parseInt(s.substring(8, 10));
      const min = parseInt(s.substring(10, 12));
      return new Date(year, month, day, hour, min);
    }
    if (s.length === 8) { // YYYYMMDD
      const year = parseInt(s.substring(0, 4));
      const month = parseInt(s.substring(4, 6)) - 1;
      const day = parseInt(s.substring(6, 8));
      return new Date(year, month, day, 0, 0);
    }
  }
  return null;
};

const formatDate = (date) => {
  if (!date) return '';
  return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
};

// --- Components ---

const FileUploader = ({ label, onDataLoaded, color, isLibReady }) => {
  const [status, setStatus] = useState('idle'); // idle, loading, done, error
  const [fileName, setFileName] = useState('');

  const readExcel = (file) => {
    return new Promise((resolve, reject) => {
      if (!window.XLSX) {
        reject(new Error("Thư viện Excel chưa sẵn sàng. Vui lòng đợi giây lát."));
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = window.XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          resolve(jsonData);
        } catch (err) {
          reject(err);
        }
      };
      reader.readAsArrayBuffer(file);
    });
  };

  const handleFile = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!isLibReady) {
        alert("Đang tải thư viện xử lý Excel, vui lòng thử lại sau vài giây.");
        return;
    }

    setFileName(file.name);
    setStatus('loading');
    try {
      const data = await readExcel(file);
      onDataLoaded(data);
      setStatus('done');
    } catch (error) {
      console.error(error);
      setStatus('error');
    }
  };

  const colors = {
    blue: 'border-blue-500 text-blue-700 bg-blue-50',
    green: 'border-green-500 text-green-700 bg-green-50',
    indigo: 'border-indigo-500 text-indigo-700 bg-indigo-50',
    orange: 'border-orange-500 text-orange-700 bg-orange-50',
    gray: 'border-gray-300 text-gray-700 bg-white'
  };

  const activeColor = status === 'done' ? 'border-green-500 bg-green-50' : 'border-gray-300 bg-white';
  const labelColor = `text-${color}-600`;

  return (
    <div className={`p-4 border-2 rounded-lg border-dashed transition-colors ${activeColor}`}>
      <div className="flex justify-between items-center mb-2">
        <span className={`font-bold ${labelColor}`}>{label}</span>
        {status === 'done' && <CheckCircle className="text-green-500 w-5 h-5" />}
        {status === 'loading' && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>}
      </div>
      <input
        type="file"
        accept=".xlsx, .xls, .csv"
        onChange={handleFile}
        disabled={!isLibReady}
        className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 disabled:opacity-50"
      />
      {fileName && <p className="text-xs mt-1 text-gray-500 truncate">{fileName}</p>}
    </div>
  );
};

const DoctorSelector = ({ doctors, selectedIds, onSelectionChange }) => {
    const handleToggle = (id) => {
        const newSet = new Set(selectedIds);
        if (newSet.has(id)) newSet.delete(id);
        else newSet.add(id);
        onSelectionChange(newSet);
    };

    const toggleAll = (selectAll) => {
        if (selectAll) {
            onSelectionChange(new Set(doctors.map(d => d.id)));
        } else {
            onSelectionChange(new Set());
        }
    };

    if (doctors.length === 0) return null;

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8 animate-fade-in-up">
            <div className="flex justify-between items-center mb-4 border-b pb-2">
                <h3 className="text-lg font-bold flex items-center gap-2 text-gray-700">
                    <UserCheck className="w-5 h-5 text-indigo-600" /> 
                    Chọn Bác sĩ / Nhân viên để kiểm tra ({selectedIds.size}/{doctors.length})
                </h3>
                <div className="flex gap-2">
                    <button onClick={() => toggleAll(true)} className="text-xs bg-indigo-50 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-100 font-medium">Chọn tất cả</button>
                    <button onClick={() => toggleAll(false)} className="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded hover:bg-gray-200 font-medium">Bỏ chọn</button>
                </div>
            </div>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-60 overflow-y-auto custom-scrollbar p-1">
                {doctors.map(doc => (
                    <label key={doc.id} className={`flex items-center p-2 rounded border cursor-pointer transition-all ${selectedIds.has(doc.id) ? 'bg-indigo-50 border-indigo-300' : 'bg-white border-gray-200 hover:bg-gray-50'}`}>
                        <input 
                            type="checkbox" 
                            checked={selectedIds.has(doc.id)} 
                            onChange={() => handleToggle(doc.id)}
                            className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
                        />
                        <div className="ml-2 overflow-hidden">
                            <div className="text-sm font-medium text-gray-800 truncate" title={doc.name}>{doc.name}</div>
                            <div className="text-xs text-gray-500 font-mono truncate">{doc.id}</div>
                        </div>
                    </label>
                ))}
            </div>
        </div>
    );
};

const ErrorCard = ({ error }) => {
  return (
    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-red-500 mb-3 hover:shadow-md transition-shadow">
      <div className="flex justify-between items-start">
        <div className="flex-1">
          <h4 className="font-bold text-gray-800 flex items-center gap-2">
            {error.tenBenhNhan} 
            <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">({error.maLk})</span>
          </h4>
          <p className="text-sm text-red-600 font-semibold mt-1 flex items-start gap-1">
            <AlertCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
            {error.message}
          </p>
          <div className="mt-2 text-sm bg-gray-50 p-2 rounded">
             <div className="flex flex-col gap-1">
                <span className="text-gray-700 font-medium">{error.tenDichVu}</span>
                <div className="text-xs text-gray-500 grid grid-cols-2 gap-2 mt-1">
                    <span>BS/NV: <strong>{error.tenBacSi}</strong> ({error.maBacSi})</span>
                    <span>YL: {formatDate(error.ngayYl)}</span>
                    <span>TH: {formatDate(error.ngayThYl)}</span>
                </div>
             </div>
          </div>
        </div>
        <span className="ml-2 bg-red-100 text-red-800 text-xs font-medium px-2.5 py-1 rounded border border-red-400 whitespace-nowrap">
          {error.type}
        </span>
      </div>
    </div>
  );
};

export default function App() {
  // Authentication State
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [authError, setAuthError] = useState('');

  // App Data State
  const [table1, setTable1] = useState([]);
  const [table2, setTable2] = useState([]);
  const [table3, setTable3] = useState([]);
  const [cchn, setCchn] = useState([]);
  
  const [errors, setErrors] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [stats, setStats] = useState(null);
  const [isSheetJSReady, setIsSheetJSReady] = useState(false);

  // Doctor Filter States
  const [uniqueDoctors, setUniqueDoctors] = useState([]);
  const [selectedDoctorIds, setSelectedDoctorIds] = useState(new Set());

  // Load SheetJS
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.async = true;
    script.onload = () => setIsSheetJSReady(true);
    document.body.appendChild(script);
    return () => { document.body.removeChild(script); }
  }, []);

  // Effect to populate doctor list when data changes
  useEffect(() => {
    if (table3.length === 0) return;

    // Build map from CCHN for names
    const nameMap = {};
    cchn.forEach(row => {
        const code = row['MA CCHN'] || row['MA_CCHN'];
        const name = row['TEN BS'] || row['TEN_BS'];
        if (code) nameMap[code] = name;
    });

    // Extract unique doctors from Table 3 (MA_BAC_SI and NGUOI_THUC_HIEN)
    const doctorSet = new Set();
    const doctors = [];

    table3.forEach(row => {
        if (row.MA_BAC_SI && !doctorSet.has(row.MA_BAC_SI)) {
            doctorSet.add(row.MA_BAC_SI);
            doctors.push({ id: row.MA_BAC_SI, name: nameMap[row.MA_BAC_SI] || "Không tên" });
        }
        if (row.NGUOI_THUC_HIEN && !doctorSet.has(row.NGUOI_THUC_HIEN)) {
            doctorSet.add(row.NGUOI_THUC_HIEN);
            doctors.push({ id: row.NGUOI_THUC_HIEN, name: nameMap[row.NGUOI_THUC_HIEN] || "Không tên" });
        }
    });

    // Sort by name
    doctors.sort((a, b) => a.name.localeCompare(b.name));

    setUniqueDoctors(doctors);
    // Default to selecting ALL
    setSelectedDoctorIds(new Set(doctors.map(d => d.id)));

  }, [table3, cchn]);

  const handleLogin = (e) => {
    e.preventDefault();
    if (passwordInput === '1402') {
        setIsAuthenticated(true);
        setAuthError('');
    } else {
        setAuthError('Mật khẩu không đúng. Vui lòng thử lại.');
    }
  };

  const runAnalysis = () => {
    if (table1.length === 0 || table3.length === 0) {
      alert("Vui lòng tải lên ít nhất Bảng 1 và Bảng 3 để bắt đầu dò lỗi.");
      return;
    }

    if (selectedDoctorIds.size === 0) {
        alert("Vui lòng chọn ít nhất một bác sĩ để kiểm tra.");
        return;
    }

    setIsProcessing(true);
    setTimeout(() => {
      const detectedErrors = [];

      // 1. Indexing Data
      const patientMap = {}; 
      table1.forEach(row => {
        if (row.MA_LK) patientMap[row.MA_LK] = row.HO_TEN || "Không xác định";
      });

      const doctorMap = {}; 
      cchn.forEach(row => {
        const code = row['MA CCHN'] || row['MA_CCHN'];
        const name = row['TEN BS'] || row['TEN_BS'];
        if (code) doctorMap[code] = name || "Bác sĩ chưa có tên";
      });

      // 2. Prepare Activity Data per Doctor/Actor
      // We need to track two things per person:
      // A. "Work Blocks": Time doing execution (From TH_YL to KQ) -> Derived from NGUOI_THUC_HIEN
      // B. "Order Events": Time issuing order (NGAY_YL) -> Derived from MA_BAC_SI
      
      const doctorActivities = {};

      const addActivity = (actorId, activity) => {
        if (!actorId) return;
        if (!doctorActivities[actorId]) doctorActivities[actorId] = [];
        doctorActivities[actorId].push(activity);
      };

      // Process Table 3 (Services)
      table3.forEach((row, index) => {
        const maLk = row.MA_LK;
        const tenDv = row.TEN_DICH_VU;
        const ngayYl = parseDate(row.NGAY_YL);
        const ngayTh = parseDate(row.NGAY_TH_YL);
        const ngayKq = parseDate(row.NGAY_KQ);

        // 1. If this row has MA_BAC_SI -> They are doing an "Order Action" at NGAY_YL
        if (row.MA_BAC_SI && ngayYl && selectedDoctorIds.has(row.MA_BAC_SI)) {
            addActivity(row.MA_BAC_SI, {
                type: 'ORDER', // Y Lệnh
                maLk,
                tenDichVu: tenDv,
                time: ngayYl,
                originalRow: row
            });
        }

        // 2. If this row has NGUOI_THUC_HIEN -> They are doing a "Work Block" from NGAY_TH_YL to NGAY_KQ
        const performer = row.NGUOI_THUC_HIEN || row.MA_BAC_SI; // Fallback to doctor if explicit performer not set
        
        if (performer && ngayTh && selectedDoctorIds.has(performer)) {
            let endTime = ngayKq;
            if (!endTime || endTime < ngayTh) endTime = ngayTh; 

            addActivity(performer, {
                type: 'WORK', // Thực hiện
                maLk,
                tenDichVu: tenDv,
                start: ngayTh,
                end: endTime,
                originalRow: row
            });
        }
      });

      // 3. Detect Conflicts
      Object.keys(doctorActivities).forEach(actorId => {
        const activities = doctorActivities[actorId];
        const workBlocks = activities.filter(a => a.type === 'WORK');
        workBlocks.sort((a, b) => a.start - b.start);

        // Conflict Check 1: Work vs Work
        for (let i = 0; i < workBlocks.length; i++) {
            const current = workBlocks[i];
            for (let j = i + 1; j < workBlocks.length; j++) {
                const next = workBlocks[j];
                if (next.start > current.end) break; 

                if (next.start < current.end) {
                    if (current.maLk !== next.maLk) {
                        const tenBnGayXungDot = patientMap[current.maLk] || current.maLk;
                        const tenBnBiLoi = patientMap[next.maLk] || next.maLk;
                        
                        detectedErrors.push({
                            maLk: next.maLk,
                            maBacSi: actorId,
                            tenBenhNhan: tenBnBiLoi,
                            tenBacSi: doctorMap[actorId] || actorId,
                            type: 'Chồng chéo thực hiện',
                            message: `Xung đột với BN ${tenBnGayXungDot}. Đang thực hiện "${current.tenDichVu}" (${formatDate(current.start)}-${formatDate(current.end)}) thì lại làm "${next.tenDichVu}" cho người khác.`,
                            tenDichVu: next.tenDichVu,
                            ngayYl: next.start,
                            ngayThYl: next.end
                        });
                    }
                }
            }
        }

        // Conflict Check 2: Work vs Order
        const orders = activities.filter(a => a.type === 'ORDER');
        workBlocks.forEach(work => {
            orders.forEach(order => {
                if (order.time >= work.start && order.time <= work.end) {
                    if (work.maLk !== order.maLk) {
                        const tenBnDangLam = patientMap[work.maLk] || work.maLk;
                        const tenBnRaLenh = patientMap[order.maLk] || order.maLk;

                        detectedErrors.push({
                            maLk: order.maLk,
                            maBacSi: actorId,
                            tenBenhNhan: tenBnRaLenh,
                            tenBacSi: doctorMap[actorId] || actorId,
                            type: 'Y lệnh chen ngang',
                            message: `Đang thực hiện "${work.tenDichVu}" cho BN ${tenBnDangLam} (${formatDate(work.start)}-${formatDate(work.end)}) mà lại ra Y lệnh cho BN này.`,
                            tenDichVu: order.tenDichVu,
                            ngayYl: order.time,
                            ngayThYl: order.time
                        });
                    }
                }
            });
        });

      });

      // 4. Check Drug Sequence (Table 2)
      const patientExams = {};
      table3.forEach(row => {
        if (row.MA_NHOM === 13 || (row.TEN_DICH_VU && row.TEN_DICH_VU.toLowerCase().includes("khám"))) {
          if (!patientExams[row.MA_LK]) patientExams[row.MA_LK] = [];
          patientExams[row.MA_LK].push({
            start: parseDate(row.NGAY_YL),
            end: parseDate(row.NGAY_KQ) || parseDate(row.NGAY_TH_YL)
          });
        }
      });

      table2.forEach(row => {
        if (!selectedDoctorIds.has(row.MA_BAC_SI)) return;

        const drugTime = parseDate(row.NGAY_YL);
        const maLk = row.MA_LK;
        const exams = patientExams[maLk];

        if (drugTime && exams) {
          const validSequence = exams.some(exam => drugTime >= exam.start);
          if (!validSequence) {
            detectedErrors.push({
              maLk,
              maBacSi: row.MA_BAC_SI,
              tenBenhNhan: patientMap[maLk] || maLk,
              tenBacSi: doctorMap[row.MA_BAC_SI] || row.MA_BAC_SI,
              type: 'Sai trình tự',
              message: 'Cấp thuốc TRƯỚC thời gian khám bệnh',
              tenDichVu: row.TEN_THUOC,
              ngayYl: drugTime,
              ngayThYl: drugTime
            });
          }
        }
      });

      setErrors(detectedErrors);
      setStats({
        totalErrors: detectedErrors.length,
        totalPatients: Object.keys(patientMap).length,
        totalServices: table3.length,
        totalDrugs: table2.length
      });
      setIsProcessing(false);
    }, 500);
  };

  const downloadErrors = () => {
    if (!window.XLSX) return;
    const worksheet = window.XLSX.utils.json_to_sheet(errors.map(e => ({
      "Mã LK": e.maLk,
      "Tên Bệnh Nhân": e.tenBenhNhan,
      "Mã Bác Sĩ / NV": e.maBacSi,
      "Tên Bác Sĩ / NV": e.tenBacSi,
      "Loại Lỗi": e.type,
      "Nội Dung Lỗi": e.message,
      "Dịch Vụ/Thuốc": e.tenDichVu,
      "Ngày Y Lệnh": formatDate(e.ngayYl),
      "Ngày Thực Hiện": formatDate(e.ngayThYl)
    })));
    const workbook = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(workbook, worksheet, "DanhSachLoi");
    window.XLSX.writeFile(workbook, "KetQuaKiemTraBHYT.xlsx");
  };

  // --- LOGIN SCREEN RENDER ---
  if (!isAuthenticated) {
      return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
              <div className="text-center mb-8">
                 <div className="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                    <Lock className="w-8 h-8 text-white" />
                 </div>
                 <h1 className="text-2xl font-bold text-gray-800">Hệ Thống Dò Lỗi BHYT</h1>
                 <p className="text-gray-500 mt-2 text-sm">Vui lòng nhập mật khẩu để truy cập hệ thống</p>
              </div>
              
              <form onSubmit={handleLogin} className="space-y-5">
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <KeyRound className="h-5 w-5 text-gray-400" />
                  </div>
                  <input 
                    type="password" 
                    value={passwordInput}
                    onChange={(e) => { setPasswordInput(e.target.value); setAuthError(''); }}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all text-gray-700 bg-gray-50 focus:bg-white"
                    placeholder="Mật khẩu truy cập..."
                    autoFocus
                  />
                </div>
                
                {authError && (
                    <div className="flex items-center gap-2 text-red-600 bg-red-50 p-3 rounded-lg text-sm animate-pulse">
                        <AlertCircle className="w-4 h-4" />
                        {authError}
                    </div>
                )}
                
                <button 
                  type="submit"
                  className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md transform hover:scale-[1.02] active:scale-[0.98]"
                >
                  Đăng Nhập
                </button>
              </form>
              <div className="mt-6 text-center">
                  <p className="text-xs text-gray-400">Phiên bản 2.0 - Bảo mật & Dữ liệu</p>
              </div>
            </div>
          </div>
      );
  }

  // --- MAIN APP RENDER ---
  return (
    <div className="min-h-screen pb-10 font-sans text-gray-800 bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-6 shadow-lg">
        <div className="container mx-auto flex justify-between items-center">
          <div>
              <h1 className="text-2xl font-bold flex items-center gap-3">
                <Activity className="w-8 h-8" />
                Hệ Thống Dò Lỗi BHYT
              </h1>
              <p className="opacity-90 mt-2 text-blue-100 text-sm max-w-2xl">
                Tự động phát hiện lỗi chồng chéo thời gian khám chữa bệnh và sai sót trình tự cấp phát thuốc.
              </p>
          </div>
          <button 
            onClick={() => setIsAuthenticated(false)}
            className="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded backdrop-blur-sm transition-colors"
          >
            Đăng xuất
          </button>
        </div>
      </div>

      <div className="container mx-auto px-4 mt-8">
        {/* Upload Section */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700">
                <Upload className="w-5 h-5" /> Tải dữ liệu đầu vào
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <FileUploader label="1. Bảng 1 (Tổng hợp)" color="blue" onDataLoaded={setTable1} isLibReady={isSheetJSReady} />
                <FileUploader label="2. Bảng 2 (Thuốc)" color="green" onDataLoaded={setTable2} isLibReady={isSheetJSReady} />
                <FileUploader label="3. Bảng 3 (Dịch vụ)" color="indigo" onDataLoaded={setTable3} isLibReady={isSheetJSReady} />
                <FileUploader label="4. CCHN (Nhân sự)" color="orange" onDataLoaded={setCchn} isLibReady={isSheetJSReady} />
            </div>
        </div>

        {/* Doctor Selector */}
        {uniqueDoctors.length > 0 && (
            <DoctorSelector 
                doctors={uniqueDoctors} 
                selectedIds={selectedDoctorIds} 
                onSelectionChange={setSelectedDoctorIds} 
            />
        )}

        {/* Action Bar */}
        <div className="flex justify-center mb-8">
          <button
            onClick={runAnalysis}
            disabled={isProcessing || !isSheetJSReady || table3.length === 0}
            className={`px-8 py-3 rounded-full font-bold text-white shadow-lg flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95 ${
              isProcessing || !isSheetJSReady ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 hover:shadow-blue-200'
            }`}
          >
            {isProcessing ? (
              <><div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-2"></div> Đang xử lý...</>
            ) : (
              <><Search className="w-5 h-5" /> Bắt đầu Dò Lỗi</>
            )}
          </button>
        </div>

        {/* Statistics Dashboard */}
        {stats && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 animate-fade-in-up">
            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
              <div className="text-gray-500 text-sm font-semibold uppercase tracking-wider">Bệnh Nhân</div>
              <div className="text-2xl font-bold text-gray-800">{stats.totalPatients.toLocaleString()}</div>
            </div>
            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-indigo-500">
              <div className="text-gray-500 text-sm font-semibold uppercase tracking-wider">Dịch Vụ</div>
              <div className="text-2xl font-bold text-gray-800">{stats.totalServices.toLocaleString()}</div>
            </div>
            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
              <div className="text-gray-500 text-sm font-semibold uppercase tracking-wider">Thuốc</div>
              <div className="text-2xl font-bold text-gray-800">{stats.totalDrugs.toLocaleString()}</div>
            </div>
            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-red-500 bg-red-50">
              <div className="text-red-600 text-sm font-bold uppercase tracking-wider">Lỗi Phát Hiện</div>
              <div className="text-3xl font-bold text-red-600">{stats.totalErrors.toLocaleString()}</div>
            </div>
          </div>
        )}

        {/* Results Section */}
        {errors.length > 0 ? (
          <div className="space-y-4 animate-fade-in-up">
            <div className="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100">
              <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                <AlertCircle className="text-red-500" />
                Chi tiết lỗi ({errors.length})
              </h2>
              <button 
                onClick={downloadErrors} 
                className="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 flex items-center gap-2 text-sm font-semibold transition-colors shadow-sm hover:shadow"
              >
                <Download className="w-4 h-4" /> Xuất Excel
              </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {errors.map((error, idx) => (
                <ErrorCard key={idx} error={error} />
              ))}
            </div>
          </div>
        ) : (
          stats && stats.totalErrors === 0 && (
            <div className="text-center p-12 bg-white rounded-xl shadow-sm border border-green-200 animate-fade-in-up">
              <div className="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle className="w-10 h-10 text-green-600" />
              </div>
              <h3 className="text-2xl font-bold text-gray-800 mb-2">Tuyệt vời!</h3>
              <p className="text-gray-600 text-lg">Không tìm thấy lỗi logic thời gian hay chồng chéo nào cho các bác sĩ đã chọn.</p>
            </div>
          )
        )}
      </div>
    </div>
  );
}
