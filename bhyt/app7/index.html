<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Dò Lỗi BHYT</title>
    
    <!-- Màn hình loading (Hiển thị ngay lập tức khi mở file) -->
    <style>
        #app-loading {
            position: fixed; inset: 0; background: #f3f4f6; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: sans-serif; color: #374151;
        }
        .loader {
            border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-message { color: #dc2626; margin-top: 10px; max-width: 80%; text-align: center; display: none; }
    </style>

    <!-- Script kiểm tra lỗi (Chạy đầu tiên) -->
    <script>
        window.addEventListener('error', function(e) {
            const loadingDiv = document.getElementById('app-loading');
            const errorText = document.getElementById('error-message');
            if (loadingDiv && errorText) {
                errorText.style.display = 'block';
                errorText.innerText = "Lỗi tải trang: " + (e.message || "Không thể kết nối đến thư viện.");
            }
        });
    </script>

    <!-- Tailwind CSS (Phiên bản Script) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (Chuyển sang cdnjs cho ổn định) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .group-header td { padding-top: 1rem; padding-bottom: 0.5rem; border-top: 2px solid #e5e7eb; }
        .patient-group-header { background-color: #e0f2fe; }
        .patient-group-header td { color: #1e40af; font-weight: 700; border-top-color: #bfdbfe; }
        
        .time-group-header { background-color: #fef3c7; /* amber-100 */ }
        .time-group-header td { color: #92400e; /* amber-800 */ font-weight: 700; border-top-color: #fcd34d; }

        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-btn { background-color: white; color: #4b5563; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading Overlay -->
    <div id="app-loading">
        <div class="loader"></div>
        <p>Đang tải tài nguyên hệ thống...</p>
        <p id="error-message"></p>
        <button onclick="window.location.reload()" style="margin-top:20px; padding: 5px 15px; cursor: pointer; display: none;" id="reload-btn">Tải lại trang</button>
    </div>

    <div class="container mx-auto p-4 max-w-7xl flex-1 flex flex-col h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm rounded-lg p-4 mb-4 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-blue-700"><i class="fa-solid fa-file-medical-alt mr-2"></i>Dò Lỗi Khám Chữa Bệnh BHYT</h1>
                <p class="text-gray-500 text-sm mt-1">Phát hiện trùng giờ thực hiện/kết quả (Nội bộ hồ sơ & Giữa các bệnh nhân)</p>
            </div>
            <button onclick="window.location.reload()" class="text-gray-500 hover:text-blue-600 transition text-sm flex items-center gap-1">
                <i class="fa-solid fa-rotate-right"></i> Làm mới
            </button>
        </header>

        <!-- Upload Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 shrink-0">
            <div id="drop-zone-1" class="bg-white p-4 rounded-lg shadow-sm border-2 border-dashed border-gray-300 flex flex-col items-center justify-center transition-colors h-28 relative">
                <input type="file" id="file1" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFile(this, 1)">
                <div id="status-1" class="text-center pointer-events-none">
                    <i class="fa-solid fa-user-tag text-2xl text-gray-400 mb-1"></i>
                    <p class="font-semibold text-gray-600 text-sm">Tải lên Bảng 1 (Thông tin chung)</p>
                </div>
            </div>
            <div id="drop-zone-3" class="bg-white p-4 rounded-lg shadow-sm border-2 border-dashed border-gray-300 flex flex-col items-center justify-center transition-colors h-28 relative">
                <input type="file" id="file3" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFile(this, 3)">
                <div id="status-3" class="text-center pointer-events-none">
                    <i class="fa-solid fa-notes-medical text-2xl text-gray-400 mb-1"></i>
                    <p class="font-semibold text-gray-600 text-sm">Tải lên Bảng 3 (Chi tiết dịch vụ)</p>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div id="control-panel" class="hidden shrink-0 mb-4">
            <div class="flex items-center gap-4 bg-white p-3 rounded-lg shadow-sm">
                <button onclick="analyzeData()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow transition flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-magnifying-glass"></i> Phân Tích Dữ Liệu
                </button>
                <div id="loading" class="hidden"><div class="loading-spinner"></div></div>
                <div class="flex-1 text-right text-xs text-gray-500">
                    <span id="count-b1" class="font-bold text-blue-700">0</span> hồ sơ, 
                    <span id="count-b3" class="font-bold text-green-700">0</span> dịch vụ
                </div>
            </div>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="hidden flex-1 flex flex-col min-h-0 bg-white rounded-lg shadow-sm">
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 bg-gray-50 px-4 pt-4 gap-2 shrink-0">
                <button onclick="switchTab('internal')" id="tab-internal" class="tab-btn active px-4 py-2 rounded-t-lg font-semibold text-sm focus:outline-none flex items-center gap-2">
                    <i class="fa-solid fa-user"></i> Lỗi trong Hồ sơ
                </button>
                <button onclick="switchTab('cross')" id="tab-cross" class="tab-btn px-4 py-2 rounded-t-lg font-semibold text-sm focus:outline-none flex items-center gap-2">
                    <i class="fa-solid fa-users"></i> Lỗi Trùng chéo (Giữa các BN)
                </button>
            </div>

            <!-- Toolbar -->
            <div class="p-3 border-b border-gray-200 bg-white shrink-0">
                <div class="flex flex-col md:flex-row gap-3 items-center justify-between">
                    <!-- Stats Text -->
                    <div class="text-sm">
                        <span id="current-view-title" class="font-bold text-gray-700">Kết quả:</span>
                        <span id="error-count" class="font-bold text-red-600 ml-1">0</span> trường hợp
                    </div>

                    <!-- Filters -->
                    <div class="flex flex-1 gap-2 w-full md:w-auto justify-end">
                        <div class="relative w-full md:w-64">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                            <input type="text" id="filter-input" onkeyup="filterResults()" placeholder="Tìm tên BN, Mã LK..." class="w-full pl-9 pr-2 py-1.5 border rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        
                        <div class="w-full md:w-64">
                             <select id="filter-service" onchange="filterResults()" class="w-full py-1.5 px-2 border rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white">
                                <option value="">-- Tất cả dịch vụ --</option>
                            </select>
                        </div>

                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm shadow transition whitespace-nowrap">
                            <i class="fa-solid fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                </div>
                <!-- Checkboxes -->
                 <div class="flex flex-wrap justify-end gap-x-6 gap-y-2 mt-2 px-1 items-center bg-gray-50 p-2 rounded">
                    <span class="text-xs font-bold text-gray-500 uppercase mr-2">Bộ lọc:</span>
                    
                    <label class="inline-flex items-center cursor-pointer select-none">
                        <input type="checkbox" id="chk-err-th" checked onchange="filterResults()" class="rounded text-blue-600 h-4 w-4">
                        <span class="ml-1.5 text-xs font-medium text-gray-700">Trùng Thực hiện</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer select-none">
                        <input type="checkbox" id="chk-err-kq" checked onchange="filterResults()" class="rounded text-orange-600 h-4 w-4">
                        <span class="ml-1.5 text-xs font-medium text-gray-700">Trùng Kết quả</span>
                    </label>

                    <!-- Cross Tab Specific Filter -->
                    <div id="cross-filter-container" class="hidden pl-4 border-l border-gray-300 ml-2">
                         <label class="inline-flex items-center cursor-pointer select-none" title="Chỉ báo lỗi nếu 2 người làm CÙNG 1 loại dịch vụ (VD: Cùng làm Xét nghiệm máu)">
                            <input type="checkbox" id="chk-same-service" checked onchange="filterResults()" class="rounded text-purple-600 h-4 w-4">
                            <span class="ml-1.5 text-xs font-bold text-purple-700">Chỉ xét cùng Dịch vụ</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="flex-1 overflow-auto relative">
                <table class="min-w-full divide-y divide-gray-200 border-collapse">
                    <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-12">STT</th>
                            <th id="col-header-group" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Thông tin</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-32">Ngày TH YL</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-32">Ngày KQ</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-24">Mã Máy</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-32">Chi tiết lỗi</th>
                        </tr>
                    </thead>
                    <tbody id="result-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
                <div id="no-result-msg" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white bg-opacity-90">
                    <p class="text-gray-500">Không tìm thấy kết quả nào khớp với bộ lọc.</p>
                </div>
            </div>
            
            <div id="welcome-msg" class="flex-1 flex flex-col items-center justify-center p-8 text-gray-400">
                <p>Hãy tải file và bấm Phân tích để xem kết quả.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Init: Hide Loader when ready ---
        window.addEventListener('load', () => {
            // Check libraries loaded
            if (typeof XLSX === 'undefined') {
                document.getElementById('error-message').innerText = "Lỗi: Thư viện SheetJS chưa tải được. Vui lòng kiểm tra mạng.";
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('reload-btn').style.display = 'block';
                return;
            }
            
            // If Tailwind works, CSS should apply. If not, raw HTML is shown but usable.
            setTimeout(() => {
                const loader = document.getElementById('app-loading');
                if(loader) loader.style.display = 'none';
            }, 500); // Slight delay to ensure smooth transition
        });

        // --- Core Variables ---
        let dataB1 = [], dataB3 = [];
        let internalErrors = [], crossErrors = [];
        let mapMaLKtoName = {};
        let currentTab = 'internal'; 
        let allServices = new Set();

        // --- File Handling ---
        function handleFile(input, type) {
            const file = input.files[0];
            const statusDiv = document.getElementById(`status-${type}`);
            if (!file) return;

            statusDiv.innerHTML = `<i class="fa-solid fa-check-circle text-2xl text-green-500 mb-1"></i><p class="font-semibold text-gray-800 text-xs truncate w-full px-2">${file.name}</p>`;
            statusDiv.parentElement.classList.add('border-green-500', 'bg-green-50');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                try {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });

                    if (type === 1) {
                        dataB1 = jsonData;
                        document.getElementById('count-b1').innerText = dataB1.length.toLocaleString();
                        mapMaLKtoName = {};
                        dataB1.forEach(row => {
                            let ma_lk = row['MA_LK'] || row['ma_lk'];
                            let ho_ten = row['HO_TEN'] || row['ho_ten'];
                            if(ma_lk) mapMaLKtoName[String(ma_lk).trim()] = ho_ten;
                        });
                    } else {
                        dataB3 = jsonData;
                        document.getElementById('count-b3').innerText = dataB3.length.toLocaleString();
                    }

                    if (dataB3.length > 0) document.getElementById('control-panel').classList.remove('hidden');
                } catch(err) {
                    alert("Lỗi đọc file: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Analysis ---
        function analyzeData() {
            if (dataB3.length === 0) return alert("Thiếu Bảng 3!");
            const loader = document.getElementById('loading');
            loader.classList.remove('hidden');

            setTimeout(() => {
                try {
                    internalErrors = detectInternalErrors(dataB3);
                    crossErrors = detectCrossErrors(dataB3);

                    allServices = new Set();
                    [...internalErrors, ...crossErrors.flatMap(g => g.items)].forEach(i => {
                        if(i.ten_dich_vu) allServices.add(i.ten_dich_vu);
                    });
                    populateServiceFilter();

                    document.getElementById('result-section').classList.remove('hidden');
                    document.getElementById('welcome-msg').classList.add('hidden');
                    
                    switchTab(currentTab); // Refresh current view
                } catch (e) {
                    console.error(e);
                    alert("Lỗi: " + e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }, 100);
        }

        // --- Logic: Internal Errors (Same Patient) ---
        function detectInternalErrors(rows) {
            const errors = [];
            const grouped = {};
            rows.forEach((row, idx) => {
                const ma_lk = String(getKeyValue(row, ['MA_LK', 'ma_lk'])).trim();
                if(!ma_lk) return;
                if(!grouped[ma_lk]) grouped[ma_lk] = [];
                row._originalIndex = idx + 1;
                grouped[ma_lk].push(row);
            });

            for(const maLK in grouped) {
                const pRows = grouped[maLK];
                if(pRows.length < 2) continue;
                
                const timeTH = {}, timeKQ = {};
                pRows.forEach(r => {
                    const th = normalizeTime(getKeyValue(r, ['NGAY_TH_YL', 'ngay_th_yl']));
                    const kq = normalizeTime(getKeyValue(r, ['NGAY_KQ', 'ngay_kq']));
                    if(th) timeTH[th] = (timeTH[th] || 0) + 1;
                    if(kq) timeKQ[kq] = (timeKQ[kq] || 0) + 1;
                });

                pRows.forEach(r => {
                    const th = normalizeTime(getKeyValue(r, ['NGAY_TH_YL', 'ngay_th_yl']));
                    const kq = normalizeTime(getKeyValue(r, ['NGAY_KQ', 'ngay_kq']));
                    const errs = [];
                    if(th && timeTH[th] > 1) errs.push("Trùng TH");
                    if(kq && timeKQ[kq] > 1) errs.push("Trùng KQ");

                    if(errs.length > 0) {
                        errors.push({
                            ...r,
                            stt: r._originalIndex,
                            ma_lk: maLK,
                            ho_ten: mapMaLKtoName[maLK] || "",
                            ten_dich_vu: getKeyValue(r, ['TEN_DICH_VU', 'ten_dich_vu']),
                            ma_may: getKeyValue(r, ['MA_MAY', 'ma_may', 'MA_MAY_3176']),
                            ngay_th: th,
                            ngay_kq: kq,
                            error_details: errs
                        });
                    }
                });
            }
            return errors;
        }

        // --- Logic: Cross Errors (Multiple Patients) ---
        function detectCrossErrors(rows) {
            const collisions = []; // { time, type: 'TH'|'KQ', items: [rows] }
            const mapTH = {}, mapKQ = {};

            rows.forEach((row, idx) => {
                const ma_lk = String(getKeyValue(row, ['MA_LK', 'ma_lk'])).trim();
                const th = normalizeTime(getKeyValue(row, ['NGAY_TH_YL', 'ngay_th_yl']));
                const kq = normalizeTime(getKeyValue(row, ['NGAY_KQ', 'ngay_kq']));
                const rowData = {
                    ...row,
                    stt: idx + 1,
                    ma_lk: ma_lk,
                    ho_ten: mapMaLKtoName[ma_lk] || "",
                    ten_dich_vu: getKeyValue(row, ['TEN_DICH_VU', 'ten_dich_vu']),
                    ma_may: getKeyValue(row, ['MA_MAY', 'ma_may', 'MA_MAY_3176']),
                    ngay_th: th,
                    ngay_kq: kq
                };

                if(ma_lk) {
                    if(th) { if(!mapTH[th]) mapTH[th] = []; mapTH[th].push(rowData); }
                    if(kq) { if(!mapKQ[kq]) mapKQ[kq] = []; mapKQ[kq].push(rowData); }
                }
            });

            // Process TH
            for(const [time, group] of Object.entries(mapTH)) {
                if(new Set(group.map(i => i.ma_lk)).size > 1) {
                    collisions.push({ time, type: 'TH', items: group });
                }
            }
            // Process KQ
            for(const [time, group] of Object.entries(mapKQ)) {
                if(new Set(group.map(i => i.ma_lk)).size > 1) {
                    collisions.push({ time, type: 'KQ', items: group });
                }
            }

            return collisions.sort((a, b) => b.time.localeCompare(a.time));
        }

        // --- UI Logic ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const headerCol = document.getElementById('col-header-group');
            headerCol.innerText = tab === 'internal' ? "Tên Dịch Vụ" : "Tên BN & Dịch Vụ";

            const crossFilter = document.getElementById('cross-filter-container');
            if(tab === 'cross') crossFilter.classList.remove('hidden');
            else crossFilter.classList.add('hidden');

            filterResults();
        }

        function filterResults() {
            const keyword = document.getElementById('filter-input').value.toLowerCase();
            const service = document.getElementById('filter-service').value;
            const showTH = document.getElementById('chk-err-th').checked;
            const showKQ = document.getElementById('chk-err-kq').checked;
            const strictMode = document.getElementById('chk-same-service').checked;

            if (currentTab === 'internal') {
                renderInternal(internalErrors, keyword, service, showTH, showKQ);
            } else {
                renderCross(crossErrors, keyword, service, showTH, showKQ, strictMode);
            }
        }

        function renderInternal(list, keyword, service, showTH, showKQ) {
            const matchingMaLKs = new Set();
            list.forEach(item => {
                const matchKey = !keyword || (item.ten_dich_vu + item.ma_lk + item.ho_ten).toLowerCase().includes(keyword);
                const matchSvc = !service || item.ten_dich_vu === service;
                let matchType = false;
                if(showTH && item.error_details.includes("Trùng TH")) matchType = true;
                if(showKQ && item.error_details.includes("Trùng KQ")) matchType = true;

                if(matchKey && matchSvc && matchType) matchingMaLKs.add(item.ma_lk);
            });

            const filtered = list.filter(i => matchingMaLKs.has(i.ma_lk));
            document.getElementById('error-count').innerText = matchingMaLKs.size;
            renderTableInternal(filtered, service);
        }

        function renderCross(list, keyword, service, showTH, showKQ, strictMode) {
            const filteredGroups = [];
            list.forEach(group => {
                if(group.type === 'TH' && !showTH) return;
                if(group.type === 'KQ' && !showKQ) return;

                let items = group.items;
                if(service) items = items.filter(i => i.ten_dich_vu === service);
                if(keyword) items = items.filter(i => (i.ten_dich_vu + i.ma_lk + i.ho_ten).toLowerCase().includes(keyword));

                if(strictMode) {
                    const svcGroups = {};
                    items.forEach(i => {
                        if(!svcGroups[i.ten_dich_vu]) svcGroups[i.ten_dich_vu] = [];
                        svcGroups[i.ten_dich_vu].push(i);
                    });
                    items = []; 
                    for(const svc in svcGroups) {
                        const subGroup = svcGroups[svc];
                        const uniquePatients = new Set(subGroup.map(i => i.ma_lk));
                        if(uniquePatients.size > 1) items = items.concat(subGroup);
                    }
                }

                const uniquePatients = new Set(items.map(i => i.ma_lk));
                if(uniquePatients.size > 1) {
                    filteredGroups.push({ ...group, items: items, patientCount: uniquePatients.size });
                }
            });

            document.getElementById('error-count').innerText = filteredGroups.length;
            renderTableCross(filteredGroups, service);
        }

        // --- Render Helpers ---
        function renderTableInternal(list, highlightSvc) {
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = '';
            if(list.length === 0) return document.getElementById('no-result-msg').classList.remove('hidden');
            document.getElementById('no-result-msg').classList.add('hidden');

            const grouped = {};
            list.forEach(i => { if(!grouped[i.ma_lk]) grouped[i.ma_lk] = {info: i, items:[]}; grouped[i.ma_lk].items.push(i); });

            let html = '';
            let count = 0;
            for(const [maLK, g] of Object.entries(grouped)) {
                if(count++ > 200) break;
                g.items.sort((a,b) => (a.ngay_th||"").localeCompare(b.ngay_th||"") || (a.ngay_kq||"").localeCompare(b.ngay_kq||""));
                
                html += `<tr class="patient-group-header group-header"><td colspan="6" class="px-4"><i class="fa-solid fa-user-injured mr-2"></i>${g.info.ho_ten} <span class="text-sm font-normal text-gray-500">(${maLK})</span></td></tr>`;
                
                g.items.forEach(item => {
                    const isFocus = highlightSvc && item.ten_dich_vu === highlightSvc;
                    const errTH = item.error_details.includes("Trùng TH");
                    const errKQ = item.error_details.includes("Trùng KQ");
                    
                    html += `<tr class="${isFocus ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'hover:bg-gray-50 border-b border-gray-100'}">
                        <td class="px-4 py-2 text-gray-400 text-xs text-right">${item.stt}</td>
                        <td class="px-4 py-2 font-medium ${isFocus ? 'text-blue-700' : 'text-gray-700'}">${item.ten_dich_vu}</td>
                        <td class="px-4 py-2 ${errTH?'text-red-600 font-bold bg-red-50':''}">${formatDate(item.ngay_th)}</td>
                        <td class="px-4 py-2 ${errKQ?'text-orange-600 font-bold bg-orange-50':''}">${formatDate(item.ngay_kq)}</td>
                        <td class="px-4 py-2 text-gray-500 font-mono text-xs">${item.ma_may || '-'}</td>
                        <td class="px-4 py-2">${renderBadges(item.error_details)}</td>
                    </tr>`;
                });
            }
            tbody.innerHTML = html;
        }

        function renderTableCross(list, highlightSvc) {
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = '';
            if(list.length === 0) return document.getElementById('no-result-msg').classList.remove('hidden');
            document.getElementById('no-result-msg').classList.add('hidden');

            let html = '';
            let count = 0;
            list.forEach(group => {
                if(count++ > 200) return;
                const typeText = group.type === 'TH' ? 'Thực Hiện' : 'Kết Quả';
                
                html += `<tr class="time-group-header group-header">
                    <td colspan="6" class="px-4">
                        <i class="fa-regular fa-clock mr-2"></i>${formatDate(group.time)} 
                        <span class="ml-2 text-sm font-normal text-gray-600">- Trùng giờ ${typeText} giữa <span class="font-bold text-blue-600">${group.patientCount}</span> bệnh nhân</span>
                    </td>
                </tr>`;

                group.items.forEach(item => {
                    const isFocus = highlightSvc && item.ten_dich_vu === highlightSvc;
                    html += `<tr class="${isFocus ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'hover:bg-gray-50 border-b border-gray-100'}">
                        <td class="px-4 py-2 text-gray-400 text-xs text-right">${item.stt}</td>
                        <td class="px-4 py-2 text-gray-700">
                            <div class="font-bold text-blue-700 text-xs mb-0.5">${item.ho_ten} <span class="font-normal text-gray-400">(${item.ma_lk})</span></div>
                            <div class="${isFocus ? 'text-blue-600 font-bold' : ''}">${item.ten_dich_vu}</div>
                        </td>
                        <td class="px-4 py-2 ${group.type==='TH'?'text-red-600 font-bold bg-red-50':''}">${formatDate(item.ngay_th)}</td>
                        <td class="px-4 py-2 ${group.type==='KQ'?'text-orange-600 font-bold bg-orange-50':''}">${formatDate(item.ngay_kq)}</td>
                        <td class="px-4 py-2 text-gray-500 font-mono text-xs">${item.ma_may || '-'}</td>
                        <td class="px-4 py-2"><span class="text-xs bg-gray-100 px-2 py-1 rounded">Trùng ${typeText} liên BN</span></td>
                    </tr>`;
                });
            });
            tbody.innerHTML = html;
        }

        // --- Utilities ---
        function getKeyValue(obj, keys) {
            for(let k of keys) if(obj[k]!==undefined) return obj[k];
            return "";
        }
        function normalizeTime(t) {
            t = String(t || "").trim();
            return (t && t !== "0" && t.length > 8) ? t : "";
        }
        function formatDate(s) {
            if (!s || s.length < 12) return s;
            return `${s.substring(6,8)}/${s.substring(4,6)}/${s.substring(0,4)} ${s.substring(8,10)}:${s.substring(10,12)}`;
        }
        function renderBadges(errs) {
            return errs.map(e => {
                const c = e.includes("TH") ? "bg-red-100 text-red-700" : "bg-orange-100 text-orange-700";
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold ${c} mr-1">${e}</span>`;
            }).join('');
        }
        function populateServiceFilter() {
            const sel = document.getElementById('filter-service');
            sel.innerHTML = '<option value="">-- Tất cả dịch vụ --</option>';
            Array.from(allServices).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.innerText = s; sel.appendChild(opt);
            });
        }
        function exportToExcel() {
            const list = currentTab === 'internal' ? internalErrors : crossErrors.flatMap(g => g.items.map(i => ({...i, ErrorType: `Trùng ${g.type} liên BN`})));
            if(list.length === 0) return alert("Không có dữ liệu!");
            const ws = XLSX.utils.json_to_sheet(list.map(i => ({
                "STT": i.stt, "Mã LK": i.ma_lk, "Họ Tên": i.ho_ten, "Dịch Vụ": i.ten_dich_vu, 
                "Ngày TH": i.ngay_th, "Ngày KQ": i.ngay_kq, "Mã Máy": i.ma_may, "Lỗi": Array.isArray(i.error_details) ? i.error_details.join(',') : i.ErrorType
            })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Errors");
            XLSX.writeFile(wb, "BHYT_Errors.xlsx");
        }
    </script>
</body>
</html>
