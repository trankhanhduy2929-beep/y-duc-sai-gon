<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Dò Lỗi Khám Chữa Bệnh BHYT</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Modal Đăng nhập -->
    <div id="login-overlay" class="fixed inset-0 modal-overlay z-[100] flex justify-center items-center transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center transform transition-all scale-100">
            <div class="bg-indigo-50 text-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5 shadow-inner">
                <i class="fa-solid fa-shield-halved text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-slate-800">Hệ Thống Dò Lỗi</h2>
            <p class="text-slate-500 mb-6 text-sm">Nhập mã PIN (1402) để truy cập hệ thống</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none mb-4 text-center text-2xl tracking-widest transition-all bg-slate-50" placeholder="••••">
            <p id="login-error" class="text-rose-500 text-sm mb-4 hidden font-medium animate-fade-in">Mã PIN không chính xác!</p>
            <button onclick="checkLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-200">
                Đăng Nhập
            </button>
        </div>
    </div>

    <!-- Modal Xem Thêm Bệnh Nhân -->
    <div id="patient-modal" class="fixed inset-0 modal-overlay z-50 hidden flex justify-center items-center">
        <div class="bg-white w-11/12 max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col animate-fade-in overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-xl font-bold text-indigo-900" id="modal-patient-name">Tên Bệnh Nhân</h3>
                    <p class="text-sm text-slate-500 font-medium">Mã LK: <span id="modal-patient-malk" class="text-slate-700"></span></p>
                </div>
                <button onclick="closePatientModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 hover:bg-rose-100 hover:text-rose-600 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto custom-scrollbar bg-slate-50">
                <h4 class="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-timeline text-indigo-500"></i> Toàn bộ quá trình thực hiện dịch vụ (Bảng 3)
                </h4>
                <div class="space-y-3" id="modal-timeline-content">
                    <!-- Nội dung JS sinh ra -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-800 to-indigo-600 text-white shadow-lg p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                <i class="fa-solid fa-microscope text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold leading-tight">Smart Check BHYT</h1>
                <p class="text-indigo-200 text-xs">Kiểm tra thời gian thực & Chống chồng chéo</p>
            </div>
        </div>
        <button onclick="location.reload()" class="bg-white/10 hover:bg-white/20 border border-white/20 px-4 py-2 rounded-lg text-sm font-medium transition-all backdrop-blur-sm flex items-center gap-2">
            <i class="fa-solid fa-rotate-right"></i> Làm mới
        </button>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- Cột trái: Nạp Dữ Liệu -->
        <div class="w-[320px] bg-white border-r border-slate-200 flex flex-col shrink-0 overflow-y-auto custom-scrollbar shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            
            <div class="p-5 border-b border-slate-100">
                <h2 class="font-bold text-slate-800 mb-4 uppercase text-xs tracking-wider flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up text-indigo-500 text-base"></i> 1. Nạp Dữ Liệu BHYT
                </h2>
                <div class="space-y-3">
                    <div class="relative group">
                        <label class="block text-xs font-semibold text-slate-500 mb-1 ml-1">Bảng 1 (BN)</label>
                        <input type="file" id="file-b1" accept=".csv, .xls, .xlsx" class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 border border-slate-200 rounded-lg cursor-pointer transition-all">
                    </div>
                    <div class="relative group">
                        <label class="block text-xs font-semibold text-slate-500 mb-1 ml-1">Bảng 2 (Thuốc)</label>
                        <input type="file" id="file-b2" accept=".csv, .xls, .xlsx" class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 border border-slate-200 rounded-lg cursor-pointer transition-all">
                    </div>
                    <div class="relative group">
                        <label class="block text-xs font-semibold text-slate-500 mb-1 ml-1">Bảng 3 (Dịch vụ / CLS)</label>
                        <input type="file" id="file-b3" accept=".csv, .xls, .xlsx" class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 border border-slate-200 rounded-lg cursor-pointer transition-all">
                    </div>
                    <div class="relative group">
                        <label class="block text-xs font-semibold text-slate-500 mb-1 ml-1">Bảng 4 (KQ CLS)</label>
                        <input type="file" id="file-b4" accept=".csv, .xls, .xlsx" class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 border border-slate-200 rounded-lg cursor-pointer transition-all">
                    </div>
                    <div class="relative group mt-4 border-t border-slate-100 pt-3">
                        <label class="block text-xs font-semibold text-emerald-600 mb-1 ml-1"><i class="fa-solid fa-address-card mr-1"></i>DS Chứng Chỉ Hành Nghề</label>
                        <input type="file" id="file-cchn" accept=".csv, .xls, .xlsx" onchange="processCCHNFile()" class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 border border-slate-200 rounded-lg cursor-pointer transition-all">
                    </div>
                </div>
            </div>

            <div class="p-5 flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3 shrink-0">
                    <h2 class="font-bold text-slate-800 uppercase text-xs tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-user-doctor text-emerald-500 text-base"></i> 2. Chọn Bác Sĩ (Ràng Buộc)
                    </h2>
                </div>
                <div class="flex gap-2 mb-3 shrink-0">
                    <button onclick="selectAllDoctors(true)" class="flex-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 font-medium py-1.5 rounded transition">Chọn hết</button>
                    <button onclick="selectAllDoctors(false)" class="flex-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 font-medium py-1.5 rounded transition">Bỏ chọn</button>
                </div>
                <div id="doctor-list" class="flex-1 overflow-y-auto custom-scrollbar border border-slate-200 p-2 rounded-xl bg-slate-50 space-y-1 shadow-inner">
                    <div class="h-full flex flex-col items-center justify-center text-center px-4 opacity-50">
                        <i class="fa-solid fa-file-excel text-3xl mb-2"></i>
                        <p class="text-xs font-medium">Tải file CCHN để<br>hiển thị danh sách</p>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-slate-100 bg-white shrink-0">
                <button onclick="startValidation()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-[0_4px_14px_0_rgba(79,70,229,0.39)] hover:shadow-[0_6px_20px_rgba(79,70,229,0.23)] hover:-translate-y-0.5 transition-all duration-200 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-radar text-lg"></i> BẮT ĐẦU DÒ LỖI
                </button>
            </div>
        </div>

        <!-- Cột phải: Kết quả -->
        <div class="flex-1 flex flex-col bg-slate-100 relative">
            
            <!-- Loading -->
            <div id="loading-spinner" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 hidden flex-col justify-center items-center">
                <div class="relative w-20 h-20 mb-4">
                    <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                    <i class="fa-solid fa-microchip absolute inset-0 flex items-center justify-center text-indigo-600 text-2xl"></i>
                </div>
                <p class="text-lg font-bold text-slate-700" id="loading-text">Hệ thống đang quét phân tích...</p>
                <p class="text-sm text-slate-500 mt-2">Vui lòng chờ trong giây lát</p>
            </div>

            <!-- Toolbar Kết quả -->
            <div class="p-5 bg-white border-b border-slate-200 flex justify-between items-center shrink-0 shadow-sm z-10">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Báo Cáo Kiểm Trọng Lỗi</h2>
                    <p class="text-xs text-slate-500 mt-1">Lỗi được phân loại theo mã màu để dễ nhận biết</p>
                </div>
                <div class="flex gap-4">
                    <div class="bg-rose-50 border border-rose-100 px-4 py-2 rounded-lg flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-rose-100 text-rose-600 flex items-center justify-center font-bold text-lg">
                            <i class="fa-solid fa-bug"></i>
                        </div>
                        <div>
                            <p class="text-xs text-rose-600 font-semibold uppercase">Tổng Lỗi Phát Hiện</p>
                            <p class="text-xl font-bold text-rose-700 leading-none" id="error-count">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vùng List Lỗi -->
            <div class="flex-1 overflow-auto p-6 custom-scrollbar">
                <div class="max-w-7xl mx-auto space-y-4" id="results-body">
                    <!-- Trạng thái trống -->
                    <div class="bg-white rounded-2xl border border-slate-200 border-dashed p-12 text-center text-slate-400">
                        <div class="bg-slate-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-shield-cat text-4xl text-slate-300"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-600 mb-1">Chưa Có Dữ Liệu Phân Tích</h3>
                        <p class="text-sm">Hãy tải các bảng Excel và nhấn "Bắt Đầu Dò Lỗi" ở menu bên trái.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. XỬ LÝ ĐĂNG NHẬP ---
        const PWD = '1402';
        document.getElementById('password-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkLogin();
        });

        function checkLogin() {
            const input = document.getElementById('password-input').value;
            if (input === PWD) {
                const overlay = document.getElementById('login-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            } else {
                const err = document.getElementById('login-error');
                err.classList.remove('hidden');
                document.getElementById('password-input').value = '';
            }
        }

        // --- 2. BIẾN TOÀN CỤC & UTILS ---
        let docListMap = {}; 
        let globalPatientMap = {}; 
        let globalTasksByPatient = {}; // Lưu toàn bộ Bảng 3 để hiển thị Xem Thêm

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                if (!file) { resolve([]); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                        
                        const normalizedJson = json.map(row => {
                            let newRow = {};
                            for (let key in row) {
                                let newKey = key.trim().toUpperCase();
                                if(newKey === 'MA CCHN') newKey = 'MA_CCHN';
                                if(newKey === 'TEN BS') newKey = 'TEN_BS';
                                newRow[newKey] = row[key];
                            }
                            return newRow;
                        });
                        resolve(normalizedJson);
                    } catch (error) { reject(error); }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        function parseBHYTTime(timeStr) {
            if (!timeStr) return null;
            timeStr = timeStr.toString().trim();
            if (timeStr.length < 12) return null;
            const y = parseInt(timeStr.slice(0,4));
            const m = parseInt(timeStr.slice(4,6)) - 1;
            const d = parseInt(timeStr.slice(6,8));
            const h = parseInt(timeStr.slice(8,10));
            const min = parseInt(timeStr.slice(10,12));
            return new Date(y, m, d, h, min).getTime();
        }

        function formatTimeShow(timeStr) {
            if (!timeStr || timeStr.toString().length < 12) return "<span class='text-slate-400 italic'>Trống</span>";
            timeStr = timeStr.toString().trim();
            return `<b>${timeStr.slice(8,10)}:${timeStr.slice(10,12)}</b> <span class="text-[10px] text-slate-500">${timeStr.slice(6,8)}/${timeStr.slice(4,6)}</span>`;
        }
        
        // Helper map tên BS - Đã sửa để ẨN MÃ CCHN, chỉ hiện TÊN BÁC SĨ
        function getDocName(ma) {
            if (!ma) return "<span class='text-slate-400 italic'>Không rõ</span>";
            return docListMap[ma] ? `<span class="font-semibold text-slate-800">${docListMap[ma]}</span>` : `<span class="font-medium text-slate-700">${ma}</span>`;
        }

        // --- 3. GIAO DIỆN BÁC SĨ ---
        async function processCCHNFile() {
            const fileInput = document.getElementById('file-cchn');
            if (!fileInput.files.length) return;
            try {
                const data = await readExcel(fileInput.files[0]);
                const container = document.getElementById('doctor-list');
                container.innerHTML = '';
                docListMap = {};

                if (data.length === 0) {
                    container.innerHTML = '<p class="text-xs text-rose-500 text-center p-4">File rỗng hoặc sai định dạng.</p>';
                    return;
                }

                data.forEach(row => {
                    const ma = row.MA_CCHN || row.MA_BAC_SI || row.MACCHN;
                    const ten = row.TEN_BS || row.HO_TEN || row.TEN_BAC_SI;
                    if (ma && ten) {
                        docListMap[ma] = ten;
                        container.innerHTML += `
                            <label class="flex items-center gap-3 p-2 hover:bg-white rounded-lg cursor-pointer transition border border-transparent hover:border-slate-200 hover:shadow-sm">
                                <input type="checkbox" class="doctor-checkbox w-4 h-4 text-emerald-600 rounded border-slate-300 focus:ring-emerald-500" value="${ma}" checked>
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-slate-700">${ten}</span>
                                    <span class="text-[10px] text-slate-500 uppercase tracking-wider">${ma}</span>
                                </div>
                            </label>
                        `;
                    }
                });
            } catch (error) { alert("Lỗi đọc file CCHN: " + error.message); }
        }

        function selectAllDoctors(state) {
            document.querySelectorAll('.doctor-checkbox').forEach(cb => cb.checked = state);
        }

        // --- 4. THUẬT TOÁN DÒ LỖI ---
        async function startValidation() {
            const fb1 = document.getElementById('file-b1').files[0];
            const fb2 = document.getElementById('file-b2').files[0];
            const fb3 = document.getElementById('file-b3').files[0];
            const fb4 = document.getElementById('file-b4').files[0];

            if (!fb1 || !fb3) {
                alert("Bắt buộc phải có Bảng 1 và Bảng 3!");
                return;
            }

            const checkedDoctors = Array.from(document.querySelectorAll('.doctor-checkbox:checked')).map(cb => cb.value);
            if (checkedDoctors.length === 0) {
                alert("Vui lòng tick chọn ít nhất 1 Bác sĩ để kiểm tra!");
                return;
            }

            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.add('flex');

            try {
                const [t1, t2, t3, t4] = await Promise.all([ readExcel(fb1), readExcel(fb2), readExcel(fb3), readExcel(fb4) ]);

                // Map bệnh nhân
                globalPatientMap = {};
                t1.forEach(row => { if (row.MA_LK) globalPatientMap[row.MA_LK] = row.HO_TEN || 'Không rõ tên'; });

                // Lấy MA_BS_DOC_KQ từ bảng 4 đắp vào bảng 3 (dựa vào STT hoặc Dịch vụ, tạm đắp theo malk + ma_dich_vu)
                const kqMap = {};
                if (t4.length > 0) {
                    t4.forEach(r => {
                        if(r.MA_LK && r.MA_DICH_VU && r.MA_BS_DOC_KQ) {
                            kqMap[`${r.MA_LK}_${r.MA_DICH_VU}`] = r.MA_BS_DOC_KQ;
                        }
                    });
                }

                globalTasksByPatient = {};
                let errors = [];
                let errId = 1;

                // Chuẩn bị dữ liệu bảng 3
                t3.forEach((row, index) => {
                    row._id = index; // Thêm ID để phân biệt các dòng với nhau
                    row._tYL = parseBHYTTime(row.NGAY_YL);
                    row._tTH = parseBHYTTime(row.NGAY_TH_YL);
                    row._tKQ = parseBHYTTime(row.NGAY_KQ) || row._tTH; 
                    
                    // Gắn BS Đọc KQ nếu có ở Bảng 4, nếu không lấy ở Bảng 3 hoặc để trống
                    row._BS_KQ = kqMap[`${row.MA_LK}_${row.MA_DICH_VU}`] || row.MA_BS_DOC_KQ || "";

                    // Lưu toàn bộ vào DB ảo để view chi tiết
                    if(!globalTasksByPatient[row.MA_LK]) globalTasksByPatient[row.MA_LK] = [];
                    globalTasksByPatient[row.MA_LK].push(row);
                });

                // CẤU TRÚC LƯU LỖI CHUẨN MỚI
                function createStructuredError(type, checkedDocId, taskA, taskB, specificMsg) {
                    errors.push({
                        id: errId++,
                        type: type,
                        checkedDocId: checkedDocId, // BS đang bị soi
                        tA: taskA, // Task gốc
                        tB: taskB, // Task bị lồng (nếu có)
                        msg: specificMsg
                    });
                }

                let seenRowsA = new Set();

                // LẶP QUA TỪNG BÁC SĨ ĐƯỢC CHỌN (TÍNH ĐỘC LẬP)
                checkedDoctors.forEach(docId => {
                    let thTasks = []; 
                    let ylTasks = []; 
                    
                    t3.forEach(row => {
                        const performer = row.NGUOI_THUC_HIEN || row.MA_BAC_SI;
                        const prescriber = row.MA_BAC_SI;
                        
                        if (performer === docId && row._tTH) thTasks.push(row);
                        if (prescriber === docId && row._tYL) ylTasks.push(row);

                        // Lỗi trình tự (chỉ báo 1 lần cho mỗi dòng)
                        if ((performer === docId || prescriber === docId) && !seenRowsA.has(row)) {
                            seenRowsA.add(row);
                            if (row._tYL && row._tTH && row._tYL > row._tTH) {
                                createStructuredError('Trình Tự', docId, row, null, 'Ngày Y Lệnh diễn ra SAU Ngày Thực Hiện');
                            }
                            if (row._tTH && row._tKQ && row._tTH > row._tKQ) {
                                createStructuredError('Trình Tự', docId, row, null, 'Ngày Thực Hiện diễn ra SAU Ngày Kết Quả');
                            }
                        }
                    });

                    // 1. So sánh TH vs TH (Thực hiện đè lên Thực hiện)
                    for(let i = 0; i < thTasks.length - 1; i++) {
                        for(let j = i + 1; j < thTasks.length; j++) {
                            const a = thTasks[i]; const b = thTasks[j];
                            if (a === b) continue;
                            if (a.MA_DICH_VU === b.MA_DICH_VU && a.NGAY_TH_YL === b.NGAY_TH_YL && a.MA_LK === b.MA_LK) continue;
                            
                            if (a._tTH < b._tKQ && b._tTH < a._tKQ) {
                                createStructuredError('TH-TH', docId, a, b, 'Thực hiện 2 dịch vụ song song cùng lúc');
                            }
                        }
                    }

                    // 2. So sánh TH vs YL (Đang làm mà lại ra Y lệnh)
                    for(let i = 0; i < thTasks.length; i++) {
                        for(let j = 0; j < ylTasks.length; j++) {
                            const th = thTasks[i]; const yl = ylTasks[j];
                            if (th === yl) continue; 
                            
                            if (yl._tYL >= th._tTH && yl._tYL < th._tKQ) {
                                createStructuredError('TH-YL', docId, th, yl, 'Đang thực hiện dịch vụ nhưng lại ra Y Lệnh mới chen ngang');
                            }
                        }
                    }

                    // 3. Thuốc Bảng 2: Kê đơn phải sau cùng nhất (sau KQ CLS cuối cùng hoặc sau Khám bệnh)
                    if (t2.length > 0) {
                        const rxByDoc = t2.filter(r => r.MA_BAC_SI === docId);
                        
                        // Tìm dịch vụ có thời gian trễ nhất (KQ CLS hoặc TH Khám) của BN do BS này phụ trách
                        const latestTaskByPatient = {};
                        
                        t3.forEach(row => {
                            if (row.MA_BAC_SI === docId || row.NGUOI_THUC_HIEN === docId || row._BS_KQ === docId) {
                                const taskMaxTime = Math.max(row._tKQ || 0, row._tTH || 0, row._tYL || 0);
                                if (taskMaxTime > 0) {
                                    if (!latestTaskByPatient[row.MA_LK] || taskMaxTime > latestTaskByPatient[row.MA_LK].maxTime) {
                                        latestTaskByPatient[row.MA_LK] = {
                                            task: row,
                                            maxTime: taskMaxTime
                                        };
                                    }
                                }
                            }
                        });

                        rxByDoc.forEach(rx => {
                            const tThuoc = parseBHYTTime(rx.NGAY_YL); // ĐÃ FIX: Chỉ lấy đúng NGAY_YL bảng 2
                            const latestData = latestTaskByPatient[rx.MA_LK];
                            
                            if (tThuoc && latestData && tThuoc < latestData.maxTime) {
                                const latestTask = latestData.task;
                                const rxFakeTask = { 
                                    MA_LK: rx.MA_LK, 
                                    TEN_DICH_VU: `Thuốc: ${rx.TEN_THUOC}`, 
                                    NGAY_YL: rx.NGAY_YL, 
                                    NGAY_TH_YL: rx.NGAY_YL, // Gắn tạm để giao diện render đồng nhất
                                    MA_BAC_SI: rx.MA_BAC_SI 
                                };
                                
                                let isKham = latestTask.MA_DICH_VU === 'Khám bệnh' || String(latestTask.TEN_DICH_VU).toLowerCase().includes('khám');
                                
                                let reasonMsg = isKham 
                                    ? `Kê đơn thuốc lúc ${formatTimeShow(rx.NGAY_YL)} trước khi hoàn tất Khám bệnh (${formatTimeShow(latestTask.NGAY_KQ || latestTask.NGAY_TH_YL || latestTask.NGAY_YL)}).`
                                    : `Kê đơn thuốc lúc ${formatTimeShow(rx.NGAY_YL)} trước khi có Kết quả Cận lâm sàng (${formatTimeShow(latestTask.NGAY_KQ || latestTask.NGAY_TH_YL)}).`;

                                createStructuredError('Thuốc Sớm', docId, latestTask, rxFakeTask, reasonMsg);
                            }
                        });
                    }

                    // --- BẮT ĐẦU ĐOẠN BỔ SUNG: KIỂM TRA CHÉO BỆNH NHÂN ---
                    // 4. KIỂM TRA CHÉO BỆNH NHÂN (Giữ logic cũ + Bổ sung luật khắt khe cho MA_BAC_SI)
                    
                    // Lấy các task mà Bác sĩ này THỰC SỰ THỰC HIỆN (từ TH_YL -> KQ). 
                    // Nếu chỉ là MA_BAC_SI (chỉ định) mà người khác thực hiện/đọc KQ thì không bị coi là "đang bận làm".
                    const docBusyTasksB3 = thTasks.filter(r => r._tKQ); // thTasks đã lọc "performer === docId" từ trước
                    let crossPatientSeen = new Set(); // Bộ nhớ tạm để tránh báo lặp

                    for (let i = 0; i < docBusyTasksB3.length; i++) {
                        const busyTask = docBusyTasksB3[i];
                        const startBusy = busyTask._tTH;
                        const endBusy = busyTask._tKQ;

                        if (startBusy > endBusy) continue;

                        // 4.1 Bảng 2: Không được có NGAY_YL thuốc của BN khác lọt vào giữa
                        t2.filter(r => r.MA_BAC_SI === docId).forEach(rx => {
                            if (rx.MA_LK === busyTask.MA_LK) return; // Bỏ qua nếu cùng 1 bệnh nhân
                            
                            const tThuoc = parseBHYTTime(rx.NGAY_YL); // ĐÃ FIX: Chỉ lấy đúng NGAY_YL bảng 2
                            if (!tThuoc) return;

                            if (tThuoc >= startBusy && tThuoc <= endBusy) {
                                const pairKey = `B2_${busyTask._id}_${rx.MA_LK}_${rx.MA_THUOC}_${tThuoc}`;
                                if (!crossPatientSeen.has(pairKey)) {
                                    crossPatientSeen.add(pairKey);
                                    const rxFakeTask = { 
                                        MA_LK: rx.MA_LK, 
                                        TEN_DICH_VU: `Thuốc: ${rx.TEN_THUOC}`, 
                                        NGAY_YL: rx.NGAY_YL, 
                                        NGAY_TH_YL: rx.NGAY_YL,
                                        MA_BAC_SI: rx.MA_BAC_SI 
                                    };
                                    createStructuredError('Chéo BN', docId, busyTask, rxFakeTask, `Đang bận thực hiện DV cho BN này nhưng lại có thời gian kê đơn thuốc (Bảng 2) cho BN khác lọt vào lúc ${formatTimeShow(rx.NGAY_YL)}`);
                                }
                            }
                        });

                        // 4.2 Bảng 3: Bất kỳ NGAY_YL, NGAY_TH_YL, NGAY_KQ của BN khác lọt vào giữa khi bác sĩ thực hiện hành động
                        t3.forEach(otherTask => {
                            if (otherTask.MA_LK === busyTask.MA_LK) return; // Bỏ qua nếu cùng 1 bệnh nhân
                            
                            // Xác định vai trò của bác sĩ trong otherTask (Bác sĩ có dính líu gì vào task này không?)
                            const isPrescriber = otherTask.MA_BAC_SI === docId;
                            const otherPerformer = otherTask.NGUOI_THUC_HIEN || otherTask.MA_BAC_SI;
                            const isPerformer = otherPerformer === docId;
                            const isReader = otherTask._BS_KQ === docId;

                            // Nếu bác sĩ không tham gia gì vào task này thì bỏ qua
                            if (!isPrescriber && !isPerformer && !isReader) return;

                            const pairKey = `B3_${Math.min(busyTask._id, otherTask._id)}_${Math.max(busyTask._id, otherTask._id)}`;
                            if (crossPatientSeen.has(pairKey)) return;

                            let conflictTime = null;
                            let actionStr = "";
                            
                            // BỔ SUNG: Nhận diện xem dịch vụ này có phải là CÔNG KHÁM không
                            const isCongKham = String(otherTask.TEN_DICH_VU).toLowerCase().includes('khám');

                            // Kiểm tra các mốc thời gian hành động của chính bác sĩ đó có lọt vào khoảng bận không
                            if (isPrescriber && isCongKham && otherTask._tYL >= startBusy && otherTask._tYL <= endBusy) {
                                conflictTime = otherTask.NGAY_YL; actionStr = "Ra Y Lệnh CÔNG KHÁM (NGAY_YL)";
                            } else if (isPrescriber && otherTask._tYL >= startBusy && otherTask._tYL <= endBusy) {
                                conflictTime = otherTask.NGAY_YL; actionStr = "Ra Y Lệnh dịch vụ (NGAY_YL)";
                            } else if (isPerformer && otherTask._tTH >= startBusy && otherTask._tTH <= endBusy) {
                                conflictTime = otherTask.NGAY_TH_YL; actionStr = "Bắt đầu thực hiện (NGAY_TH_YL)";
                            } else if (isReader && otherTask._tKQ >= startBusy && otherTask._tKQ <= endBusy) {
                                conflictTime = otherTask.NGAY_KQ; actionStr = "Đọc Kết quả (NGAY_KQ)";
                            }

                            if (conflictTime) {
                                crossPatientSeen.add(pairKey);
                                
                                let specificMsg = `Đang bận làm DV cho BN này (từ ${formatTimeShow(busyTask.NGAY_TH_YL)} đến ${formatTimeShow(busyTask.NGAY_KQ)}) nhưng lại có "${actionStr}" cho BN khác lọt vào lúc ${formatTimeShow(conflictTime)}`;
                                
                                // Đổi câu thông báo nếu phát hiện lỗi ra Y lệnh Công Khám
                                if (actionStr.includes("CÔNG KHÁM")) {
                                    specificMsg = `Đang bận thực hiện CLS/Dịch vụ cho BN này (từ ${formatTimeShow(busyTask.NGAY_TH_YL)} đến ${formatTimeShow(busyTask.NGAY_KQ)}) nhưng lại TẠO Y LỆNH CÔNG KHÁM cho BN khác lọt vào lúc ${formatTimeShow(conflictTime)}`;
                                }

                                createStructuredError('Chéo BN', docId, busyTask, otherTask, specificMsg);
                            }
                        });
                    }
                    // --- KẾT THÚC ĐOẠN BỔ SUNG ---

                });

                renderResults(errors);

            } catch (err) {
                console.error(err);
                alert("Lỗi: " + err.message);
            } finally {
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('loading-spinner').classList.remove('flex');
            }
        }

        // --- 5. RENDER UI SANG XỊN ---
        function getErrorTheme(type) {
            switch(type) {
                case 'TH-TH': return { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700', icon: 'fa-triangle-exclamation', label: 'LỖI THỰC HIỆN TRÙNG (TH - TH)' };
                case 'TH-YL': return { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', icon: 'fa-code-merge', label: 'LỖI CHÈN Y LỆNH (TH - YL)' };
                case 'Chéo BN': return { bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-700', icon: 'fa-users-slash', label: 'LỖI CHÉO BỆNH NHÂN' };
                case 'Trình Tự': return { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700', icon: 'fa-clock-rotate-left', label: 'SAI TRÌNH TỰ THỜI GIAN' };
                case 'Thuốc Sớm': return { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', icon: 'fa-capsules', label: 'CẤP THUỐC SỚM' };
                default: return { bg: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-700', icon: 'fa-bug', label: 'LỖI KHÁC' };
            }
        }

        function renderTaskDetail(task, isFocusDoc, docId) {
            if(!task) return '';
            const pName = globalPatientMap[task.MA_LK] || 'Không rõ';
            
            // Highlight bác sĩ đang bị soi - Chỉ hiển thị TÊN, không hiện MÃ CCHN
            const hl = (ma) => {
                if (!ma) return "<span class='text-slate-400 italic'>Không rõ</span>";
                const nameBS = docListMap[ma] || ma;
                return ma === docId ? `<span class="bg-yellow-200 text-yellow-900 px-1 rounded font-bold">${nameBS}</span>` : `<span class="font-semibold text-slate-800">${nameBS}</span>`;
            };

            return `
                <div class="bg-white border border-slate-200 rounded-lg p-3 shadow-sm flex-1">
                    <div class="flex justify-between items-start mb-2 border-b border-slate-100 pb-2">
                        <div>
                            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1">Bệnh nhân</span>
                            <div class="font-bold text-indigo-700">${pName}</div>
                            <div class="text-[10px] text-slate-400 font-mono">${task.MA_LK}</div>
                        </div>
                        <button onclick="openPatientModal('${task.MA_LK}', '${pName}')" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white px-2 py-1 rounded transition">
                            Xem thêm <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-[10px]"></i>
                        </button>
                    </div>
                    
                    <div class="font-semibold text-slate-800 text-sm mb-3">
                        <i class="fa-solid fa-notes-medical text-emerald-500 mr-1"></i> ${task.TEN_DICH_VU}
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-50 p-2 rounded border border-slate-100">
                            <span class="block text-[10px] text-slate-400 mb-1">Chỉ định (YL)</span>
                            <div class="mb-1">${hl(task.MA_BAC_SI)}</div>
                            <div class="text-indigo-600 bg-indigo-50 inline-block px-1 rounded">${formatTimeShow(task.NGAY_YL)}</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded border border-slate-100">
                            <span class="block text-[10px] text-slate-400 mb-1">Thực hiện</span>
                            <div class="mb-1">${hl(task.NGUOI_THUC_HIEN || task.MA_BAC_SI)}</div>
                            <div class="text-emerald-600 bg-emerald-50 inline-block px-1 rounded">${formatTimeShow(task.NGAY_TH_YL)}</div>
                            ${task.NGAY_KQ ? `<span class="mx-1 text-slate-300">➜</span><div class="text-emerald-600 bg-emerald-50 inline-block px-1 rounded mt-1">${formatTimeShow(task.NGAY_KQ)}</div>` : ''}
                        </div>
                        ${task._BS_KQ ? `
                        <div class="col-span-2 bg-slate-50 p-2 rounded border border-slate-100 flex justify-between items-center mt-1">
                            <div><span class="text-[10px] text-slate-400 mr-2">Đọc KQ:</span> ${hl(task._BS_KQ)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderResults(errors) {
            const container = document.getElementById('results-body');
            document.getElementById('error-count').innerText = errors.length;
            
            if (errors.length === 0) {
                container.innerHTML = `
                    <div class="bg-emerald-50 rounded-2xl border border-emerald-200 p-12 text-center text-emerald-600">
                        <i class="fa-solid fa-shield-check text-5xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-1">Tuyệt vời!</h3>
                        <p class="text-emerald-700/80">Không phát hiện lỗi chồng chéo hay logic thời gian nào đối với các bác sĩ đã chọn.</p>
                    </div>`;
                return;
            }

            // --- BẮT ĐẦU CẬP NHẬT: GOM NHÓM THEO BỆNH NHÂN (CROSS VÀ SINGLE) ---
            const groupedErrors = {};
            
            errors.forEach(e => {
                let gKey, type, m1, m2;
                if (e.type === 'Chéo BN') {
                    m1 = e.tA.MA_LK < e.tB.MA_LK ? e.tA.MA_LK : e.tB.MA_LK;
                    m2 = e.tA.MA_LK < e.tB.MA_LK ? e.tB.MA_LK : e.tA.MA_LK;
                    gKey = `CROSS_${m1}_${m2}`;
                    type = 'CROSS';
                } else {
                    m1 = e.tA.MA_LK;
                    gKey = `SINGLE_${m1}`;
                    type = 'SINGLE';
                }

                if (!groupedErrors[gKey]) {
                    groupedErrors[gKey] = {
                        type: type,
                        malk1: m1,
                        malk2: m2,
                        p1Name: globalPatientMap[m1] || 'Không rõ',
                        p2Name: m2 ? (globalPatientMap[m2] || 'Không rõ') : null,
                        errorCount: 0,
                        subGroups: {}
                    };
                }
                groupedErrors[gKey].errorCount++;

                // Gom những lỗi có cùng Task A lại với nhau
                const subKey = `${e.type}_${e.tA._id}_${e.tA.MA_DICH_VU}_${e.tA.NGAY_TH_YL}`;
                if (!groupedErrors[gKey].subGroups[subKey]) {
                    groupedErrors[gKey].subGroups[subKey] = {
                        type: e.type,
                        tA: e.tA,
                        checkedDocId: e.checkedDocId,
                        msg: e.msg,
                        tBs: []
                    };
                }
                
                if (e.tB) {
                    // Tránh trùng lặp các tB giống hệt nhau
                    const tBs = groupedErrors[gKey].subGroups[subKey].tBs;
                    const bIdentifier = e.tB._id ? e.tB._id : (e.tB.TEN_DICH_VU + e.tB.NGAY_TH_YL); 
                    if (!tBs.find(x => (x._id ? x._id === e.tB._id : (x.TEN_DICH_VU + x.NGAY_TH_YL) === bIdentifier))) {
                        tBs.push(e.tB);
                    }
                }
            });

            let html = '';
            let globalIdx = 1;

            // Render từng Nhóm (Cross hoặc Single)
            for (const gKey in groupedErrors) {
                const group = groupedErrors[gKey];

                if (group.type === 'CROSS') {
                    html += `
                        <div class="mb-6 bg-white border border-cyan-200 rounded-2xl shadow-sm overflow-hidden animate-fade-in">
                            <div class="bg-cyan-50/80 border-b border-cyan-200 px-5 py-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-cyan-100 text-cyan-600 flex items-center justify-center font-bold text-lg shadow-inner shrink-0">
                                        <i class="fa-solid fa-people-arrows"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-cyan-900 text-lg uppercase leading-tight">LỖI CHÉO: ${group.p1Name} <span class="text-rose-500 mx-1">VS</span> ${group.p2Name}</h3>
                                        <p class="text-xs text-slate-500 font-mono mt-0.5">${group.malk1} <span class="mx-1">&</span> ${group.malk2}</p>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="text-rose-700 bg-rose-100 border border-rose-200 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm flex items-center gap-1.5 shrink-0">
                                        <i class="fa-solid fa-bug"></i> Có ${group.errorCount} Lỗi
                                    </span>
                                    <button onclick="openPatientModal('${group.malk1}', '${group.p1Name.replace(/'/g,"\\'")}')" class="text-[11px] bg-white border border-cyan-200 text-cyan-700 hover:bg-cyan-600 hover:text-white px-2.5 py-1.5 rounded-lg transition shadow-sm font-medium flex items-center gap-1 shrink-0">
                                        <i class="fa-solid fa-timeline"></i> LS BN 1
                                    </button>
                                    <button onclick="openPatientModal('${group.malk2}', '${group.p2Name.replace(/'/g,"\\'")}')" class="text-[11px] bg-white border border-cyan-200 text-cyan-700 hover:bg-cyan-600 hover:text-white px-2.5 py-1.5 rounded-lg transition shadow-sm font-medium flex items-center gap-1 shrink-0">
                                        <i class="fa-solid fa-timeline"></i> LS BN 2
                                    </button>
                                </div>
                            </div>
                    `;
                } else {
                    html += `
                        <div class="mb-6 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden animate-fade-in">
                            <div class="bg-indigo-50/80 border-b border-indigo-100 px-5 py-3 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-lg shadow-inner shrink-0">
                                        <i class="fa-solid fa-user-injured"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-indigo-900 text-lg uppercase leading-tight">${group.p1Name}</h3>
                                        <p class="text-xs text-slate-500 font-mono mt-0.5">Mã LK: ${group.malk1}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-rose-700 bg-rose-100 border border-rose-200 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm flex items-center gap-1.5">
                                        <i class="fa-solid fa-bug"></i> Có ${group.errorCount} Lỗi
                                    </span>
                                    <button onclick="openPatientModal('${group.malk1}', '${group.p1Name.replace(/'/g,"\\'")}')" class="text-xs bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-600 hover:text-white px-3 py-1.5 rounded-lg transition shadow-sm font-medium flex items-center gap-1.5">
                                        <i class="fa-solid fa-timeline"></i> Xem lịch sử BN
                                    </button>
                                </div>
                            </div>
                    `;
                }

                html += `<div class="p-4 bg-slate-50/50 space-y-4">`;

                // Render chi tiết từng nhóm Lỗi (Task A)
                for (const subKey in group.subGroups) {
                    const sub = group.subGroups[subKey];
                    const theme = getErrorTheme(sub.type);
                    
                    let displayMsg = sub.msg;
                    if (sub.tBs.length > 1) {
                        displayMsg = `Đang bận thực hiện dịch vụ này nhưng lại bị chồng chéo với <b class="text-rose-600">${sub.tBs.length}</b> dịch vụ/y lệnh/thuốc khác.`;
                    }

                    html += `
                        <div class="bg-white rounded-xl border ${theme.border} shadow-[0_2px_10px_rgba(0,0,0,0.02)] overflow-hidden hover:shadow-md transition-all relative">
                            <!-- Đường viền mỏng bên trái để nhấn mạnh màu theo loại lỗi -->
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 ${theme.bg.replace('50', '400')}"></div>

                            <!-- Header Lỗi -->
                            <div class="${theme.bg} px-4 py-2 border-b ${theme.border} flex justify-between items-center pl-6">
                                <div class="flex items-center gap-2">
                                    <span class="bg-white/70 text-slate-600 font-mono text-[10px] px-1.5 py-0.5 rounded border ${theme.border}">STT: #${globalIdx++}</span>
                                    <i class="fa-solid ${theme.icon} ${theme.text} ml-1"></i>
                                    <span class="font-bold text-sm ${theme.text}">${theme.label}</span>
                                </div>
                                <span class="text-xs bg-white/70 px-2 py-1 rounded text-slate-600 font-medium border ${theme.border}">
                                    Phát hiện ở BS: <span class="font-bold text-slate-800">${getDocName(sub.checkedDocId)}</span>
                                </span>
                            </div>
                            
                            <!-- Lời giải thích lỗi -->
                            <div class="px-5 py-3 bg-slate-50/50 border-b border-slate-100 flex items-start gap-3 pl-6">
                                <i class="fa-solid fa-circle-info text-slate-400 mt-0.5"></i>
                                <p class="text-sm font-medium text-slate-700 leading-relaxed">${displayMsg}</p>
                            </div>

                            <!-- Cột Dịch vụ -->
                            <div class="p-4 flex flex-col md:flex-row gap-4 bg-white relative pl-6">
                                <div class="flex-1 min-w-0">
                                    ${renderTaskDetail(sub.tA, true, sub.checkedDocId)}
                                </div>
                                
                                ${sub.tBs.length > 0 ? `
                                <div class="hidden md:flex flex-col justify-center items-center px-1">
                                    <div class="w-8 h-8 rounded-full ${theme.bg} ${theme.text} flex items-center justify-center font-black text-xs border ${theme.border} shadow-sm z-10">VS</div>
                                </div>
                                <div class="flex-1 min-w-0 flex flex-col gap-2">
                                    ${sub.tBs.map(tB => renderTaskDetail(tB, true, sub.checkedDocId)).join('')}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // --- 6. MODAL XEM THÊM (TIMELINE BỆNH NHÂN) ---
        function openPatientModal(malk, name) {
            document.getElementById('modal-patient-name').innerText = name;
            document.getElementById('modal-patient-malk').innerText = malk;
            
            const tasks = globalTasksByPatient[malk] || [];
            // Sort theo thời gian sớm nhất (YL hoặc TH)
            tasks.sort((a, b) => {
                const tA = a._tTH || a._tYL || 0;
                const tB = b._tTH || b._tYL || 0;
                return tA - tB;
            });

            let html = '';
            tasks.forEach((t, i) => {
                html += `
                    <div class="bg-white border border-slate-200 rounded-lg p-3 shadow-sm hover:border-indigo-300 transition-colors flex gap-4 items-stretch relative">
                        <div class="flex flex-col items-center justify-center w-12 shrink-0 border-r border-slate-100 pr-4">
                            <span class="text-[10px] text-slate-400 font-bold">STT</span>
                            <span class="text-lg font-bold text-slate-700">${i+1}</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-800 mb-2">${t.TEN_DICH_VU}</div>
                            <div class="grid grid-cols-3 gap-4 text-xs">
                                <div>
                                    <p class="text-[10px] text-slate-400 mb-0.5">Y Lệnh (BS Khám)</p>
                                    <p>${getDocName(t.MA_BAC_SI)}</p>
                                    <p class="text-indigo-600 font-medium">${formatTimeShow(t.NGAY_YL)}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] text-slate-400 mb-0.5">Thực Hiện</p>
                                    <p>${getDocName(t.NGUOI_THUC_HIEN || t.MA_BAC_SI)}</p>
                                    <p class="text-emerald-600 font-medium">Bắt đầu: ${formatTimeShow(t.NGAY_TH_YL)}</p>
                                    <p class="text-emerald-600 font-medium">Kết thúc: ${formatTimeShow(t.NGAY_KQ)}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] text-slate-400 mb-0.5">Đọc Kết Quả</p>
                                    <p>${getDocName(t._BS_KQ)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('modal-timeline-content').innerHTML = html || '<p class="text-slate-500 italic">Không có dữ liệu chi tiết.</p>';
            
            const modal = document.getElementById('patient-modal');
            modal.classList.remove('hidden');
        }

        function closePatientModal() {
            document.getElementById('patient-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
