<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Rà Soát BHYT Thông Minh v2.1</title>
    
    <!-- Thư viện giao diện & Icon -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Thư viện xử lý Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font chữ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Glassmorphism Classes */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(0, 0, 0, 0.4);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .modal-open { overflow: hidden; }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- PHẦN 1: MÀN HÌNH ĐĂNG NHẬP -->
    <div id="loginSection" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?auto=format&fit=crop&q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        <div class="relative glass p-10 rounded-2xl w-full max-w-md text-center animate-fade-in mx-4">
            <div class="mb-6">
                <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                    <i class="fas fa-shield-virus text-2xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">BHYT Audit Pro</h1>
                <p class="text-slate-400 text-sm">Hệ thống rà soát hồ sơ tự động</p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="password" id="passwordInput" placeholder="Nhập mã bảo mật (1402)" 
                        class="glass-input w-full py-3 pl-10 pr-4 rounded-xl text-sm placeholder-slate-500">
                </div>
                <button onclick="checkLogin()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600 text-white font-bold py-3 rounded-xl transition-all shadow-lg transform hover:scale-[1.02]">
                    Đăng Nhập Hệ Thống
                </button>
                <p id="loginError" class="text-red-400 text-xs mt-2 hidden"><i class="fas fa-exclamation-circle"></i> Mật khẩu không đúng</p>
            </div>
        </div>
    </div>

    <!-- PHẦN 2: GIAO DIỆN CHÍNH -->
    <div id="appSection" class="hidden min-h-screen p-4 md:p-8">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 glass p-4 rounded-2xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fas fa-stethoscope text-white"></i>
                </div>
                <div>
                    <h2 class="font-bold text-xl text-white">BHYT Auditor v2.1</h2>
                    <p class="text-xs text-slate-400">Cập nhật: Bổ sung logic Tai Mũi Họng & Chi tiết lỗi</p>
                </div>
            </div>
            <button onclick="logout()" class="text-slate-400 hover:text-white transition">
                <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT: Upload Control -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Bảng 1 -->
                <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-blue-400 text-sm">Bảng 1 (Tổng hợp)</h3>
                        <span id="statusB1" class="text-[10px] px-2 py-1 rounded bg-slate-700 text-slate-400">Chưa tải</span>
                    </div>
                    <label class="block w-full text-center p-4 border border-dashed border-slate-600 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                        <i class="fas fa-file-upload text-xl text-slate-500 mb-1"></i>
                        <span class="text-xs text-slate-400 block">Chọn file .xlsx/.csv</span>
                        <input type="file" id="fileB1" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFile(this, 'B1')" />
                    </label>
                </div>

                <!-- Bảng 3 -->
                <div class="glass p-5 rounded-2xl border-l-4 border-purple-500">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-purple-400 text-sm">Bảng 3 (Dịch vụ)</h3>
                        <span id="statusB3" class="text-[10px] px-2 py-1 rounded bg-slate-700 text-slate-400">Chưa tải</span>
                    </div>
                    <label class="block w-full text-center p-4 border border-dashed border-slate-600 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                        <i class="fas fa-file-upload text-xl text-slate-500 mb-1"></i>
                        <span class="text-xs text-slate-400 block">Chọn file .xlsx/.csv</span>
                        <input type="file" id="fileB3" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFile(this, 'B3')" />
                    </label>
                </div>

                <button onclick="processData()" id="btnProcess" disabled 
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-500 transition-all">
                    TIẾN HÀNH RÀ SOÁT
                </button>
                
                <div id="quickStats" class="hidden grid grid-cols-2 gap-2">
                    <div class="glass p-3 rounded-lg text-center">
                        <p class="text-slate-400 text-[10px]">Hồ sơ</p>
                        <p id="totalRecords" class="text-lg font-bold text-white">0</p>
                    </div>
                    <div class="glass p-3 rounded-lg text-center border border-red-500/30">
                        <p class="text-red-400 text-[10px]">Lỗi</p>
                        <p id="totalErrors" class="text-lg font-bold text-red-500">0</p>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Result Table -->
            <div class="lg:col-span-9 glass p-6 rounded-2xl flex flex-col h-[85vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg"><i class="fas fa-clipboard-check mr-2 text-blue-400"></i>Kết Quả Rà Soát</h3>
                    <div class="flex gap-2">
                        <input type="text" id="searchInput" placeholder="Tìm tên bệnh nhân..." onkeyup="filterTable()" 
                            class="glass-input py-1.5 px-3 rounded-lg text-sm w-64">
                        <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded-lg text-sm transition font-medium">
                            <i class="fas fa-file-export mr-1"></i> Xuất Excel
                        </button>
                    </div>
                </div>

                <div class="overflow-auto flex-1 rounded-xl border border-slate-700 bg-slate-900/50">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-800 text-xs uppercase text-slate-400 sticky top-0 z-10 shadow-lg">
                            <tr>
                                <th class="p-4 w-1/5">Thông tin Bệnh nhân</th>
                                <th class="p-4 w-1/6">Thời gian khám</th>
                                <th class="p-4 w-1/2">Chi tiết Lỗi & Hướng xử lý</th>
                                <th class="p-4 w-1/6 text-center">Tác vụ</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="text-sm divide-y divide-slate-700">
                            <tr>
                                <td colspan="4" class="p-12 text-center text-slate-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-cloud-upload-alt text-4xl mb-3 opacity-50"></i>
                                        <span>Vui lòng tải dữ liệu và nhấn nút Rà Soát</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CHI TIẾT BỆNH NHÂN -->
    <div id="detailModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-2xl glass-panel shadow-2xl transform transition-transform duration-300 translate-x-full" id="modalContent">
            
            <!-- Modal Header -->
            <div class="h-16 flex items-center justify-between px-6 border-b border-slate-700 bg-slate-800/50">
                <h2 class="text-lg font-bold text-white flex items-center">
                    <i class="fas fa-id-card mr-3 text-blue-400"></i>
                    Chi Tiết Hồ Sơ
                </h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="overflow-y-auto h-[calc(100vh-64px)] p-6 space-y-6">
                
                <!-- Thông tin chính -->
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <h3 class="text-xs font-bold text-blue-400 uppercase mb-3">Thông tin hành chính (Bảng 1)</h3>
                    <div id="modalInfo" class="grid grid-cols-2 gap-4 text-sm">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Danh sách dịch vụ -->
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <h3 class="text-xs font-bold text-purple-400 uppercase mb-3 flex justify-between">
                        <span>Dịch vụ đã dùng (Bảng 3)</span>
                        <span id="serviceCount" class="bg-purple-900 text-purple-200 px-2 rounded text-[10px]">0</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="text-slate-400 border-b border-slate-700">
                                <tr>
                                    <th class="py-2 text-left">Mã DV</th>
                                    <th class="py-2 text-left">Tên Dịch Vụ</th>
                                    <th class="py-2 text-right">Số lượng</th>
                                </tr>
                            </thead>
                            <tbody id="modalServices" class="divide-y divide-slate-700/50 text-slate-300">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Logic Javascript -->
    <script>
        // --- 1. CONFIG & VARS ---
        let rawDataB1 = [];
        let rawDataB3 = [];
        let processedResults = [];
        let mapB3 = {}; // Global Map for quick access

        // --- 2. AUTH ---
        const passwordInput = document.getElementById('passwordInput');
        passwordInput.addEventListener("keypress", (e) => { if (e.key === "Enter") checkLogin(); });

        function checkLogin() {
            if (document.getElementById('passwordInput').value === '1402') {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('animate-fade-in');
            } else {
                const err = document.getElementById('loginError');
                err.classList.remove('hidden');
                setTimeout(() => err.classList.add('hidden'), 2000);
            }
        }
        function logout() { location.reload(); }

        // --- 3. EXCEL HANDLING ---
        function handleFile(input, type) {
            const file = input.files[0];
            const statusLabel = document.getElementById(`status${type}`);
            if (!file) return;

            statusLabel.innerText = "Đang đọc...";
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});

                if (type === 'B1') rawDataB1 = jsonData;
                else rawDataB3 = jsonData;

                statusLabel.innerText = `OK (${jsonData.length} dòng)`;
                statusLabel.className = "text-[10px] px-2 py-1 rounded bg-emerald-600 text-white";
                checkReady();
            };
            reader.readAsArrayBuffer(file);
        }

        function checkReady() {
            if (rawDataB1.length > 0 && rawDataB3.length > 0) {
                document.getElementById('btnProcess').disabled = false;
            }
        }

        // --- 4. CORE LOGIC ---
        function processData() {
            const btn = document.getElementById('btnProcess');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...`;
            btn.disabled = true;

            setTimeout(() => {
                processedResults = [];
                let errorCount = 0;

                // Index Bảng 3
                mapB3 = {};
                rawDataB3.forEach(row => {
                    const maLk = String(row['MA_LK']).trim();
                    if (!mapB3[maLk]) mapB3[maLk] = [];
                    mapB3[maLk].push(row);
                });

                rawDataB1.forEach(row => {
                    let errors = [];
                    const maLk = String(row['MA_LK'] || "").trim();
                    
                    // --- Helper để tạo message lỗi chi tiết ---
                    const addError = (msg, current, fix) => {
                        errors.push({ msg, current, fix });
                    };

                    // A. Check bắt buộc
                    const requiredFields = [
                        'HO_TEN', 'MA_BN', 'NGAY_SINH', 'GIOI_TINH', 'DIA_CHI', 
                        'MA_THE_BHYT', 'MA_DKBD', 'GT_THE_TU', 'GT_THE_DEN', 
                        'LY_DO_VV', 'CHAN_DOAN_VAO', 'CHAN_DOAN_RV', 
                        'MA_BENH_CHINH', 'MA_DOITUONG_KCB', 'CAN_NANG'
                    ];

                    requiredFields.forEach(field => {
                        let val = row[field];
                        if (val === undefined || val === null || String(val).trim() === "") {
                            addError(`Thiếu thông tin cột [${field}]`, "Trống", "Bổ sung dữ liệu");
                        }
                    });

                    // B. Lý do vào viện (Chữ)
                    const lyDo = String(row['LY_DO_VV'] || "");
                    if (!/[a-zA-Z\u00C0-\u1EF9]/.test(lyDo)) {
                        addError("Lý do vào viện sai định dạng", lyDo, "Phải chứa ký tự chữ cái");
                    }

                    // C. Giới tính
                    const gioiTinh = String(row['GIOI_TINH']).trim();
                    if (gioiTinh !== '1' && gioiTinh !== '2') {
                        addError("Mã giới tính sai", gioiTinh, "Chỉ nhập 1 (Nam) hoặc 2 (Nữ)");
                    }

                    // D. Ngày tháng
                    const cleanDate = (d) => String(d || "").substring(0, 8);
                    const ngayVao = cleanDate(row['NGAY_VAO']);
                    const ngayRa = cleanDate(row['NGAY_RA']);
                    const ngayTToan = cleanDate(row['NGAY_TTOAN']);

                    if (ngayVao && ngayRa && ngayTToan) {
                        if (ngayVao !== ngayRa || ngayVao !== ngayTToan) {
                            addError("Ngày Vào - Ra - Thanh toán không trùng khớp", 
                                `Vào:${ngayVao}, Ra:${ngayRa}, TT:${ngayTToan}`, 
                                "Chỉnh sửa 3 cột ngày phải cùng 1 ngày");
                        }
                    } else {
                        addError("Thiếu dữ liệu ngày tháng", "Trống", "Kiểm tra NGAY_VAO, NGAY_RA, NGAY_TTOAN");
                    }

                    // E. Logic Tuổi & Dịch vụ (UPDATE MỚI)
                    let ageInfo = "N/A";
                    let dobFormatted = row['NGAY_SINH'];
                    
                    if (row['NGAY_SINH'] && row['NGAY_VAO']) {
                        const dobStr = String(row['NGAY_SINH']);
                        const visitStr = String(row['NGAY_VAO']);
                        
                        // Parse Date
                        const dobDate = new Date(dobStr.substring(0, 4), parseInt(dobStr.substring(4, 6))-1, dobStr.substring(6, 8));
                        const visitDate = new Date(visitStr.substring(0, 4), parseInt(visitStr.substring(4, 6))-1, visitStr.substring(6, 8));

                        // Calculate Age
                        let age = visitDate.getFullYear() - dobDate.getFullYear();
                        const m = visitDate.getMonth() - dobDate.getMonth();
                        if (m < 0 || (m === 0 && visitDate.getDate() < dobDate.getDate())) age--;
                        
                        ageInfo = age;

                        // Check Services
                        const services = mapB3[maLk] || [];
                        const hasKhamNhi = services.some(s => String(s['TEN_DICH_VU'] || "").toLowerCase().includes('khám nhi'));
                        const hasTaiMuiHong = services.some(s => String(s['TEN_DICH_VU'] || "").toLowerCase().includes('khám tai mũi họng'));

                        if (age < 16) {
                            if (!hasKhamNhi && !hasTaiMuiHong) {
                                addError(`Bệnh nhân ${age} tuổi (Dưới 16)`, 
                                    "Không có công khám phù hợp", 
                                    "Bổ sung 'Khám Nhi' HOẶC 'Khám Tai Mũi Họng'");
                            }
                        } else {
                            if (hasKhamNhi) {
                                addError(`Bệnh nhân ${age} tuổi (Trên 16)`, 
                                    "Có dịch vụ 'Khám Nhi'", 
                                    "Xóa dịch vụ Khám Nhi");
                            }
                        }
                    }

                    if (errors.length > 0) {
                        errorCount++;
                        processedResults.push({
                            rawData: row, // Giữ lại row gốc để show modal
                            maLk: maLk,
                            hoTen: row['HO_TEN'],
                            ngayVao: row['NGAY_VAO'],
                            ngaySinh: row['NGAY_SINH'],
                            tuoi: ageInfo,
                            gioiTinh: gioiTinh === '1' ? 'Nam' : 'Nữ',
                            errors: errors
                        });
                    }
                });

                renderResults(processedResults);
                
                // Update stats
                document.getElementById('quickStats').classList.remove('hidden');
                document.getElementById('totalRecords').innerText = rawDataB1.length;
                document.getElementById('totalErrors').innerText = errorCount;

                btn.innerHTML = `RÀ SOÁT LẠI`;
                btn.disabled = false;
            }, 100);
        }

        // --- 5. RENDER UI ---
        function renderResults(data) {
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-emerald-400 font-bold"><i class="fas fa-check-circle text-4xl mb-3 block"></i>Tuyệt vời! Không phát hiện lỗi nào.</td></tr>`;
                return;
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/50 transition-colors border-b border-slate-700/50";
                
                // Build Error HTML
                const errorHtml = item.errors.map(e => `
                    <div class="mb-2 pb-2 border-b border-white/5 last:border-0 last:pb-0">
                        <div class="text-red-400 font-semibold text-xs flex items-center">
                            <i class="fas fa-exclamation-triangle mr-1.5"></i> ${e.msg}
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-1 text-[11px]">
                            <span class="text-slate-400">Hiện tại: <span class="text-slate-200">${e.current}</span></span>
                            <span class="text-emerald-400">Cần sửa: ${e.fix}</span>
                        </div>
                    </div>
                `).join('');

                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-white text-base">${item.hoTen}</div>
                        <div class="text-xs text-slate-400 mt-1">
                            <span class="bg-slate-700 px-1.5 py-0.5 rounded text-slate-300 mr-2">${item.gioiTinh}</span>
                            <span>${item.tuoi} tuổi</span>
                        </div>
                        <div class="text-[10px] text-slate-500 mt-1 font-mono">NS: ${item.ngaySinh}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-sm text-slate-300"><i class="far fa-clock mr-1"></i>Vào: ${item.ngayVao}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="bg-red-500/5 border border-red-500/10 rounded-lg p-3">
                            ${errorHtml}
                        </div>
                    </td>
                    <td class="p-4 align-top text-center">
                        <button onclick="showDetail(${index})" class="bg-blue-600/20 hover:bg-blue-600 hover:text-white text-blue-400 border border-blue-500/30 rounded-lg px-3 py-2 text-xs transition-all flex items-center justify-center mx-auto gap-2">
                            <i class="fas fa-eye"></i> Xem chi tiết
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 6. MODAL DETAIL ---
        function showDetail(index) {
            const item = processedResults[index];
            const maLk = item.maLk;
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');
            const services = mapB3[maLk] || [];

            // 1. Fill Info Bảng 1
            const infoContainer = document.getElementById('modalInfo');
            infoContainer.innerHTML = Object.entries(item.rawData).map(([key, val]) => `
                <div class="flex flex-col border-b border-slate-700/50 pb-1">
                    <span class="text-[10px] text-slate-500 uppercase">${key}</span>
                    <span class="text-white font-mono truncate" title="${val}">${val}</span>
                </div>
            `).join('');

            // 2. Fill Services Bảng 3
            document.getElementById('serviceCount').innerText = services.length;
            const serviceBody = document.getElementById('modalServices');
            if (services.length === 0) {
                serviceBody.innerHTML = `<tr><td colspan="3" class="py-4 text-center text-slate-500">Không tìm thấy dịch vụ trong Bảng 3</td></tr>`;
            } else {
                serviceBody.innerHTML = services.map(s => `
                    <tr>
                        <td class="py-2 text-slate-400 font-mono">${s['MA_DICH_VU']}</td>
                        <td class="py-2 text-white">${s['TEN_DICH_VU']}</td>
                        <td class="py-2 text-right font-mono text-emerald-400">${s['SO_LUONG']}</td>
                    </tr>
                `).join('');
            }

            // 3. Show Modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-x-full');
            }, 10);
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            const content = document.getElementById('modalContent');
            content.classList.add('translate-x-full');
            setTimeout(() => {
                document.getElementById('detailModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        // --- 7. UTILS ---
        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = processedResults.filter(item => item.hoTen.toLowerCase().includes(term));
            renderResults(filtered);
        }

        function exportToExcel() {
            if (processedResults.length === 0) return alert("Không có dữ liệu!");
            const exportData = [];
            processedResults.forEach(item => {
                item.errors.forEach(err => {
                    exportData.push({
                        "Họ Tên": item.hoTen,
                        "Ngày Sinh": item.ngaySinh,
                        "Tuổi": item.tuoi,
                        "Ngày Vào": item.ngayVao,
                        "Lỗi": err.msg,
                        "Giá Trị Hiện Tại": err.current,
                        "Hướng Dẫn Sửa": err.fix
                    });
                });
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ChiTietLoi");
            XLSX.writeFile(wb, "KetQuaRasoat.xlsx");
        }
    </script>
</body>
</html>
