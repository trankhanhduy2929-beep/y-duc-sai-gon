<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BHYT Audit Pro - Hệ Thống Dò Lỗi Hồ Sơ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col relative selection:bg-brand-200 selection:text-brand-900">

    <!-- Background Decoration -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse"></div>
        <div class="absolute bottom-[-10%] left-[-5%] w-[500px] h-[500px] bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse" style="animation-delay: 2s"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-50/80 backdrop-blur-sm transition-all duration-700 ease-in-out">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 transform transition-all duration-500 hover:shadow-brand-500/10 animate-slide-up">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-brand-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-brand-500/30 mb-4">
                    <i class="fa-solid fa-shield-halved text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">BHYT Audit Pro</h1>
                <p class="text-slate-500 text-sm mt-1">Hệ thống kiểm soát hồ sơ y tế</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Mật khẩu truy cập</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-lock text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                        </div>
                        <input type="password" id="password-input" 
                            class="block w-full pl-10 pr-3 py-3 border border-slate-200 rounded-xl leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all duration-200 sm:text-sm" 
                            placeholder="Nhập mã PIN (1402)"
                            onkeydown="if(event.key === 'Enter') checkLogin()">
                    </div>
                    <p id="login-error" class="text-red-500 text-xs mt-2 hidden flex items-center">
                        <i class="fa-solid fa-circle-exclamation mr-1"></i> Mật khẩu không đúng
                    </p>
                </div>

                <button onclick="checkLogin()" class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-slate-900 hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 shadow-lg shadow-slate-900/20 hover:shadow-brand-600/30 transition-all duration-300 transform hover:-translate-y-0.5">
                    Đăng Nhập Hệ Thống
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <p class="text-xs text-slate-400">Phiên bản 2.2 &copy; 2026</p>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="relative z-10 flex flex-col h-full hidden opacity-0 transition-opacity duration-700">
        
        <!-- Navbar -->
        <nav class="glass sticky top-0 z-40 border-b border-slate-200/60">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center gap-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-brand-500 to-purple-600 rounded-lg flex items-center justify-center text-white text-xs">
                                <i class="fa-solid fa-stethoscope"></i>
                            </div>
                            <span class="font-bold text-lg tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600">
                                BHYT Checker
                            </span>
                        </div>
                        <div class="hidden md:ml-6 md:flex md:space-x-8">
                            <a href="#" class="border-brand-500 text-slate-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button onclick="logout()" class="ml-4 px-4 py-1.5 rounded-full text-sm font-medium text-slate-600 hover:text-red-600 hover:bg-red-50 transition-colors">
                            <i class="fa-solid fa-power-off mr-2"></i>Thoát
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-8">
            <div class="max-w-7xl mx-auto space-y-8">
                
                <!-- Status & Info Card -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                    <div class="md:col-span-2 bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-xl shadow-slate-900/10 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-16 -mt-16 transition-transform duration-700 group-hover:scale-110"></div>
                        <h2 class="text-xl font-bold mb-2 relative z-10">Quy tắc kiểm tra</h2>
                        <ul class="space-y-2 text-slate-300 text-sm relative z-10">
                            <li class="flex items-start"><i class="fa-solid fa-check-circle text-brand-400 mt-1 mr-2"></i> <span>Tối đa 12 mã ICD trong cột CHAN_DOAN_RV.</span></li>
                            <li class="flex items-start"><i class="fa-solid fa-check-circle text-brand-400 mt-1 mr-2"></i> <span>Logic chéo: Acid Uric (Bảng 3) thì Bảng 1 và 3 đều phải có ít nhất một trong 3 mã: <strong>M25.5, M10.0, M10.5</strong>.</span></li>
                            <li class="flex items-start"><i class="fa-solid fa-check-circle text-brand-400 mt-1 mr-2"></i> <span>Cảnh báo tương tác: Nhóm sỏi thận (N20) & Nhóm thiếu chất (E58).</span></li>
                        </ul>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-3 text-xl">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>
                        <h3 class="font-bold text-slate-800">Hỗ trợ File</h3>
                        <p class="text-xs text-slate-500 mt-1">Excel (.xlsx, .xls) & CSV</p>
                        <p class="text-xs text-slate-400 mt-4">Kéo thả file để tải lên nhanh chóng</p>
                    </div>
                </div>

                <!-- Upload Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Bảng 1 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                        <div class="p-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-semibold text-slate-700 flex items-center">
                                <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span> Bảng 1 (Thông tin)
                            </h3>
                            <span id="status-1" class="text-xs font-medium text-slate-400 px-2 py-1 rounded bg-slate-100">Chờ file</span>
                        </div>
                        <div id="drop-zone-1" class="p-8 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 m-4 rounded-xl cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all duration-200 group h-48">
                            <div id="icon-1" class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                            </div>
                            <p class="text-sm font-medium text-slate-600 group-hover:text-blue-600">Chọn hoặc kéo thả file Bảng 1</p>
                            <p class="text-xs text-slate-400 mt-1">Hỗ trợ .xlsx, .xls, .csv</p>
                            <input type="file" id="file-1" class="hidden" accept=".csv, .xlsx, .xls">
                        </div>
                    </div>

                    <!-- Bảng 3 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                        <div class="p-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-semibold text-slate-700 flex items-center">
                                <span class="w-2 h-2 rounded-full bg-purple-500 mr-2"></span> Bảng 3 (Dịch vụ)
                            </h3>
                            <span id="status-3" class="text-xs font-medium text-slate-400 px-2 py-1 rounded bg-slate-100">Chờ file</span>
                        </div>
                        <div id="drop-zone-3" class="p-8 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 m-4 rounded-xl cursor-pointer hover:border-purple-400 hover:bg-purple-50/30 transition-all duration-200 group h-48">
                            <div id="icon-3" class="w-12 h-12 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                            </div>
                            <p class="text-sm font-medium text-slate-600 group-hover:text-purple-600">Chọn hoặc kéo thả file Bảng 3</p>
                            <p class="text-xs text-slate-400 mt-1">Hỗ trợ .xlsx, .xls, .csv</p>
                            <input type="file" id="file-3" class="hidden" accept=".csv, .xlsx, .xls">
                        </div>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="flex justify-center py-4">
                    <button id="btn-process" class="group relative inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-white transition-all duration-200 bg-gradient-to-r from-brand-600 to-purple-600 rounded-full shadow-lg hover:shadow-xl hover:shadow-brand-500/30 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 disabled:opacity-50 disabled:cursor-not-allowed transform hover:-translate-y-1 w-64" disabled>
                        <span class="absolute inset-0 w-full h-full -mt-1 rounded-lg opacity-30 bg-gradient-to-b from-transparent via-transparent to-black"></span>
                        <span class="relative flex items-center">
                            <i class="fa-solid fa-bolt mr-2"></i> Bắt đầu dò lỗi
                        </span>
                        <div id="loading-spinner" class="loader ml-3 hidden relative z-10"></div>
                    </button>
                </div>

                <!-- Results Area -->
                <div id="result-section" class="hidden animate-slide-up">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Kết quả phân tích</h2>
                            <p class="text-slate-500 text-sm">Tìm thấy <span id="error-count" class="font-bold text-red-500">0</span> vấn đề cần xử lý</p>
                        </div>
                        <button onclick="exportToCSV()" class="inline-flex items-center px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium text-sm transition-colors shadow-sm">
                            <i class="fa-solid fa-file-excel text-green-600 mr-2"></i> Xuất Excel
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-100">
                                <thead class="bg-slate-50/50">
                                    <tr>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">STT</th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Mã Liên Kết</th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Họ Tên</th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Loại Lỗi</th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Chi Tiết</th>
                                    </tr>
                                </thead>
                                <tbody id="result-table-body" class="bg-white divide-y divide-slate-100">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="no-error-msg" class="hidden p-12 text-center">
                            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl animate-bounce-slow">
                                <i class="fa-solid fa-trophy"></i>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800">Tuyệt vời!</h3>
                            <p class="text-slate-500">Không tìm thấy lỗi nào trong dữ liệu được cung cấp.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- NOTIFICATION TOAST (Hidden by default) -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
            <i class="fa-solid fa-circle-check text-green-400 mr-3"></i>
            <span id="toast-msg">Thông báo</span>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        const PASSWORD = "1402";
        let dataTable1 = [];
        let dataTable3 = [];
        let isFile1Loaded = false;
        let isFile3Loaded = false;
        let finalErrors = [];

        // --- LOGIN LOGIC ---
        function checkLogin() {
            const input = document.getElementById('password-input');
            const errorMsg = document.getElementById('login-error');
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');

            if (input.value === PASSWORD) {
                errorMsg.classList.add('hidden');
                
                // Animation transition
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    // Trigger reflow
                    void appScreen.offsetWidth; 
                    appScreen.style.opacity = '1';
                }, 500);
            } else {
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                // Shake effect
                input.parentElement.classList.add('animate-pulse');
                setTimeout(() => {
                    input.parentElement.classList.remove('animate-pulse');
                }, 500);
            }
        }

        function logout() {
            location.reload();
        }

        // --- FILE HANDLING ---
        const setupDragDrop = (dropZoneId, fileInputId, statusId, iconId, tableType) => {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            // Drag effects
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.add('drag-active');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drag-active');
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if(files.length) handleFile(files[0], tableType, statusId, iconId);
            });

            fileInput.addEventListener('change', (e) => {
                if(e.target.files.length) handleFile(e.target.files[0], tableType, statusId, iconId);
            });
        };

        const handleFile = (file, tableType, statusId, iconId) => {
            const statusEl = document.getElementById(statusId);
            const iconEl = document.getElementById(iconId);
            
            // UI Update: Loading
            statusEl.textContent = "Đang đọc...";
            statusEl.className = "text-xs font-medium text-blue-600 px-2 py-1 rounded bg-blue-50 animate-pulse";

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                    
                    // Normalize Headers
                    const normalizedData = jsonData.map(row => {
                        const newRow = {};
                        Object.keys(row).forEach(key => {
                            newRow[key.trim().toUpperCase()] = row[key];
                        });
                        return newRow;
                    });

                    // Store Data
                    if (tableType === 1) {
                        dataTable1 = normalizedData;
                        isFile1Loaded = true;
                    } else {
                        dataTable3 = normalizedData;
                        isFile3Loaded = true;
                    }

                    // UI Update: Success
                    statusEl.textContent = "Đã tải xong";
                    statusEl.className = "text-xs font-medium text-green-700 px-2 py-1 rounded bg-green-100";
                    
                    iconEl.innerHTML = '<i class="fa-solid fa-check text-xl"></i>';
                    iconEl.className = "w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-3 transition-transform transform scale-110";

                    showToast(`Đã tải thành công: ${file.name}`);
                    checkReady();
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = "Lỗi file";
                    statusEl.className = "text-xs font-medium text-red-700 px-2 py-1 rounded bg-red-100";
                    showToast("Lỗi định dạng file! Vui lòng kiểm tra lại.", true);
                }
            };

            reader.readAsBinaryString(file);
        };

        const checkReady = () => {
            const btn = document.getElementById('btn-process');
            if (isFile1Loaded && isFile3Loaded) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('animate-bounce-slow'); // Add attention grabber
                setTimeout(() => btn.classList.remove('animate-bounce-slow'), 3000);
            }
        };

        setupDragDrop('drop-zone-1', 'file-1', 'status-1', 'icon-1', 1);
        setupDragDrop('drop-zone-3', 'file-3', 'status-3', 'icon-3', 3);

        // --- PROCESSING LOGIC ---
        document.getElementById('btn-process').addEventListener('click', () => {
            const btn = document.getElementById('btn-process');
            const spinner = document.getElementById('loading-spinner');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');
            
            setTimeout(() => {
                processFiles();
                btn.disabled = false;
                spinner.classList.add('hidden');
                
                // Scroll to results
                document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
            }, 300);
        });

        // ---------------------------------------------------------
        // CẬP NHẬT: Xử lý mã ICD trong chuỗi hỗn độn (VD: (M25.5) Đau khớp)
        // ---------------------------------------------------------
        function parseICD(icdString) {
            if (!icdString) return [];
            // Bước 1: Tách chuỗi bằng dấu ; hoặc ,
            return icdString.split(/[;,]/).map(s => {
                s = s.trim().toUpperCase();
                
                // Bước 2: Dùng Regex để "đào" lấy mã ICD chuẩn
                // Mẫu: Chữ cái in hoa [A-Z] + 2 số \d{2} + (tùy chọn: dấu chấm và số đằng sau)
                // Ví dụ khớp: "M25", "M25.5", "(M25.5)", "M25.59"
                // Không khớp: "Đau khớp", "Sốt"
                const match = s.match(/[A-Z]\d{2}(\.\d+)?/); 
                
                // Nếu tìm thấy mã (match) thì lấy mã đó, nếu không thì giữ nguyên chuỗi gốc
                // để tính vào số lượng mã (cho Quy tắc 1)
                return match ? match[0] : s; 
            }).filter(s => s !== "" && s.length >= 3); // Lọc bỏ rác quá ngắn
        }

        function processFiles() {
            finalErrors = [];
            
            // 1. Indexing Table 1
            const mapTable1 = new Map();
            dataTable1.forEach(row => {
                if (row.MA_LK) {
                    mapTable1.set(String(row.MA_LK), {
                        HO_TEN: row.HO_TEN || "Không tên",
                        CHAN_DOAN_RV: row.CHAN_DOAN_RV || "",
                        ICD_CODES: parseICD(row.CHAN_DOAN_RV)
                    });
                }
            });

            // 2. Logic Check Table 1 (Count & Interactions)
            mapTable1.forEach((val, key) => {
                const { HO_TEN, ICD_CODES } = val;
                
                // Rule 1: Max 12 ICD
                if (ICD_CODES.length > 12) {
                    finalErrors.push({
                        MA_LK: key, HO_TEN: HO_TEN,
                        LOAI_LOI: "Dư mã ICD",
                        CHI_TIET: `Có ${ICD_CODES.length} mã (Giới hạn: 12).`
                    });
                }

                // Rule 3: Drug Interaction
                const hasGroupA = ICD_CODES.some(c => c === 'N20' || c === 'N20.0');
                const hasGroupB = ICD_CODES.some(c => c === 'E58' || c === 'D53.2');
                
                if (hasGroupA && hasGroupB) {
                    finalErrors.push({
                        MA_LK: key, HO_TEN: HO_TEN,
                        LOAI_LOI: "Tương tác thuốc",
                        CHI_TIET: `Xung đột: Sỏi thận (N20/N20.0) và Thiếu chất (E58/D53.2).`
                    });
                }
            });

            // 3. Logic Check Table 3 (Acid Uric)
            const requiredCodes = ['M25.5', 'M10.0', 'M10.5'];

            dataTable3.forEach(row => {
                const maLK = String(row.MA_LK);
                const tenDichVu = (row.TEN_DICH_VU || "").toLowerCase();
                const maBenhTable3 = parseICD(row.MA_BENH);

                if (tenDichVu.includes("acid uric") || tenDichVu.includes("định lượng acid uric")) {
                    const infoTable1 = mapTable1.get(maLK);
                    
                    if (infoTable1) {
                        const icdTable1 = infoTable1.ICD_CODES;
                        
                        // Check if ANY of the required codes exist in Table 3
                        const checkT3 = maBenhTable3.some(c => requiredCodes.includes(c));
                        
                        // Check if ANY of the required codes exist in Table 1
                        const checkT1 = icdTable1.some(c => requiredCodes.includes(c));

                        let details = [];
                        if (!checkT3) details.push("B3 thiếu (M25.5/M10.0/M10.5)");
                        if (!checkT1) details.push("B1 thiếu (M25.5/M10.0/M10.5)");

                        if (details.length > 0) {
                            finalErrors.push({
                                MA_LK: maLK, HO_TEN: infoTable1.HO_TEN,
                                LOAI_LOI: "Sai chỉ định Acid Uric",
                                CHI_TIET: details.join(". ") + ". Yêu cầu có ít nhất 1 trong 3 mã này."
                            });
                        }
                    } else {
                        finalErrors.push({
                            MA_LK: maLK, HO_TEN: "N/A (Lệch dữ liệu)",
                            LOAI_LOI: "Lỗi dữ liệu",
                            CHI_TIET: "Có dịch vụ B3 nhưng không có thông tin B1."
                        });
                    }
                }
            });

            renderResults();
        }

        function renderResults() {
            const tableBody = document.getElementById('result-table-body');
            const resultSection = document.getElementById('result-section');
            const errorCountLabel = document.getElementById('error-count');
            const noErrorMsg = document.getElementById('no-error-msg');
            const tableContainer = document.querySelector('table');
            
            tableBody.innerHTML = '';
            resultSection.classList.remove('hidden');
            
            // Unique Filter
            const uniqueErrors = finalErrors.filter((value, index, self) =>
                index === self.findIndex((t) => (
                    t.MA_LK === value.MA_LK && t.LOAI_LOI === value.LOAI_LOI && t.CHI_TIET === value.CHI_TIET
                ))
            );

            errorCountLabel.textContent = uniqueErrors.length;

            if (uniqueErrors.length === 0) {
                noErrorMsg.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                noErrorMsg.classList.add('hidden');
                tableContainer.classList.remove('hidden');

                uniqueErrors.forEach((err, index) => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50 transition-colors";
                    
                    let badgeClass = "bg-slate-100 text-slate-800";
                    if (err.LOAI_LOI.includes("Dư mã")) badgeClass = "bg-yellow-100 text-yellow-800 border border-yellow-200";
                    if (err.LOAI_LOI.includes("Acid Uric")) badgeClass = "bg-red-100 text-red-800 border border-red-200";
                    if (err.LOAI_LOI.includes("Tương tác")) badgeClass = "bg-orange-100 text-orange-800 border border-orange-200";

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 font-mono">${err.MA_LK}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-semibold">${err.HO_TEN}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeClass}">
                                ${err.LOAI_LOI}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">${err.CHI_TIET}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        function exportToCSV() {
            if (finalErrors.length === 0) {
                showToast("Không có dữ liệu lỗi để xuất!", true);
                return;
            }
            
            const uniqueErrors = finalErrors.filter((value, index, self) =>
                index === self.findIndex((t) => (
                    t.MA_LK === value.MA_LK && t.LOAI_LOI === value.LOAI_LOI && t.CHI_TIET === value.CHI_TIET
                ))
            );

            const worksheet = XLSX.utils.json_to_sheet(uniqueErrors);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "DS_Loi");
            XLSX.writeFile(workbook, "Danh_Sach_Loi_BHYT.xlsx");
            showToast("Đã tải xuống file Excel!");
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            const icon = toast.querySelector('i');
            
            toastMsg.textContent = msg;
            toast.className = `fixed bottom-5 right-5 transform translate-y-0 opacity-100 transition-all duration-300 z-50 flex items-center px-6 py-3 rounded-lg shadow-xl ${isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`;
            icon.className = isError ? 'fa-solid fa-triangle-exclamation mr-3' : 'fa-solid fa-circle-check mr-3 text-green-400';
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
